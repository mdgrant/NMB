---
title: "Monitoring and Patient Outcomes"
date: "`r format(Sys.time(), '%d %B, %Y (%H:%M)')`"
output:
  html_document:
    font: Source Sans Pro
    theme: cosmo
    anchor_sections: TRUE
    toc_float: 
      collapsed: FALSE
      smooth_scroll: TRUE
    toc_depth: 3
    linkcolor: blue
  latex_engine: xelatex
  pdf_document:
    toc: yes
    toc_depth: '3'
bibliography: "bib/kq3.bib"
csl: jama.csl
link-citations: yes
workflowr:
  suppress_report: false
nocite: '@*'
---

```{=html} 
<style type="text/css">
  body{
  font-size: 9.5pt;
  font-family: Source Sans Pro;
}

.caption {
  font-size: 15px;
}

.list-group-item.active, .list-group-item.active:hover, .list-group-item.active:focus {
  color: #090909;
  background-color: #0909093d;
}

.lightable-classic.lightable-hover tbody tr:hover {
    background-color: #c5d4e4;
}
.btn-xs, .btn-group-xs>.btn { 
display: none; 
}

.btn-default {
display: none !important; 
}

.popover-title {
      font-size: 12px;
  }

.popover-content {
      font-size: 12px;
  }
  
.popover-content {
    background-color: white;
    <!-- color: #FFFFFF; -->
    padding: 2px;
  }

<!-- .arrow { -->
<!--   border-right-color: red !important; -->
<!-- } -->

:target {  /* fix target location so caption appears */
    display: block;
    position: relative;
    top: -25px;
    visibility: hidden;
}

</style>

<script>
$(document).ready(function(){
    $('[data-toggle="popover"]').popover({html: true, placement: top});
});
</script>
```

```{r setup, include = FALSE} 
## setup ---------------------------------------------- (2022-04-05 07:31) @----
knitr::opts_chunk$set(echo = FALSE, include = TRUE)
source("code/readfiles_nmb_102721.R")
```

```{r data, include = FALSE, eval = TRUE}
## data ----------------------------------------------- (2022-04-05 07:31) @----
ptout_refids <- study_char.dat %>% 
  filter(!is.na(diag_pt_out)) %>% 
  filter(!refid %in%  c(3209, 3644)) %>% # exclude Thilen 2018, Renew 2021 (fully paired)
  pull(refid) %>% 
  unique()

temp <- study_arm.dat %>% 
  filter(refid == 3574) %>% 
  mutate(arm_id = 2)

study_arm.dat <- bind_rows(study_arm.dat, temp) %>%
  mutate(
    arm_diag_outcome = ifelse(refid == 3574 & arm_id == 2, "amg_uni", arm_diag_outcome),
    arm_diag_outcome = ifelse(refid == 3574 & arm_id == 1, "clinical", arm_diag_outcome),
    mon_cat = ifelse(refid == 3574 & arm_id == 2, "quant", mon_cat),
    mon_cat = ifelse(refid == 3574 & arm_id == 1, "clin", mon_cat)
  )

# study_l, design and monitor type
study_arm_ptout.dat <- study_arm.dat %>%
  filter(refid %in% ptout_refids) %>% 
  mutate(
    design = fct_drop(design),
    design_f = fct_recode(design,
      RCT = "rct",
      "Before-After/Time Series" = "quasiexp",
      "Prospective Cohort" = "prospect_coh",
      "Retrospective Cohort" = "retrospect_coh"
    ),
    arm_diag_outcome = factor(arm_diag_outcome,
      levels = c("no_monitor", "clinical", "pns_clin", "pns", "amg_uni", "amg_ns", "emg", "quant_all"),
      labels = c("Clinical", "Clinical", "PNS/Clinical", "PNS", "AMG", "AMG", "EMG", "Quantitative")
    )
  ) %>%
  relocate(design_f, .after = design) 

# nb to change later in tables
# arm_diag_outcome = ifelse(study == "Ueda 1991" & arm_id == 1, "Manual TOF/DBS", arm_diag_outcome),
# arm_diag_outcome = ifelse(study == "Ueda 1991" & arm_id == 2, "Manual TOF", arm_diag_outcome))

dichot_ptout.dat <- dichot.dat %>%
  filter(refid %in% ptout_refids) %>%
  mutate(
    design = fct_drop(design),
    design_f = fct_recode(design,
      RCT = "rct",
      "Before-After/Time Series" = "quasiexp",
      "Prospective Cohort" = "prospect_coh",
      "Retrospective Cohort" = "retrospect_coh"
    )) %>% 
  relocate(design_f, .after = design)

temp <- dichot_ptout.dat %>% 
  filter(refid == 3574) %>% 
  mutate(arm_id = 2)

dichot_ptout.dat <- bind_rows(dichot_ptout.dat, temp) %>% 
  mutate(
    rnmb1_n = ifelse(refid == 3574 & arm_id == 2, 2, rnmb1_n),
    rnmb1_n = ifelse(refid == 3574 & arm_id == 1, 14, rnmb1_n),
    rnmb1_per = ifelse(refid == 3574 & arm_id == 2, 22.2, rnmb1_per),
    rnmb1_per = ifelse(refid == 3574 & arm_id == 1, 66.7, rnmb1_per),
    arm_n = ifelse(refid == 3574 & arm_id == 2, 9, arm_n),
    arm_n = ifelse(refid == 3574 & arm_id == 1, 21, arm_n)
  )

rm(temp)
```

# **Included Studies** 

<br/>

<font size = 4> Table `r table_n`. Number of included studies according to age and design. </font>

```{r tablesIncluded, include = TRUE, echo = FALSE} 
## tablesIncluded ------------------------------------- (2022-04-05 07:35) @----
# list of studies, age, surgical/non surgical, design 
study_char.dat %>% 
  filter(refid %in% ptout_refids) %>% 
  group_by(age, design, .groups = "drop") %>%
  summarise(total = n()) %>%
  ungroup() %>%
  arrange(age, design) %>%
  group_by(age, .groups = "drop") %>%
  mutate(row = row_number()) %>%
  ungroup() %>%
  janitor::adorn_totals("row") %>%
  mutate(
    age = ifelse(row != 1, NA, age),
    design = case_when(
      design == "rct" ~ "RCT",
      design == "crossover" ~ "Crossover",
      design == "quasiexp" ~ "Before-After",
      design == "cluster" ~ "Cluster",
      design == "nrsi" ~ "Nonrandomized Trial",
      design == "prospect_coh" ~ "Prospective Cohort",
      design == "retrospect_coh" ~ "Retrospective Cohort",
      design == "casecontrol" ~ "Case-Control",
      design == "other" ~ "Before-After",
      design == "fully_paired" ~ "Fully Paired"),
      age = ifelse(row_number() == n(), "Total", age)
  ) %>%
  select(age, design, total) %>%
  kbl(
    booktabs = T, align = c("llr"),
    col.names = c("Age", "Design", "N")
  ) %>%
  row_spec(c(0, 5), bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "8em") %>%
  column_spec(2, width = "14em") %>%
  column_spec(3, width = "3em") %>% 
  footnote(
    general = "RCT: randomized controlled trial.",
    # alphabet = c("Footnote a", "Footnote b", ...),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

## *Design, centers, country, surgery*

<br/>

```{r studiesTables, echo = FALSE, include = TRUE}
## included_studies.dat ------------------------------- (2022-04-05 07:36) @----
included_studies.dat <- study_char.dat %>%
  filter(refid %in% ptout_refids) %>%
  mutate(
    design = fct_drop(design),
    design_l = fct_recode(design, RCT = "rct", "Quasi-Experimental" = "quasiexp", "Prospective Cohort" = "prospect_coh", "Retrospective Cohort" = "retrospect_coh"),
    across(surg_various:surg_other, ~ str_replace(.x, "surg_", "")),
    across(surg_various:surg_other, ~ str_c(.x, ", ")),
    across(surg_various:surg_other, ~ firstup(.x)),
    across(surg_various:surg_other, ~ replace_na(.x, "")),
    surg_list = ifelse(grepl("abdom", surg_list), "Abdominal, ", ""),
    surgs = str_c(surg_various, surg_car, surg_cr, surg_gyn, surg_gi, surg_gen, surg_headneck, surg_hep, surg_neuro, surg_opth, surg_oralmax, surg_ortho, surg_otolar, surg_plastic, surg_thor, surg_urol, surg_list),
    surgs = str_replace(surgs, "Otolar", "ENT"),
    surgs = str_replace(surgs, "Headneck", "ENT"),
    surgs = str_replace(surgs, "Gi", "GI"),
    surgs = str_sub(surgs, 1, nchar(surgs) - 2),
    country = ifelse(grepl("USA", country), "USA", country),
    country = ifelse(grepl("UK", country), "UK", country),
    country = ifelse(!is.na(non_vh_hdi), str_c(country, "^a^"), country),
  ) %>%
  select(refid, study_l, year, age, design, design_l, n_analyze, country, centers, non_vh_hdi, surgs) %>%
  arrange(age, design_l, year) 

## study_arm_incl.dat --------------------------------- (2022-04-05 07:36) @----
# comparators; nb prior to adding study_arm factoring initial
study_arm_incl.dat <- study_arm.dat %>%
  filter(refid %in% ptout_refids) %>%
  remove_empty(which = "cols") %>%
  select(refid, study, study_l, design, year, arm_diag_outcome) %>%
  group_by(study) %>%
  distinct() %>%
  arrange(design, study, arm_diag_outcome) %>%
  mutate(comp_mon = lead(arm_diag_outcome)) %>%
  slice(1) %>%
  ungroup() %>%
  arrange(design, year, arm_diag_outcome, comp_mon) %>%
  relocate(comp_mon, .after = arm_diag_outcome) %>% 
  # reverse clinical to comparator
  mutate(
    design = fct_drop(design),
    design_f = fct_recode(design, RCT = "rct", "Quasi-Experimental" = "quasiexp", "Prospective Cohort" = "prospect_coh", "Retrospective Cohort" = "retrospect_coh"),
    temp = arm_diag_outcome,
    arm_diag_outcome = ifelse(arm_diag_outcome == "clinical", comp_mon, arm_diag_outcome),
    comp_mon = ifelse(arm_diag_outcome == comp_mon, temp, comp_mon),
    arm_diag_outcome = factor(arm_diag_outcome, 
         levels = c("amg_ns", "amg_uni", "clinical", "emg", "pns_clin", "pns"), 
         labels = c("AMG", "AMG", "Clinical", "EMG", "PNS/Clinical", "PNS")),
         comp_mon = factor(comp_mon, 
         levels = c("clinical", "no_monitor", "pns", "pns_clin", "quant_all"),
         labels = c("Clinical", "No Monitor", "PNS", "PNS/Clinical", "Quantitative"))
         ) %>% 
  select(-temp)

# identify dichot outcome
temp <- dichot.dat %>% 
  filter(refid %in% ptout_refids) %>%
  select(refid, study, pulm, reintub, hypox, nausea, vomit, ponv, rnmb1_clinical, starts_with("rnmb")) %>% 
  remove_empty(which = "cols") %>% 
  group_by(refid) %>% 
    slice(1) %>% 
  ungroup() %>% 
  mutate(
    tofr_outcome = case_when(
      !is.na(rnmb1_9) ~ "<0.9",
      !is.na(rnmb2_9) ~ "<0.9",
      !is.na(rnmb1_8) ~ "<0.8",
      !is.na(rnmb1_7) ~ "<0.7",
    ),
    across(.cols = c(pulm, reintub, hypox, nausea, vomit, ponv, rnmb1_clinical), ~ ifelse(!is.na(.x), "\U000D7", NA)),
  ) %>% 
  rename(clinical = rnmb1_clinical) %>% 
  relocate(c(tofr_outcome), .after = rnmb) %>% 
  select(refid, tofr_outcome, clinical, pulm, reintub, hypox, nausea, vomit, ponv) 

# data for kable study_arm_incl.dat
study_arm_incl.dat <- right_join(study_arm_incl.dat, temp, by = "refid") %>% 
  relocate(design_f, .after = design) %>% 
  select(-design, -study)

rm(temp)
```

<font size = 4> Table `r table_n`. Studies, design, size, centers, country, and surgery (see [References](#references) for citations). </font>

```{r studiesTablesKable, echo = FALSE, include = TRUE}
## studiesTablesKable --------------------------------- (2022-04-05 07:37) @----
temp <- included_studies.dat %>%
  arrange(age, design_l, study_l) %>% 
  select(study_l, refid, age, design_l) %>% 
  group_by(age, design_l) %>% 
  tally() %>% 
  ungroup() %>% 
  mutate(end = cumsum(n),
         start = end - n + 1) %>% 
  select(age, design_l, start, end)

included_studies.dat %>% 
  select(refid, study_l, n_analyze, centers, country, surgs) %>% 
  kbl(
    booktabs = T, align = c("llccll"), escape = TRUE, # format = "latex",
    col.names = c("            ID", "Study", "Analyzed (N)", "Centers", "Country^a^", "Surgery")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "6em") %>%
  column_spec(2, width = study_width) %>%
  column_spec(3, width = "6em") %>%
  column_spec(4, width = "6em") %>%
  column_spec(5, width = "10em") %>%
  column_spec(6, width = "25em") %>%
  # pack_top(., "Adult", 1, 14) %>%
  pack_top(., "RCT", 1, 10) %>% 
  pack_top(., "Before-After", 11, 12) %>% 
  pack_top(., "Prospective Cohort", 13, 15) %>% 
  pack_top(., "Retrospective Cohort", 16, 16) %>% 
  footnote(
    general = "RCT: randomized controlled trial.",
    alphabet = c(
      "Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."),
    general_title = "",
    footnote_as_chunk = FALSE
  )

rm(temp)
table_n <- tab_inc()
```

<br/>

## *Anesthesia and reversal* 

<br/>

<font size = 4> Table `r table_n`. Anesthetics and reversal in included studies.</font>

```{r }
## studiesDescribeKable ------------------------------- (2022-04-05 07:38) @----
## study_arm_ptout.dat -------------------------------- (2022-03-31 11:23) @----
study_arm_ptout.dat %>% 
  mutate(
    volatile = if_any(c(an_isoflurane, an_sevoflurane, an_desf, an_hal), ~ !is.na(.)),
    volatile = ifelse(volatile == TRUE, "\U000D7", NA)
    ) %>% 
  select(refid, design, year, study, study_l, arm_id, volatile, nmbagent, nmbadm_intub, nmbadm_maint, nmb_dose, nmb_dose_up, revagent, starts_with("neo"), starts_with("sug")) %>% 
  mutate(
    # anesth = ifelse(gen_type == "tiva_inhal", "TIVA/Inhaled", NA),
    across(.cols = c(nmbadm_intub, nmbadm_maint), ~ ifelse(!is.na(.x), "\U000D7", NA)),
    nmba_mean = ifelse(!is.na(nmb_dose) & is.na(nmb_dose_up), nmb_dose, NA),
    nmba_range = ifelse(!is.na(nmb_dose + nmb_dose_up), paste0("(", nmb_dose, "-", nmb_dose_up, ")"), NA),
    neo_agent = ifelse(str_detect(revagent, "neo|various"), "\U000D7", NA),
    sug_agent = ifelse(str_detect(revagent, "various"), "\U000D7", NA),
    neo_dose = ifelse(!is.na(neo_dose), round_2(neo_dose), NA),
    neo_dose_c = ifelse(neo_dose > 0.20, paste0("<u>", neo_dose, "</u>"), as.character(neo_dose)), 
    sug_dose = ifelse(!is.na(sug_dose), round_2(sug_dose), NA),
    nmbagent_c = case_when(
      study == "Pedersen 1990" ~ "Pan/Vec",
      nmbagent == "pancuronium" ~ "Pan",
      nmbagent == "vecuronium" ~ "Vec",
      nmbagent == "rocuronium" ~ "Roc",
      nmbagent == "cistracurium" ~ "Cis",
      nmbagent == "various" ~ "Various")
  ) %>% 
  group_by(study) %>% 
  slice(1) %>% 
  ungroup() %>% 
  arrange(design, year) %>% 
  select(refid, design, year, study, study_l, volatile, nmbagent_c, nmbadm_intub, nmbadm_maint, nmba_mean, nmba_range, neo_agent, neo_dose_c, sug_agent, sug_dose) %>% 
  select(study_l, volatile:sug_dose) %>% 
  kbl(booktabs = T, align = c("lclccclcccc"), escape = FALSE, # format = "latex",
    col.names = c("Study", "Anesthetic", " ", "Intub", "Maint", "Mean", "Range", "Neo", "mg/kg <u>mg</u>", "Sug", "mg/kg")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  add_header_above(c(" " = 1, "Volatile" = 1, "Agent & When Administered" = 3, "Dose mg/kg" = 2, "Reversal Agent and Dose" = 4), line = TRUE, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "8em") %>%
  column_spec(3, width = "5em") %>%
  column_spec(c(4,6), width = "4em") %>%
  column_spec(7, width = "6em") %>%
  column_spec(9, width = "7em") %>%
  column_spec(c(8,10,11), width = "5em") %>%
  # column_spec(6, width = "12em") %>%
  # pack_top(., "Adult", 1, 14) %>%
  pack_top(., "RCT", 1, 10) %>% 
  pack_top(., "Before-After", 11, 12) %>% 
  pack_top(., "Prospective Cohort", 13, 15) %>% 
  pack_top(., "Retrospective Cohort", 16, 16) %>% 
  footnote(
    general = "RCT: randomized controlled trial; Panc: pancuronium; Vecu: vecuronium; Roc: rocuronium, Cis: cisatracurium; TIVA: total intravenous anesthesia; Intub: intubation; Maint: maintenance; Neo: neostigmine; Sug: sugammadex.",
    # alphabet = c(" "),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

```{r study_arm_inclKable, include = FALSE, eval = FALSE, echo = FALSE}
## study_arm_incl.dat --------------------------------- (2022-04-05 07:41) @----
temp <- study_arm_incl.dat %>%
  arrange(design_f, study_l) %>% 
  select(study_l, refid, design_f) %>% 
  group_by(design_f) %>% 
  tally() %>% 
  ungroup() %>% 
  mutate(end = cumsum(n),
         start = end - n + 1) %>% 
  select(design_f, start, end)

study_arm_incl.dat %>% 
  select(study_l, arm_diag_outcome, comp_mon, tofr_outcome, clinical:hypox) %>% 
  kbl(
    booktabs = T, align = c("lllccccc"), escape = TRUE, # format = "latex",
    col.names = c("Study", "Intervention", "Comparator", "TOFR", "Weakness", "Pulmonary", "Reintubation", "Hypoxia")) %>% 
  add_header_above(c(" " = 4, "Clinical" = 1, " " = 3), line = FALSE, bold = TRUE, align = "c") %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "8em") %>%
  column_spec(3, width = "8em") %>%
  column_spec(c(4:8), width = "7em") %>%
  # column_spec(5, width = "10em") %>%
  # pack_top(., "Adult", 1, 14) %>%
  pack_top(., "RCT", 1, 10) %>% 
  pack_top(., "Before-After", 11, 12) %>% 
  pack_top(., "Prospective Cohort", 13, 15) %>% 
  pack_top(., "Retrospective Cohort", 16, 16) %>% 
  footnote(
    general = c("RCT: randomized controlled trial TOFR: train of four ratio; PNS: peripheral nerve stimulator; AMG: acceleromyography; EMG: electromyography."),
    # alphabet = c(),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

# **Outcomes**

<br/>

## *Residual Neuromuscular Blockade (TOFR <0.9)*

### Incidence Proportion

```{r dichot_ptout.dat, include = FALSE}
## dichot_ptout.dat ----------------------------------- (2022-04-05 07:42) @----
temp1 <- dichot_ptout.dat %>% 
  filter(refid %in% ptout_refids) %>% 
  filter(refid != 7426) |> 
  filter(if_any(c(rnmb1_7, rnmb1_8, rnmb1_9, rnmb2_9),  ~ !is.na(.))) %>%
  remove_empty(which = "cols") %>% 
  select(refid:age, arm_n, study, study_l, design_f, rnmb_location, tofr_normalized, starts_with("rnmb")) %>%
  # murphy use only 0.9
  mutate(rnmb1_n = ifelse(str_detect(study, "Murphy"), rnmb2_n, rnmb1_n),
         rnmb1_per = ifelse(str_detect(study, "Murphy"), rnmb2_per, rnmb1_per),
         rnmb1_pval = ifelse(str_detect(study, "Murphy"), rnmb2_pval, rnmb1_pval),
         rnmb1_9 = ifelse(str_detect(study, "Murphy"), rnmb2_9, rnmb1_9),
         rnmb1_7 = ifelse(str_detect(study, "Murphy"), NA, rnmb1_7))

temp2 <- study_arm_ptout.dat %>%
  select(refid, arm_id, arm_diag_outcome)

dichot_ptout_tofr.dat <- left_join(temp1, temp2, by = c("refid", "arm_id")) %>% 
  mutate(
    tofr_outcome = case_when(
      !is.na(rnmb1_9) ~ "<0.9",
      !is.na(rnmb1_8) ~ "<0.8",
      !is.na(rnmb1_7) ~ "<0.7",
    )) %>% 
  group_by(refid) %>% 
    mutate(arm = row_number()) %>% 
    arrange(desc(rnmb1_per), .by_group = TRUE) %>% 
  ungroup() %>% 
  select(refid, study, study_l, year, arm, arm_n, design_f, rnmb_location, tofr_normalized, arm_diag_outcome, rnmb1_n, rnmb1_per, rnmb1_pval, tofr_outcome) %>% 
  relocate(arm_diag_outcome, .after = study) %>% 
  relocate(arm, .after = refid) %>% 
  arrange(design_f, tofr_outcome, year, study) 

rm(temp1, temp2)

tofr_meta.dat <- dichot_ptout_tofr.dat %>%
  group_by(refid) %>% 
    mutate(arm_temp = row_number()) %>% 
  ungroup() %>% 
  pivot_wider(
    id_cols = c("refid", "study"),
    names_from = "arm_temp",
    values_from = c("arm_n", "rnmb1_n"),
  ) %>% 
  mutate(rr_ci = risk_ratio_y(rnmb1_n_2, arm_n_2, rnmb1_n_1, arm_n_1))
```

<a id="kq3Tab4"></a>

<br/>

<font size = 4> Table `r table_n`. Results from studies reporting residual neuromuscular blockade for the highest TOFR threshold reported for TOFR. (Time-related outcomes—time from extubation to TOFR 0.9—reported in only 2 studies and not summarized). </font>

```{r nmmKable}
## nmmKable -------------------------------------------- (2022-04-18 10:50) @----
nmm_kable <- dichot_ptout_tofr.dat %>%
  left_join(., tofr_meta.dat[, c("refid", "rr_ci")], by = "refid") %>%
  group_by(refid) %>%
  mutate(rr_ci = ifelse(row_number() == 1, rr_ci, NA)) %>%
  ungroup() %>%
    mutate(
    rnmb_location = case_when(
      rnmb_location == "or" ~ "OR",
      rnmb_location == "post_extub" ~ "OR",
      rnmb_location == "pacu" ~ "PACU",
      rnmb_location == "recover" ~ "PACU",
    ),
    arm_diag_outcome = as.character(arm_diag_outcome),
    arm_diag_outcome = ifelse(study == "Ueda 1991" & arm == 1, "Manual TOF/DBS", arm_diag_outcome),
    arm_diag_outcome = ifelse(study == "Ueda 1991" & arm == 2, "Manual TOF", arm_diag_outcome),
    rr_ci = ifelse(study == "Ueda 1991" & arm == 3, risk_ratio_y(2, 30, 25, 30), rr_ci),
    rr_ci = ifelse(study == "Ueda 1991" & arm == 2, risk_ratio_y(2, 30, 17, 30), rr_ci),
    rnmb_np = n_percent1(rnmb1_n, rnmb1_per)
  ) %>%
  # mutate(
  #   # add footnotes OR tofr
  #   tofr_outcome = ifelse(refid %in% c(1489), paste0(tofr_outcome, "^b^"), tofr_outcome)
  # ) %>%
  group_by(study) %>%
  mutate(
    study = ifelse(row_number() == 1, study, NA),
    study_l = ifelse(row_number() == 1, study_l, NA),
    tofr_outcome = ifelse(row_number() == 1, tofr_outcome, NA),
    rnmb_location = ifelse(row_number() == 1, rnmb_location, NA)
  ) %>%
  ungroup()

dichot_format <- function(x) (x/100)

nmm_kable <- nmm_kable %>% 
  mutate(
  tofr_bar = 0, 
  tofr_bar = case_when(
    arm_diag_outcome == "Clinical" ~ bar_wn(rnmb1_per, rnmb1_per, color_4, 100),
    arm_diag_outcome %in% c("AMG (nl)", "AMG (raw)", "AMG", "EMG") ~ bar_wn(rnmb1_per, rnmb1_per, color_1, 100),
    TRUE ~ bar_wn(rnmb1_per, rnmb1_per, color_2, 100)),
    tofr_bar = str_replace(tofr_bar, ">\\d+\\.?\\d?", ",>&nbsp;")
  ) 

# document_kable <- nmm_kable %>%
#   select(study, arm_diag_outcome, arm_n, rnmb_np, tofr_bar, tofr_outcome, rnmb_location, rr_ci) %>%
# bar_ref <- "<span style='display: inline-block; direction: auto; unicode-bidi: plaintext; border-radius: 4px; padding-right: 0px; background-color: #e0e0de ; width: 100.00%'>  0%    →    100%</span>"

nmm_kable %>%
  select(study_l, arm_diag_outcome, arm_n, rnmb_np, tofr_bar, tofr_outcome, rnmb_location, rr_ci) %>%
  mutate(arm_diag_outcome = case_when(
    str_detect(arm_diag_outcome, "PNS") ~cell_spec(arm_diag_outcome, color = color_2), 
    str_detect(arm_diag_outcome, "Clinical") ~ cell_spec(arm_diag_outcome, color = color_4),
    str_detect(arm_diag_outcome, "Manual TOF") ~cell_spec(arm_diag_outcome, color = color_2), 
    str_detect(arm_diag_outcome, "AMG|EMG") ~ cell_spec(arm_diag_outcome, color = color_1)
  )) %>%
  kbl(
    booktabs = T, align = c("lllllcll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "Monitoring", "N", "N (%)", bar_ref, "TOFR", "Place^a^", "RR (95% CI)^b^")
  ) %>%
  add_header_above(c(" " = 3, "RNMB" = 5), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "8em") %>%
  column_spec(3, width = "5em") %>%
  column_spec(4, width = "5em") %>%
  column_spec(5, width = bar_width) %>%
  column_spec(6, width = "4em") %>%
  column_spec(7, width = "4em") %>%
  column_spec(8, width = or_width) %>%
  pack_topnoind(., "RCT", 1, 17) %>%
  pack_topnoind(., "Before-After", 18, 19) %>%
  pack_topnoind(., "Prospective Cohort", 20, 21) %>%
  pack_topnoind(., "Retrospective Cohort", 22, 23) %>%
  footnote(
    general = "RCT: randomized controlled trial; RNMB: residual neuromuscular blockade; RR: risk ratio; CI: confidence interval; DBS: double burst stimulation; PNS: peripheral nerve stimulator; AMG: acceleromyography; EMG: electromyography; PACU: post-anesthesia care unit; OR: operating room.",
    alphabet = c(
      "PACU if designated as PACU or recovery, OR if designated as such or as post-extubation.",
      "Risk ratio comparing the last monitoring arm (lowest incidence) to the prior. For studies reporting results for >1 threshold, only those for the highest are shown."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

```{r forSOE, echo = FALSE}
## forSOE --------------------------------------------- (2022-04-18 10:52) @----
# data
library(netmeta)
nma_nmm_temp.dat <- nmm_kable %>% 
  fill(study) %>% 
  mutate(
  arm_n = ifelse(study == "Ueda 1991" & arm == 2, 60, arm_n),
  rnmb1_n = ifelse(study == "Ueda 1991" & arm == 2, 19, rnmb1_n),
  arm_diag_outcome = ifelse(study == "Ueda 1991" & arm == 2, "Qualitative", arm_diag_outcome),
  arm_diag_outcome = ifelse(arm_diag_outcome %in% c("PNS/Clinical", "PNS"), "Qualitative", arm_diag_outcome),
  arm_diag_outcome = ifelse(arm_diag_outcome %in% c("AMG", "EMG"), "Quantitative", arm_diag_outcome)
  ) %>% 
  filter(!(study == "Ueda 1991" & arm == 1)) %>% 
  filter(design_f == "RCT") %>% 
  select(study, arm_diag_outcome, arm, rnmb1_n, arm_n)

pairs_temp.dat <- pairwise(
  treat = arm_diag_outcome,
  event = rnmb1_n,
  n = arm_n,
  studlab = study,
  data = nma_nmm_temp.dat,
  sm = "RR"
)

```

### Qualitative vs. Clinical RCTs 

<a id="kq3Fig1"></a>

<font size = 4> Figure `r figure_n`. Pooled comparison of qualitative and clinical monitoring for RNMB (TOFR <0.7). </font>

```{r qualClinical, fig.width = 10, fig.height = 3}
## qualClinical --------------------------------------- (2022-03-31 11:23) @----
temp.meta.dat <- pairs_temp.dat %>% 
  filter(treat1 == "Clinical", treat2 == "Qualitative")

temp.meta <- metabin(event.e = event2,
  event.c = event1,
  n.e = n2,
  n.c = n1,
  sm = "RR",
  method = "MH",
  method.tau = "PM",
  prediction = FALSE,
  studlab = studlab,
  data = temp.meta.dat)

forest(temp.meta,
  common =  FALSE,
  label.e = "Qualitative",
  label.c = "Clinical",
  rightcols = c("effect", "ci"),
  rightlabs = c("RR", "(95% CI)"),
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  pooled.events = TRUE,
  # subgroup = TRUE,
  # print.subgroup.name = FALSE,
  # text.subgroup.nohet = TRUE,
  colgap.forest = unit(5, "mm"),
  xlim = c(0.01, 5),
  at = c(.01, .1, .5, 1.0, 1.5),
  xlab = "Favors: Qualitative                   Clinical")

figure_n <- fig_inc()
```
Manual TOF and manual TOF/DBS arms combined from Ueda 1991.

### Quantitive vs. Clinical RCTs 

<a id="kq3Fig2"></a>

<font size = 4> Figure `r figure_n`. Pooled comparison of quantitative and clinical monitoring for RNMB (TOFR <0.7. 0.8, or 0.9). </font>

```{r quantClinical, fig.width = 10, fig.height = 3}
## quantClinical -------------------------------------- (2022-03-31 11:24) @----
temp.meta.dat <- pairs_temp.dat %>% 
  filter(treat1 == "Clinical", treat2 == "Quantitative")

temp.meta <- metabin(event.e = event2,
  event.c = event1,
  n.e = n2,
  n.c = n1,
  sm = "RR",
  method = "MH",
  method.tau = "PM",
  prediction = FALSE,
  studlab = studlab,
  data = temp.meta.dat)

forest(temp.meta,
  common =  FALSE,
  label.e = "Quantitative",
  label.c = "Clinical",
  rightcols = c("effect", "ci"),
  rightlabs = c("RR", "(95% CI)"),
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  pooled.events = TRUE,
  # subgroup = TRUE,
  # print.subgroup.name = FALSE,
  # text.subgroup.nohet = TRUE,
  colgap.forest = unit(5, "mm"),
  xlim = c(0.01, 5),
  at = c(.01, .1, .5, 1.0, 1.5),
  xlab = "Favors: Quantitative        Qualitative")

figure_n <- fig_inc()
```

### Quantitative vs. Qualitative RCTs 

<a id="kq3Fig3"></a>

<br/>

<font size = 4> Figure `r figure_n`. Pooled comparison of quantitative and clinical monitoring for RNMB (TOFR <0.9).</font>

```{r quantQual, fig.width = 10, fig.height = 3}
## quantQual ----------------------------------------- (2022-03-31 11:25) @----
temp.meta.dat <- pairs_temp.dat %>% 
  filter(treat1 == "Qualitative", treat2 == "Quantitative")

temp.meta <- metabin(event.e = event2,
  event.c = event1,
  n.e = n2,
  n.c = n1,
  sm = "RR",
  method = "MH",
  method.tau = "PM",
  prediction = FALSE,
  studlab = studlab,
  data = temp.meta.dat)

forest(temp.meta,
  common =  FALSE,
  label.e = "Quantitative",
  label.c = "Qualitative",
  rightcols = c("effect", "ci"),
  rightlabs = c("RR", "(95% CI)"),
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  pooled.events = TRUE,
  # subgroup = TRUE,
  # print.subgroup.name = FALSE,
  # text.subgroup.nohet = TRUE,
  colgap.forest = unit(5, "mm"),
  xlim = c(0.01, 5),
  at = c(.01, .1, .5, 1.0, 1.5),
  xlab = "Favors: Quantitative        Qualitative")

figure_n <- fig_inc()
```

### Pooled TOFR (<0.7 to <0.9, all designs)

```{r rnmbNmaFit}
## rnmbNmaFit (updated 2022/01/19 05:23) ----------------------------------
library(netmeta)
nma_nmm.dat <- nmm_kable %>% 
  fill(study) %>% 
  mutate(
  arm_n = ifelse(study == "Ueda 1991" & arm == 2, 60, arm_n),
  rnmb1_n = ifelse(study == "Ueda 1991" & arm == 2, 19, rnmb1_n),
  arm_diag_outcome = ifelse(study == "Ueda 1991" & arm == 2, "Qualitative", arm_diag_outcome),
  arm_diag_outcome = ifelse(arm_diag_outcome %in% c("PNS/Clinical", "PNS"), "Qualitative", arm_diag_outcome),
  arm_diag_outcome = ifelse(arm_diag_outcome %in% c("AMG", "EMG"), "Quantitative", arm_diag_outcome)
  ) %>% 
  filter(!(study == "Ueda 1991" & arm == 1)) %>% 
  select(study, arm_diag_outcome, arm, rnmb1_n, arm_n)

pairs.dat <- pairwise(
  treat = arm_diag_outcome,
  event = rnmb1_n,
  n = arm_n,
  studlab = study,
  data = nma_nmm.dat,
  sm = "RR"
)

trts <- c("Clinical", "Qualitative", "Quantitative")

nmm_netmeta_nma <- netmeta(
  pairs.dat,
  random = TRUE,
  # backtransf = TRUE,
  prediction = TRUE,
  seq = trts,
  sm = "RR",
  reference.group = "Clinical"
)

```

### &ensp;Network Plot

<br/>

<font size = 4> Figure `r figure_n`. Network plot of 10 studies (8 RCTs, 2 non-randomized) eporting residual neuromuscular blockade (TOFR <0.9 to <0.7). </font>

```{r nmmNetplot, include = TRUE, echo = FALSE, fig.align = 'left', fig.width = 10, fig.asp = .5}
# fig.height = 4.5}
## nmmNetplot (updated 2022/01/19 05:59) ----------------------------------
# crashing rstudio
# node_size <- nma_nmm.dat %>% 
#   mutate(arm_diag_outcome = fct_relevel(arm_diag_outcome, trts)) %>% 
#   group_by(arm_diag_outcome) %>% 
#   summarise(n = sum(arm_n)) 
# 
# netgraph(nmm_netmeta_nma,
#   lwd = 2,
#   plastic = FALSE,
#   thickness = TRUE,
#   points = TRUE,
#   alpha.transparency = 2,
#   col = "azure3",
#   number.of.studies = TRUE,
#   seq = trts,
#   # cex.points = c(1, 2, 3, 4, 5),
#   # cex.points = node_size$n/40,
#   col.number.of.studies = "black",
#   cex.number.of.studies = 1,
#   col.highlight = "white"
# )

nmm.data <- BUGSnet::data.prep(
  arm.data = nma_nmm.dat,
  # arm.data = rgv_meta_log.dat,
  varname.t = "arm_diag_outcome",
  varname.s = "study"
)

BUGSnet::net.plot(nmm.data,
  node.scale = 4,
  edge.scale = 1.5,
  label.offset2 = 3,
  label.offset1 = 8,
  study.counts = TRUE,
  node.lab.cex = 1,
  edge.lab.cex = 1.2
)

figure_n <- fig_inc()
```

```{r nmaDescript, eval = TRUE}
net_table <- BUGSnet::net.tab(nmm.data,
  outcome = "rnmb1_n",
  N = "arm_n",
  type.outcome = "binomial"
) 

net_table$network %>%
  mutate(Characteristic = ifelse(Characteristic == "Average Outcome", "Average Residual Gastric Volume (mL)", Characteristic),
         Value = ifelse(Value == 21.89, 21.9, Value)) %>% 
  kbl(booktabs = T, align =  c("lr"), escape = FALSE, col.names = c("Characteristic", "Value")) %>% 
  row_spec(0, bold = TRUE) %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  column_spec(1, width = "30em") %>%
  column_spec(2, width = "6em")

```

<a id="kq3Fig5"></a>

### &ensp;Forest Plot

<br/>

<font size = 4> Figure `r figure_n`. Pooled residual neuromuscular blockade (TOFR <0.9 to <0.7) from 8 randomized trials, 1 quasi-experimental, and 1 non-randomized study comparing quantitative, qualitative, and clinical monitoring (network meta-analysis). </font>

```{r nmmForest, include = TRUE, echo = FALSE, fig.align = 'left', fig.width = 8, fig.height = 2.5}
forest(nmm_netmeta_nma,
       xlab = "        Risk Ratio",
       xlim = c(.001, 2),
       at = c(0.01, .1, 0.5, 1, 2))

figure_n <- fig_inc()
```
<font size = 3>I^2^ = 25% (95% CI 0%, 65%)</font>

<br/>

<a id="kq3Tab5"></a>

### &ensp;League Table (all comparisons)

<br/>

<font size = 4> Table `r table_n`. League table for risk ratios comparing upper left to lower right. Network comparisons in lower left triangle and direct comparisons in upper right. </font>

```{r leagueTable}
## leagueTable (updated 2022/01/19 06:34) ---------------------------------
trts <- rev(c("Clinical", "Qualitative", "Quantitative"))

nmm_league <- netleague(nmm_netmeta_nma,
  digits = 2,
  common =  FALSE,
  # direct = FALSE,
  seq = trts
)

temp <- as_tibble(nmm_league$random) %>% 
  mutate(
    across(V1:V3, ~ if_else(.x %in% c("Clinical", "Qualitative", "Quantitative"),
      cell_spec(.x, bold = TRUE), .x
    ))
  ) 

temp %>% 
  kbl(
    booktabs = T, align = c("ccc"), escape = FALSE,
    col.names = c(rep(" ", 3))
  ) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "center", font_size = 18) %>%
  # kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  row_spec(1:3, extra_css = "vertical-align: middle !important; border-top: 1px solid LightGray; border-bottom: 1px solid LightGray;") %>% 
  column_spec(1:3, width = "10em")
  # footnote( 
  #   general = "I^2^ = 30 (95% CI: 0%, 66%)",
  #   # alphabet = c("Footnote a", "Footnote b", ...),
  #   general_title = "",
  #   footnote_as_chunk = FALSE
  # )

table_n <- tab_inc()
```

<br/>

### &ensp;Node Splitting Forest Plot

<br/>

<font size = 4> Figure `r figure_n`. Comparison of direct and indirect evidence (network meta-analysis). </font>

```{r nmmNodeSplit, include = TRUE, echo = FALSE, fig.align = 'left', fig.width = 8, fig.height = 5.5}
netsplit(nmm_netmeta_nma,
  order = trts
) %>%
  forest(.,
    xlab = "Risk Ratio",
    leftcols = c("studlab", "k"),
    rightlabs = c("RR", "(95% CI)")
  )

figure_n <- fig_inc()
```

<br/>

### Mean TOFR

<a id="kq3Tab6"></a>

<br/>

<font size = 4> Table `r table_n`. Results from studies reporting mean TOFR at extubation or in the PACU. </font>

```{r contin_ptout.dat}
## (updated 2022/01/03 15:52) contin_ptout.dat ----------------------------
contin_ptout.dat <- contin.dat %>%
  filter(refid %in% ptout_refids) %>%
  filter(if_any(c(tofr_extub, tofr_pacu), ~ !is.na(.))) %>%
  select(refid:age, study_arm_k, arm_id, arm_n, arm_diag_outcome:arm_notes, mon_name, tofr_ind_norm, tofr8_time:timeext_md_pval) %>%
  select(-starts_with(c("tofr8", "tofr9", "tofr1", "time")), -extub_time, -sens, -spec) %>%
  remove_empty(which = "cols") %>%
  # todo: clean code
  mutate(
    arm_diag_outcome = ifelse(study == "Ueda 1991" & arm_id == 1, "Manual TOF/DBS", arm_diag_outcome),
    arm_diag_outcome = ifelse(study == "Ueda 1991" & arm_id == 2, "Manual TOF", arm_diag_outcome),
    tofr_ext_mn = paste0(round_2(tofrext_mean), " (", round_2(tofrext_sd), ")"),
    tofr_ext_mn = str_replace(tofr_ext_mn, " NA \\( NA\\)", ""),
    tofr_pacu_mn = paste0(round_2(tofr_pacu_mean), " (", round_2(tofr_pacu_sd), ")"),
    tofr_pacu_mn = str_replace(tofr_pacu_mn, " NA \\( NA\\)", ""),
    tofr_ext_md = paste0(tofrext_med, " [", round_2(tofrext_low), "-", round_2(tofrext_up), "]"),
    tofr_ext_md = str_replace(tofr_ext_md, "NA ", ""),
    tofr_ext_md = str_replace(tofr_ext_md, "\\[ NA- NA\\]", ""),
    tofr_pacu_md = case_when(
      is.na(tofr_pacu_med) & !is.na(tofr_pacu_low) ~ paste0("[", round_2(tofr_pacu_low), "-", round_2(tofr_pacu_up), "]"),
      !is.na(tofr_pacu_med) & !is.na(tofr_pacu_low) ~ paste0(round_2d(tofr_pacu_med), " [", round_2(tofr_pacu_low), "-", round_2(tofr_pacu_up), "]"),
      !is.na(tofr_pacu_med) & !is.na(tofr_pacu_iqr_l) ~ paste0(round_2(tofr_pacu_med), " {", round_2(tofr_pacu_iqr_l), "-", round_2(tofr_pacu_iqr_u), "}"),
      TRUE ~ NA_character_
    )
  ) %>%
  relocate(c(tofr_ext_mn, tofr_ext_md, tofr_pacu_mn, tofr_pacu_md), .after = arm_n) %>%
  rename(arm_nmm = arm_diag_outcome)
```

```{r continPtoutKbl}
contin_ptout.dat %>%
  select(study, study_l, year, design, arm_id, arm_n, arm_nmm, tofr_ext_mn:tofr_pacu_md) %>%
  mutate(
    arm_nmm = case_when(
      study == "Pedersen 1990" & arm_id %in% c(1, 3) ~ paste0(arm_nmm, "_pan"),
      study == "Pedersen 1990" & arm_id %in% c(2, 4) ~ paste0(arm_nmm, "_vec"),
      TRUE ~ arm_nmm
    ),
    arm_nmm = factor(arm_nmm,
      levels = c("clinical", "clinical_pan", "clinical_vec", "pns_pan", "pns_vec", "pns", "pns_clin", "Manual TOF", "Manual TOF/DBS", "amg_uni", "amg_ns", "emg"),
      labels = c("Clinical", "Clinical (pan)", "Clinical (vec)", "PNS (pan)", "PNS (vec)", "PNS", "PNS/Clinical", "Manual TOF", "Manual TOF/DBS", "AMG", "AMG", "EMG")
    ),
    note = case_when(
      study == "Pedersen 1990" & arm_id %in% c(2, 4) ~ "vs. pancuronium p&lt;.01",
      study == "Ueda 1991" & arm_id == 2 ~ "vs. clinical p&lt;.05",
      study == "Ueda 1991" & arm_id == 1 ~ "vs. clinical p&lt;.001",
      study == "Mortensen 1995" & arm_id == 2 ~ "difference not detected",
      study == "Shorten 1995" & arm_id == 1 ~ "vs. clinical p&lt;.05",
      study == "Fruergaard 1998" & arm_id == 1 ~ "vs. clinical p=.02",
      study == "Murphy 2011" & arm_id == 1 ~ "vs. clinical p=.004",
      study == "Wardhana 2019" & arm_id == 1 ~ "vs. clinical p=.05",
      study == "Todd 2014" & arm_id == 2 ~ "vs. clinical p=.008",
      #  study == "x" & arm_id == # ~ "vs. clinical  p<.001",
      TRUE ~ NA_character_
    )
  ) %>%
  arrange(design, year, study, arm_nmm) %>%
  group_by(study) %>%
  mutate(
    study_l = ifelse(row_number() != 1, NA_character_, study_l)
  ) %>%
  ungroup() %>%
  select(study_l, arm_nmm, arm_n, tofr_ext_mn:tofr_pacu_md, note) %>%
  kbl(
    booktabs = T, align = c("lllrrrrl"), escape = FALSE, # format = "latex",
    col.names = c("Study", "Monitoring", "N", "M (SD)       ", "Med (range)   ", "M (SD)       ", "Med [Range] {IQR}", "        Note")
  ) %>%
  add_header_above(c(" " = 3, "Extubation" = 2, "PACU" = 2, " " = 1), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "8em") %>%
  column_spec(3, width = "5em") %>%
  column_spec(4, width = "6em") %>%
  column_spec(5, width = "9em") %>%
  column_spec(6, width = "6em") %>%
  column_spec(7, width = "9em") %>%
  column_spec(8, width = note_width) %>%
  pack_topnoind(., "RCT", 1, 17) %>%
  pack_topnoind(., "Quasi-Experimental", 18, 18) %>% 
  footnote(
    general = "M: mean; SD: standard deviation; Med: median; vec: vecuronium; pan: pancuronium; RCT: randomized controlled trial; DBS: double burst stimulation; TOFR: train of four ratio; PNS: peripheral nerve stimulator; AMG: acceleromyography; EMG: electromyography; PACU: post-anesthesia care unit.",
    # alphabet = c(""),
    general_title = "",
    footnote_as_chunk = FALSE
  )  

table_n <- tab_inc()
```

<br/>

## *Pulmonary complications*

<a id="kq3Tab7"></a>

<br/>

<font size = 4> Table `r table_n`. Results of studies reporting pulmonary complications. </font>

<!-- <span style="color:black"><font size = 4> Table `r table_n`. Results of studies reporting pulmonary complications. </font></span> -->

```{r pulmComp} 
## (updated 2021/12/30 08:25) pulmComp ------------------------------------
dichot_format <- function(x) (x/100)

dichot_pulm <- dichot.dat %>%
  filter(refid %in% ptout_refids) %>%
  filter(refid != 3574) %>% # delete Alenezi as not reported
  filter(if_any(c(reintub_n:pc_upairobs_p), ~ !is.na(.))) %>%
  remove_empty(which = "cols") %>%
  # select(refid:design, arm_n, reintub_n:pc_upairobs_p, notes_d, linked_references) %>%
  select(refid:design, study_arm_k, arm_n, ends_with("_n"), ends_with("_per")) %>%
  select(-starts_with("brad"), -ponv_n, -nausea_n, -vomit_n, -starts_with("rnmb"), -ends_with("_per")) %>%
  pivot_longer(!c(refid:arm_n), names_to = "outcome", values_to = "n", values_drop_na = TRUE) %>%
  mutate(
    arm_nmm = str_remove(study_arm_k, "diag_pt_out\\|"),
    arm_nmm = factor(arm_nmm,
      levels = c("none", "clinical", "pns_clin", "pns", "quant_qual", "amg_uni", "amg_ns", "quant_all"),
      labels = c("None", "Clinical", "PNS/Clinical", "PNS", "Any NMM", "AMG", "AMG", "Quantitative")
    ),
    outcome = str_replace(outcome, "_n", ""),
    outcome = str_replace(outcome, "pc_", ""),
    arm_id = 3 - arm_id,
    # arm_id = ifelse(study %in% c("Murphy 2008", "Kirmeier 2019", "Thilen 2018"), 3 - arm_id, arm_id)
  ) %>%
  arrange(outcome, design, refid, arm_nmm)  

# add second comparison Kirmeier 2019
temp <- dichot_pulm %>% 
  filter(study == "Kirmeier 2019")  %>% 
  mutate(refid = 3304,
         arm_nmm = factor(ifelse(arm_id == 1, "None", "Any NMM")),
         arm_n = ifelse(arm_id == 1, 9927, 7223),
         n = ifelse(arm_id == 1, 676, 765))

dichot_pulm_kbl <- dichot_pulm %>% 
  add_row(temp, .after = 10) %>% 
  group_by(outcome, refid) %>%
  mutate(
    outcome = factor(outcome, levels = Hmisc::Cs(reintub, upairobs, respfail, hypox, bronch, pneum, pulcong, pulm)),
    n_com = lag(n),
    arm_n_com = lag(arm_n),
    rr_ci = risk_ratio_y(n, arm_n, n_com, arm_n_com),
    rr_ci = ifelse(rr_ci == "NA (NA-NA)", NA, rr_ci),
    rr_ci = ifelse(row_number() %% 2 == 0 & is.na(rr_ci), "—", rr_ci),
    # Kirmeier 2019 adjusted
    rr_ci = ifelse(arm_id == 2 & refid == 3303, "1.07 (0.90-1.29)^b^", rr_ci),
    rr_ci = ifelse(arm_id == 2 & refid == 3304, "1.31 (1.15-1.49)^b^", rr_ci),
    n_per = n_percent1(n, n / arm_n * 100),
    per = n / arm_n * 100,
    per_bar = 0,
    per_bar = case_when(
      # arm_nmm == "Clinical" ~ color_bar("#f1948a", fun = dichot_format)(per),
      # refid == 3304 & arm_id == 2 ~ color_bar("#aec176", fun = dichot_format)(per),
      # arm_nmm %in% c("AMG", "Quantitative") ~ color_bar("#58d68d", fun = dichot_format)(per),
      # TRUE ~ color_bar("#f5c800", fun = dichot_format)(per)
      arm_nmm == "Clinical" ~ bar_wn(per, per, color_4, 100),
      arm_nmm %in% c("AMG", "Quantitative") ~ bar_wn(per, per, color_1, 100),
      refid == 3304 & arm_id == 2 ~ bar_wn(per, per, color_3, 100),
      TRUE ~ bar_wn(per, per, color_2, 100),
    ),
    per_bar = str_replace(per_bar, ">\\d{1,2}\\.?\\d+?\\w+", ">&nbsp;"),
    per_bar = str_replace(per_bar, ">\\d{1,2}<", ">&nbsp;<"),
    # per_bar = str_replace(per_bar, ">\\d*\\.?\\d*?", ">&nbsp;"),
    # per_bar = str_replace(per_bar, "2px", "0px")
  ) %>%
  ungroup() %>% 
  # exclude pulomary congestion/edema
  filter(outcome != "pulcong") %>% 
  # add comments
  mutate(note = NA_character_,
         note = case_when(
           refid == 2071 & outcome == "hypox" ~ "<90% in PACU",
           refid == 3105 & outcome == "hypox" ~ "\U2264 93% in PACU",
           refid == 3369 & outcome == "hypox" ~ "pO<sub>2</sub> unspecified",
           refid == 3140 & outcome == "pneum"~ "at 48hr postop",
           refid %in% c(3303, 3304) ~ "1-28d postop^c^",
           refid == 3369 & outcome == "bronch" ~ "Distress/bronchospasm",
           TRUE ~ NA_character_
         )) %>% 
  arrange(outcome, design, refid, arm_nmm)

# TODO: fix indices

dichot_pulm_kbl %>% 
  mutate(arm_nmm = case_when(
    str_detect(arm_nmm, "Clinical|None") ~ cell_spec(arm_nmm, color = color_4),
    str_detect(arm_nmm, "Manual|PNS") ~cell_spec(arm_nmm, color = color_2), 
    str_detect(arm_nmm, "AMG|EMG|Quantitative") ~ cell_spec(arm_nmm, color = color_1),
    refid == 3304 & arm_id == 2 ~ cell_spec(arm_nmm, color = color_1)
  )) %>%
  group_by(outcome, refid) %>%
  mutate(
    study_l = ifelse(row_number() == 1, study_l, NA),
  ) %>%
  ungroup() %>% 
  select(study_l, arm_nmm, arm_n, n_per, per_bar, rr_ci, note) %>% 
  kbl(
    booktabs = T, align = c("lllllll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "Monitoring", "N", "N (%)", bar_ref,  "RR (95% CI)^a^", "Note")
  ) %>%
  add_header_above(c(" " = 3, "Complication" = 2, " " = 2), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "8em") %>%
  column_spec(3, width = "5em") %>%
  column_spec(4, width = "5em") %>%
  column_spec(5, width = bar_width) %>%
  column_spec(6, width = or_width) %>%
  column_spec(7, width = note_width) %>%
  # reintubation
  pack_topnoind(., "Reintubation", 1, 4) %>%
  pack_sub_bold(., "RCT", 1, 2) %>%
  pack_sub_bold(., "Prospective Cohort", 3, 4) %>%
  # upper airway obstruction
  pack_topnoind(., "Upper Airway Obstruction", 5, 6) %>%
  pack_sub_bold(., "RCT", 5, 6) %>%
  # hypoxia
  pack_topnoind(., "Hypoxia^d^", 7, 12) %>%
  pack_sub_bold(., "RCT", 7, 12) %>%
  # bronchospasm
  pack_topnoind(., "Brochospasm", 13, 14) %>%
  pack_sub_bold(., "RCT", 13, 14) %>%
  # pnuemonia
  pack_topnoind(., "Pneumonia", 15, 16) %>%
  pack_sub_bold(., "Prospective Cohort", 15, 16) %>%
  # pulmonary
  pack_topnoind(., "Pulmonary", 17, 20) %>%
  # result_pack(., "OR (95% CI)", 17, padding = 65) %>% 
  pack_sub_bold(., "Before-After", 17, 18) %>%
  pack_sub_bold(., "Prospective Cohort                                                                                                                                 OR (95% CI)", 19, 22) %>% 
  footnote(
    general = "RR: Risk ratio; OR: odds ratio; CI: confidence interval; RCT: randomized controlled trial; PNS: peripheral nerve stimulator; AMG: acceleromyography; NMM: neuromuscular monitoring.",
    alphabet = c(
      "RR comparing the last arm to the prior one. Where 0 events in an arm, continuity correction used to estimate RR.",
      "Adjusted for potential confounders.",
      "Respiratory failure (includes hypoxia), suspected pulmonary infection or infiltrates, atelectasis, aspiration pneumonitis, bronchospasm, or pulmonary edema.",
      "Pooled Murphy and Adembesa RR 0.22 (95% CI, 0.05–0.88), I^2^ = 26%"),
    general_title = "",
    footnote_as_chunk = FALSE
  )

rm(temp, dichot_pulm_kbl, dichot_pulm.dat)
table_n <- tab_inc()
```

```{r metaHypox, eval = FALSE}
temp.meta.dat <- tribble(
  ~study, ~event_nmm, ~n_nmm, ~event_qualclin, ~n_qualclin,
  "Murphy 2008", 0, 89, 9, 90,
  "Adembese", 5, 84, 16, 84
)

metabin(event_nmm, n_nmm, event_qualclin, n_qualclin,
  sm = "RR",
  method = "MH",
  method.tau = "PM",
  prediction = FALSE,
  studlab = study,
  data = temp.meta.dat)
)
```


<br/>

```{r checkLikContin, include = FALSE, eval = FALSE}
temp <- likert.dat %>%
  filter(refid %in% ptout_refids) %>%
  filter(if_any(c(pain_m:ponv_pval), ~ !is.na(.)))

temp <- contin.dat %>%
  filter(refid %in% ptout_refids) %>%
  filter(if_any(c(tofr8_time:ba_dependent), ~ !is.na(.))) %>% 
  remove_empty(which = "cols")

write_csv(temp, "/Users/mgrant/Desktop/temp1.csv", na = "")

```

<br/><br/>

# **Study/Participant Detail** 

<br/>

### *Study Characteristics* 

###   <u>Adult Studies</u> 

<br>

<font size = 4> Table `r table_n`. Characteristics of studies including only adults. </font>

```{r createStudyCharTable, include = FALSE} 
## (updated 2021/01/12 09:30) createStudyCharTable ------------------------
study_char_table <- study_char.dat %>%
  filter(refid %in% ptout_refids) %>% 
  mutate(
    dates = str_c(date_start, "-", date_end),
    country = countrycode::countryname(country, destination = "iso3c"),
    low_r = noquote(if_else(non_vh_hdi == "yes", "\U2022", "", "")),
    n = n_enrolled,
    n_anal = n_analyze,
    pilot = noquote(if_else(pilot == "yes", "\U2022", "", "")),
    setting = case_when(
      !is.na(hospital) ~ "Hosp",
      !is.na(ambulatory) ~ "Amb",
      !is.na(other_setting) ~ "Other"
    ),
    gen = noquote(if_else(!is.na(general), "\U2022", "", "")),
    reg = noquote(if_else(!is.na(regional), "\U2022", "", "")),
    sed = noquote(if_else(!is.na(sedation), "\U2022", "", "")),
    registered = noquote(if_else(registered == "yes", "\U2022", "", "")),
    across(surg_various:surg_other, ~ str_replace(.x, "surg_", "")),
    across(surg_various:surg_other, ~ str_c(.x, ", ")),
    across(surg_various:surg_other, ~ firstup(.x)),
    across(surg_various:surg_other, ~ replace_na(.x, "")),
    surg_list = ifelse(grepl("abdom", surg_list), "Abdom, ", ""),
    surgs = str_c(surg_various, surg_car, surg_cr, surg_gyn, surg_gi, surg_gen, surg_headneck, surg_hep, surg_neuro, surg_opth, surg_oralmax, surg_ortho, surg_otolar, surg_plastic, surg_thor, surg_urol, surg_list),
    surgs = str_replace(surgs, "Otolar", "ENT"),
    surgs = str_replace(surgs, "Car", "Card"),
    surgs = str_replace(surgs, "Cr", "GI"),
    surgs = str_replace(surgs, "Gi", "GI"),
    surgs = str_replace(surgs, "Headneck", "ENT"),
    surgs = str_sub(surgs, 1, nchar(surgs) - 2),
    country = ifelse(grepl("USA", country), "USA", country),
    country = ifelse(grepl("UK", country), "UK", country),
    country = ifelse(!is.na(non_vh_hdi), str_c(country, "^a^"), country)
  ) %>%
  arrange(age, design, year, study) %>%
  select(refid, age, design, study, dates, country, n, pilot, setting, gen, reg, -sed,  surgs, registered)

```

```{r studyCharKableAdult, echo = FALSE} 
## (updated 2021/01/12 19:27) ---------------------------------------------
temp <- study_char_table %>%
  arrange(age, design, study) %>% 
  filter(age == "Adult") %>% 
  select(study, refid, age, design) %>% 
  group_by(age, design) %>% 
  tally() %>% 
  ungroup() %>% 
  mutate(end = cumsum(n),
         start = end - n + 1) %>% 
  select(age, design, start, end)

study_char_table %>%
  filter(age == "Adult") %>% 
  select(!c(refid, age, design)) %>% 
  kbl(booktabs = T, align = c("llllcccclc"), 
      # format = "latex",
      col.names = c("Study", "Dates", "Country", " N ", "Pilot", 
                    "Setting", "Gen", "Reg", "Type of Surgery", "Registered")) %>%
  add_header_above(c(" " = 6, "Anesthesia" = 2, " " = 2), bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>% 
  column_spec(2, width = "8em") %>% 
  column_spec(3, width = "5em") %>% 
  column_spec(4, width = "4em") %>% 
  column_spec(5, width = "4em") %>% 
  column_spec(6, width = "5em") %>% 
  column_spec(7, width = "3em") %>% 
  column_spec(8, width = "3em") %>% 
  column_spec(9, width = "15em") %>% 
  column_spec(10, width = "5em") %>% 
  pack_topnoind(., "RCT", 1, 10) %>% 
  pack_topnoind(., "Before-After", 11, 12) %>% 
  pack_topnoind(., "Prospective Cohort", 13, 15) %>%
  pack_topnoind(., "Prospective Cohort", 16, 16) %>% 
  footnote(general_title = "",
    general = c("Gen: general; Reg: regional; Sed: sedation; Hosp: hospital; Amb: ambulatory; GI: gastrointestinal; Ortho: orthopedic; Abdom: abdominal; ENT: otolaryngology (ear, nose, and throat); Gyn: gynecologic; Urol: urologic; Neuro: neurological; Hep: hepatic; Thor: thoracic; Oralmax: oral maxillofacial"),
    alphabet = c("Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."),
    footnote_as_chunk = FALSE) # %>% 

table_n <- tab_inc()
```

<br/>

### *Patient Characteristics* 

###   <u>Adult Studies</u> 

<br>    

<font size = 4> Table `r table_n`. Patient characteristics in studies including only adults. </font>

```{r ptCharTableData, include = FALSE}
## ptCharTableData (updated 2022/01/15 10:08) ----------------------------
pt_char_table <- study_arm.dat %>%
  filter(refid %in% ptout_refids) %>%
  group_by(refid) %>%
  summarize(
    N = sum(arm_n),
    wgt = arm_n / N,
    asa_1_all = round(sum(asa_1 * wgt, na.rm = FALSE)),
    asa_2_all = round(sum(asa_2 * wgt, na.rm = FALSE)),
    asa_3_all = round(sum(asa_3 * wgt, na.rm = FALSE)),
    asa_12_all = round(sum(asa_12 * wgt, na.rm = FALSE)),
    asa_123_all = round(sum(asa_123 * wgt, na.rm = FALSE)),
    asa_23_all = round(sum(asa_23 * wgt, na.rm = FALSE)),
    asa_34_all = round(sum(asa_34 * wgt, na.rm = FALSE)),
    age_mn_all = round(sum(age_mean * wgt, na.rm = FALSE)),
    age_md_all = round(sum(age_med * wgt, na.rm = FALSE)),
    sex_all = round(sum(female * wgt, na.rm = FALSE)),
    white_all = round(sum(white * wgt, na.rm = FALSE)),
    black_all = round(sum(black * wgt, na.rm = FALSE)),
    asian_all = round(sum(asian * wgt, na.rm = FALSE)),
    bmi_mn_all = round(sum(bmi_mean * wgt, na.rm = FALSE)),
    bmi_md_all = round(sum(bmi_med * wgt, na.rm = FALSE)),
    cardiac_all = round(sum(cardiac * wgt, na.rm = FALSE)),
    cancer_all = round(sum(cancer * wgt, na.rm = FALSE)),
    renal_all = round(sum(renal * wgt, na.rm = FALSE)),
    gi_all = round(sum(gi * wgt, na.rm = FALSE)),
    pulm_all = round(sum(pulm * wgt, na.rm = FALSE)),
    hepatic = round(sum(hepatic * wgt, na.rm = FALSE)),
    dm_all = round(sum(dm * wgt, na.rm = FALSE)),
    neuro_all = round(sum(neuro * wgt, na.rm = FALSE))
  ) %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  # remove_empty(which = "cols") %>%
  # categorize asa class
  mutate(
    asa_1 = ifelse(if_any(c(asa_1_all, asa_12_all, asa_123_all), ~ !is.na(.)), "\U00D7", NA),
    asa_2 = ifelse(if_any(c(asa_12_all, asa_2_all, asa_123_all), ~ !is.na(.)), "\U00D7", NA),
    asa_3 = ifelse(if_any(c(asa_123_all, asa_3_all), ~ !is.na(.)), "\U00D7", NA),
    asa_4 = ifelse(if_any(c(asa_34_all), ~ !is.na(.)), "\U00D7", NA)
  ) %>%
  mutate(across(c(cardiac_all:neuro_all), ~ bar_wn(.x, .x, color_1, 100)),
    across(c(white_all:asian_all), ~ bar_wn(.x, .x, color_2, 100)),
    sex_all = bar_wn(sex_all, sex_all, color_3, 100),
    age_sum = ifelse(is.na(age_mn_all) & !is.na(age_md_all), paste0("<u>", age_md_all, "</u>"), age_mn_all),
    bmi = ifelse(is.na(bmi_mn_all) & !is.na(bmi_md_all), paste0("<u>", bmi_md_all, "</u>"), bmi_mn_all)
  ) %>%
  relocate(bmi, .before = bmi_mn_all) %>%
  relocate(age_sum, .before = age_mn_all) %>%
  relocate(c(asa_1, asa_2, asa_3, asa_4), .before = N) %>%
  select(-c(asa_1_all:asa_34_all, wgt, bmi_mn_all, bmi_md_all, age_mn_all, age_md_all))

pt_char_table <- left_join(pt_char_table, study_char.dat[, c("refid", "age", "design", "study", "year")], by = "refid") %>% 
  relocate(c(age, design, study, year), .after = "refid") %>% 
  arrange(design, year)

```

```{r ptCharTableAdult}
## ptCharTableData (updated 2022/01/15 10:08)  ----------------------------
temp <- pt_char_table %>%
  arrange(age, design, study) %>% 
  filter(age == "Adult") %>% 
  select(study, refid, age, design) %>% 
  group_by(age, design) %>% 
  tally() %>% 
  ungroup() %>% 
  mutate(end = cumsum(n),
         start = end - n + 1) %>% 
  select(age, design, start, end)

pt_char_table %>% 
  filter(age == "Adult") %>% 
  select(-c(refid, year, age, design)) %>% 
  select(study, N, asa_1:asa_4, age_sum, sex_all, white_all:asian_all, bmi, cardiac_all, renal_all, pulm_all, hepatic, dm_all, neuro_all) %>% 
    kbl(booktabs = T, align = c("llcccccllllcllllll"), escape = FALSE,
      col.names = c("Study", " N ", "1", "2", "3", "4", "M <u>Med</u>", "(%)", "W", "B", "A", "M <u>Med</u>", "Card", "Renal", "Pulm", "Hep", "DM", "Neur")) %>% 
  add_header_above(c(" " = 2, "ASA Class" = 4, "Age" = 1, "Female", "Race" = 3, "BMI" = 1, "Comorbidities (%)^a^" = 6), bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>% 
  column_spec(2, width = "3em") %>% 
  column_spec(3:6, width = "2em", popover = "ASA class (1 to 4)") %>% 
  column_spec(7, width = "4em", popover = "Age") %>% 
  column_spec(8, width = "4em", popover = "Female %") %>% 
  column_spec(9, width = "3em", popover = "White %") %>%
  column_spec(10, width = "3em", popover = "Black %") %>%
  column_spec(11, width = "3em", popover = "Asian %") %>%
  column_spec(12, width = "4em", popover = "BMI") %>% 
  column_spec(13, width = "3em", popover = "Cardiac %") %>%
  column_spec(14, width = "3em", popover = "Renal %") %>% 
  column_spec(15, width = "3em", popover = "Pulmonary %") %>% 
  column_spec(16, width = "3em", popover = "Hepatic %") %>% 
  column_spec(17, width = "3em", popover = "Diabetes %") %>% 
  column_spec(18, width = "3em", popover = "Nuerological %") %>% 
  pack_topnoind(., "RCT", 1, 10) %>% 
  pack_topnoind(., "Before-After", 11, 12) %>% 
  pack_topnoind(., "Prospective Cohort", 13, 15) %>%
  pack_topnoind(., "Prospective Cohort", 16, 16) %>% 
  footnote(general_title = "",
    general = c("M: mean; Med: median; Card: cardiac; Pulm: pulmonary; Hep: hepatic; DM: diabetes mellitus; Neuro: neurological: RCT: randomized controlled trial."),
    alphabet = c("Empty cells indicate no information in publication."),
    footnote_as_chunk = FALSE)  

table_n <- tab_inc()
```

<br/>

# **Funding and Conflict of Interest** 

<br/>

###   <u>Adult Studies</u> 

<br>

<font size = 4> Table `r table_n`. Funding^a^ and reported conflict of interest in studies including only adults. </font>

```{r createFundingTable, include = FALSE}
## (updated 2021/01/12 09:28) createFundingTable --------------------------
study_fund_table <- study_char.dat %>%
  filter(refid %in% ptout_refids) %>% 
  mutate(
    sponsor_desc = str_replace(sponsor_desc, "MSD", "Merck Sharp & Dohme Corp"),
    sponsor_desc = str_replace(sponsor_desc, "Merck & Co", "MSD"),
    sponsor_desc = str_replace(sponsor_desc, "Merck Sharp & Dohme Corp", "MSD"),
    sponsor_desc = str_replace(sponsor_desc, "Merck", "MSD"),
    sponsor_desc = firstup(sponsor_desc),
    # sponsor_desc = str_replace(sponsor_desc, "MSD", "Merck Sharp & Dohme"),
    auth_coi_desc = str_replace_all(auth_coi_desc, "MSD", "Merck Sharp & Dohme Corp"),
    auth_coi_desc = str_replace_all(auth_coi_desc, "Merck & Co", "Merck Sharp & Dohme Corp"),
    auth_coi_desc = str_replace_all(auth_coi_desc, "Merck Sharp & Dohme Corp", "MSD"),
    auth_coi_desc = str_replace_all(auth_coi_desc, "Merck", "MSD"),
    # auth_coi_desc = str_replace_all(auth_coi_desc, "MSD", "Merck Sharp & Dohme"),
    # sponsor_desc = str_to_title(sponsor_desc),
    auth_not_report = noquote(if_else(author_coi == "not_auth_rep", "\U00D7", "", "")),
    # auth_not_report = if_else(author_coi == "not_auth_rep", "&times", "", ""),
    auth_no_coi = noquote(if_else(author_coi == "none_auth_coi", "\U00D7", "", "")),
    auth_coi = noquote(if_else(author_coi == "author_coi", '<span style="color:red">\U00D7</span>', "", "")),
    registered = noquote(if_else(registered == "yes", "\U00D7", "", "")),
    public = noquote(if_else(funding == "public", "\U00D7", "", "")),
    pub_indus = noquote(if_else(funding == "pub_indus", '<span style="color:red">\U00D7</span>', "", "")),
    industry = noquote(if_else(funding == "industry", '<span style="color:red">\U00D7</span>', "", "")),
    none = noquote(if_else(funding == "none", "\U00D7", "", "")),
    not_reported = noquote(if_else(funding == "NR", "\U00D7", "", ""))) %>%
  arrange(age, design, year, study) %>%
  select(refid, study, age, design, public, pub_indus, industry, none, not_reported, sponsor_desc, auth_no_coi, auth_coi, auth_not_report, auth_coi_desc)

```

```{r fundingKable, echo = FALSE}
## (updated 2021/01/12 09:28) fundingKable --------------------------------
study_fund_table %>% 
  filter(age == "Adult") %>% 
  select(!c(refid, age, design)) %>% 
  kbl(booktabs = T, align = c("lccccclcccl"),
      col.names = c("Study", "Pub", '<span style="color:red">Pub/Ind</span>', '<span style="color:red">Ind</span>',  "None", "NR^a^", "Description", "No", '<span style="color:red">Yes</span>', "NR^a^", "Description"),
      escape = FALSE) %>%
  add_header_above(c(" " = 1, "Funding Source(s)" = 6, "Author Conflict of Interest" = 4), line = TRUE, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "12em") %>% 
  column_spec(2:6, width = "4em") %>% 
  column_spec(7, width = "20em") %>% 
  column_spec(8:10, width = "4em") %>% 
  column_spec(11, width = "20em") %>% 
pack_topnoind(., "RCT", 1, 10) %>% 
  pack_topnoind(., "Before-After", 11, 12) %>% 
  pack_topnoind(., "Prospective Cohort", 13, 15) %>%
  pack_topnoind(., "Prospective Cohort", 16, 16) %>% 
  footnote(
          # general = "Pub: public, Ind: industry; NR: not reported; MSD: Merck, Sharp, and Dohme (funded 23 (22%) of RCTs and 26 (19%) of studies listed).",
          alphabet = c("Not reported meaning no mention in publication of funding source or author conflicts of interest."))
          # general_title = " ",
          # alphabet_title = " ",
          # footnote_as_chunk = T)

table_n <- tab_inc()

```

<br/>

# **Risk of Bias** 

<br/>

### *RCTs Clinical Outcomes*

<br>

<font size = 4> Figure `r figure_n`. Summary risk of bias appraisal for included RCTs reporting RNMB. </font>

<img src="assets/kq3_rob_clin_out.svg" style="width:750px;" align="left"/>

<br clear="all" />

```{r}
figure_n <- fig_inc()
```

<br/>

<font size = 4> Figure `r figure_n`. Individual study risk of bias appraisal for reporting RNMB. </font>

<img src="assets/kq3_rob_clin_out_traffic.svg" style="width:650px;" align="left"/>

```{r}
figure_n <- fig_inc()
```

<br clear="all" />

### *Nonrandomized Studies of Interventions*

<br>

<font size = 4> Figure `r figure_n`. Summary risk of bias appraisal for included nonrandomized studies reporting RNMB [ROBINS-I](https://www.bmj.com/content/355/bmj.i4919). </font>

<img src="assets/kq3_robins_summary.svg" style="width:750px;" align="left"/>

<br clear="all" />

```{r}
figure_n <- fig_inc()
```

<br/>

<font size = 4> Figure `r figure_n`. Individual study risk of bias appraisal for nonrandomized studies reporting RNMB. </font>

<img src="assets/kq3_robins_traffic.svg" style="width:650px;" align="left"/>

```{r}
figure_n <- fig_inc()
```
<br clear="all" />

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<br>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<br>

# **References**
<a id="references"></a>

<br/>


<!-- across(.cols = c(ind_preload, ind_norm, ref_preload, ref_norm), ~ ifelse(.x %in% "yes", "\U000D7", ifelse(.x %in% "no", "\UFFEE", .x))) -->
