---
title: "Strength of Evidence"
date: "`r format(Sys.time(), '%d %B, %Y (%H:%M)')`"
output:
  workflowr::wflow_html:
    font: Source Sans Pro
    theme: cosmo
    anchor_sections: TRUE 
    toc: yes
    toc_depth: 3
    toc_float: 
      collapsed: TRUE
      smooth_scroll: yes
    linkcolor: black
  latex_engine: xelatex
  pdf_document:
    toc: yes
    toc_depth: '4'
workflowr:
  suppress_report: TRUE
editor_options:
  chunk_output_type: console     
---

#### 

```{=html} 
<style type="text/css">
  body{
  font-size: 9.5pt;
  font-family: Source Sans Pro;
}

.list-group-item.active, .list-group-item.active:hover, .list-group-item.active:focus {
  color: #090909;
  background-color: #0909093d;
}

.lightable-classic.lightable-hover tbody tr:hover {
    background-color: #c5d4e4;
}
.btn-xs, .btn-group-xs>.btn { 
display: none; 
}

.btn-default {
display: none !important; 
}

<!-- @font-face { -->
<!--     font-family: "GRADE-quality"; -->
<!--     src: url(); -->
<!--     src: url('https://gradepro.org/fonts/GRADE-quality.eot'); -->
<!--     src: url('https://gradepro.org/fonts/GRADE-quality.eot?#iefix') -->
<!--         format('embedded-opentype'), -->
<!--       url('https://gradepro.org/fonts/GRADE-quality.woff') format('woff'), -->
<!--       url('https://gradepro.org/fonts/GRADE-quality.ttf') format('truetype'), -->
<!--       url('https://gradepro.org/fonts/GRADE-quality.svg#GRADE-quality') -->
<!--         format('svg'); -->
<!--     font-weight: normal; -->
<!--     font-style: normal; -->
<!--   } -->

.quality-sign {
      font-family: 'GRADE-quality', Cambria, Helvetica, Arial;
      font-size: 10px;
      vertical-align: text-top;
    }

span { font-size: 3em;}

span b { font-size: 60%; font-weight: normal }


</style>
```

```{r, include = FALSE}
## (updated 2021/11/17 11:29) preliminaries -------------------------------
knitr::opts_chunk$set(
  echo = FALSE, 
  options(knitr.kable.NA = "", dev = "svg"), 
  knitr.graphics.error = FALSE,
  warning = FALSE, message = FALSE
)

library(kableExtra)
library(janitor)
library(countrycode)
library(Cairo)
library(tidyverse)
library(naniar)
library(formattable)

opt_font <-  c("Source Sans Pro")
opt_boot <- c("striped", "hover", "condensed")

tab_inc <- function() {
  table_n <- table_n + 1
  table_n}

fig_inc <- function() {
  figure_n <- figure_n + 1
  figure_n}

table_n <- 1
figure_n <- 1

pack_sub <- function(kable_input, name, a, b) {
  pack_rows(kable_input, name,
            start_row = a, end_row = b,
            label_row_css = "border-bottom: 0px solid;", color = "black", background = "white", bold = FALSE
  )
}

pack_top <- function(kable_input, name, a, b) {
  pack_rows(kable_input, name,
            start_row = a, end_row = b,
            label_row_css = "border-top: 1px solid;", color = "black", background = "#EBEBEB"
  )
}

firstup <- function(x) {
  substr(x, 1, 1) <- toupper(substr(x, 1, 1))
  x
}
```

```{r soeData, include = TRUE}
## (updated 2021/05/13 11:45) soeData -------------------------------------
col_types_nmb <- c("numeric", rep("text", 5), "numeric", rep("text", 19))
soe.dat <- readxl::read_xlsx("data/soe_111721.xlsx", range = "A1:Z2", sheet = "soe", col_types = col_types_nmb) %>%
  clean_names() %>%
  mutate(
    n_s = paste0(n_studies, " <br/>(", n_pts, ")"),
    n = paste0(n, outcome),
    # outcome = tools::toTitleCase(outcome) %>%
    outcome = str_to_sentence(outcome),
    out_import = case_when(
      out_import == "Limited" ~ "●",
      # out_import == "Limited" ~ "●○○",
      out_import == "Important" ~ "●●",
      out_import == "Critical" ~ "●●●"
    )
  )

## (updated 2021/11/17 11:44) soe_summary ---------------------------------
soe_summary <- soe.dat %>%
  select(n, comparison, outcome, n_s, grade, acc, out_import, result_summary, result_links) %>%
  mutate(
    grade = case_when(
      grade == "very low" ~ '<span><span class="quality-sign">⨁</span><span class="quality-sign">◯</span><span class="quality-sign">◯</span><span class="quality-sign">◯</span>',
      grade == "low" ~ '<span><span class="quality-sign">⨁</span><span class="quality-sign">⨁</span><span class="quality-sign">◯</span><span class="quality-sign">◯</span>',
      grade == "moderate" ~ '<span><span class="quality-sign">⨁</span><span class="quality-sign">⨁</span><span class="quality-sign">⨁</span><span class="quality-sign">◯</span>',
      grade == "high" ~ '<span><span class="quality-sign">⨁</span><span class="quality-sign">⨁</span><span class="quality-sign">⨁</span><span class="quality-sign">⨁</span>', # )%>%
      TRUE ~ grade
    )
  )

## (updated 2021/11/17 11:44) domain_summary ------------------------------
domain_summary <- soe.dat %>% 
  select(n, comparison, outcome, design, n_studies, n_pts, rob, consist, direct, prec, other, summary, ends_with("foot")) %>% 
  mutate(design = str_to_sentence(design),
         consist_foot = ifelse(!grepl("\\.$", consist_foot) & !is.na(consist_foot), paste0(consist_foot, "."), consist_foot),
         direct_foot  = ifelse(!grepl("\\.$", direct_foot ) & !is.na(direct_foot ), paste0(direct_foot , "."), direct_foot ),
         prec_foot    = ifelse(!grepl("\\.$", prec_foot   ) & !is.na(prec_foot   ), paste0(prec_foot   , "."), prec_foot   ),
         rob_foot     = ifelse(!grepl("\\.$", rob_foot    ) & !is.na(rob_foot    ), paste0(rob_foot    , "."), rob_foot    ),
         other_foot   = ifelse(!grepl("\\.$", other_foot  ) & !is.na(other_foot  ), paste0(other_foot  , "."), other_foot  ),
         across(ends_with("foot"), firstup)
         ) 

```

<font size = 4> Ratings in the following tables are for selected important outcomes obtained from randomized controlled trials. </font>

# **Reversal Agents (Toy Results)** 

<br/>

#    **Adult**

## *Sugammadex vs. Neostigmine*

### Strength of Evidence Ratings

<br/>

<font size = 4> Table `r table_n`. Strength of evidence for important outcomes in randomized controlled trials comparing sugammadex with neostigmine in adults.  </font>

```{r chofasting, include = TRUE}
## (updated 2021/05/14 08:53) cho vs. fasting kable -----------------------
soe_summary %>% 
  filter(comparison == "sug_neo") %>% 
  select(!c(comparison, n)) %>% 
  # slice(1,2,11) %>% 
    kbl(booktabs = T, align = c("lclccll"), escape = FALSE,
  col.names = c("Outcome", "(pts)", " GRADE", "ACC/AHA", "Importance^1^", "&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; Summary", "Result Detail")) %>% 
  row_spec(0, bold = TRUE) %>% 
  # row_spec(c(1, 2, 11), color = "red") %>%
  # row_spec(c(1, 2, 3), color = "red") %>%
  add_header_above(c(" " = 1, "Studies" = 1, "Strength of Evidence" = 2, " " = 1, " " = 2), line = FALSE, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>% 
  kable_classic(full_width = TRUE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "9em") %>%  
  column_spec(2, width = "5em") %>%  
  column_spec(c(3:4), width = "6em") %>% 
  column_spec(5, width = "5em") %>% 
  column_spec(6, width = "24em") %>% 
  column_spec(7, width = "7em") %>% 
  # pack_top(., "Patient Reported Outcomes", 1, 2) %>%
  footnote(general = "OR: odds ratio; SMD: standardized mean difference; MD: mean difference; CHO: carbohydrate; RCT: randomized controlled trial; NRSI: nonrandomized study of interventions.",
           number = c("● Limited, ●● Important, ●●● Critical."),
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()

```

<br/>

### GRADE Domains 

<br>

<font size = 4> Table `r table_n`. GRADE domains for strength of evidence ratings in studies comparing carbohydrate drinks with fasting in adults. </font>

```{r chofastingDomain, include = TRUE, eval = TRUE}
## (updated 2021/05/14 08:02) sug_neo_domain_summary --------------------------
sug_neo_domain_summary <- domain_summary %>%
  filter(comparison == "sug_neo") %>%
  select(-summary) %>%
  mutate(
    design = str_replace(design, "Rct", "RCT"),
    design = str_replace(design, "[Nn]rsi", "NRSI"),
    design = str_replace(design, "cohort", "Cohort"),
  )
         
# (updated 2021/05/14 07:42) get list of unique footnotes ----------------
foot_unique <- sug_neo_domain_summary %>% 
  select(ends_with("foot")) 

foot_unique <- c(t(foot_unique)) %>% 
  unlist(use.names = FALSE) %>% 
  discard(is.na) 

foot_unique <- unique(foot_unique)

numbers <- c(1:100)
sug_neo_domain <- sug_neo_domain_summary %>% 
  mutate(rob_let     = numbers[match(rob_foot, foot_unique)],
         consist_let = numbers[match(consist_foot, foot_unique)],
         direct_let  = numbers[match(direct_foot, foot_unique)],
         prec_let    = numbers[match(prec_foot, foot_unique)],
         other_let   = numbers[match(other_foot, foot_unique)],
         )

## (updated 2021/05/14 08:04) add footnotes -------------------------------
for (i in 1:nrow(sug_neo_domain)) {
  for (j in 7:11) {
    sug_neo_domain[i, j] <- ifelse(!is.na(sug_neo_domain[i, j + 10]), paste0(sug_neo_domain[i, j], "^", sug_neo_domain[i, j + 10], "^"), sug_neo_domain[i, j])
  }
}

## (updated 2021/05/14 08:27) domain summary table ------------------------
sug_neo_domain %>% 
  mutate(n_s = paste0(n_studies, " (", n_pts, ")")) %>% 
  select(outcome, design, n_s, rob, consist, direct, prec, other) %>% 
    kbl(booktabs = T, align = c("llllllll"), escape = FALSE, padding = 10, 
    col.names = c("Outcome", "Design", "N (pts)", "Bias", "Inconsistency", "Indirectness", "Imprecision", "Other")) %>% 
  row_spec(0, bold = TRUE) %>% 
  add_header_above(c(" " = 1, "Studies" = 2, "Domains" = 5), line = TRUE, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>% 
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  # row_spec(c(1, 2, 11), color = "red") %>%
  # row_spec(c(1, 2, 3), color = "red") %>%
  column_spec(1, width = "13em") %>%  
  column_spec(2, width = "4em") %>% 
  column_spec(3, width = "10em") %>% 
  column_spec(4:8, width = "8em") %>% 
  footnote(general = "RCT: randomized controlled trial; NRSI: nonrandomized study of interventions.",
           number = foot_unique,
           general_title = "",  
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<br/>



