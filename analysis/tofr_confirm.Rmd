---
title: "TOFR Confirmation (draft/preliminary)"
date: "`r format(Sys.time(), '%d %B, %Y (%H:%M)')`"
output:
  html_document:
    font: Source Sans Pro
    theme: cosmo
    anchor_sections: TRUE
    toc_float: 
      collapsed: FALSE
      smooth_scroll: TRUE
    toc_depth: 3
    linkcolor: blue
  latex_engine: xelatex
  pdf_document:
    toc: yes
    toc_depth: '3'
# bibliography: "bib/kq4.bib"
# csl: jama.csl
# link-citations: yes
workflowr:
  suppress_report: false
nocite: '@*'
---

```{=html}
<style type="text/css">
  body{
  font-size: 9.5pt;
  font-family: Source Sans Pro;
}

.caption {
  font-size: 15px;
}

.list-group-item.active, .list-group-item.active:hover, .list-group-item.active:focus {
  color: #090909;
  background-color: #0909093d;
}

.lightable-classic.lightable-hover tbody tr:hover {
    background-color: #c5d4e4;
}
.btn-xs, .btn-group-xs>.btn { 
display: none; 
}

.btn-default {
display: none !important; 
}

.popover-title {
      font-size: 12px;
  }

.popover-content {
      font-size: 12px;
  }
  
.popover-content {
    background-color: white;
    <!-- color: #FFFFFF; -->
    padding: 2px;
  }

<!-- .arrow { -->
<!--   border-right-color: red !important; -->
<!-- } -->

<!-- :target {  /* fix target location so caption appears */ -->
<!--     display: block;     -->
<!--     position: relative;      -->
<!--     top: 10px; -->
<!--     visibility: hidden; -->
<!-- } -->

</style>

<script>
$(document).ready(function(){
    $('[data-toggle="popover"]').popover({html: true, placement: top});
});
</script>
```

```{r setup, include = FALSE}
## setup ---------------------------------------------- (2022-02-14 16:17) @----
knitr::opts_chunk$set(echo = TRUE)
source("code/readfiles_nmb_102721.R")
```

```{r data}
## data/refids ---------------------------------------- (2022-02-15 10:28) @
## refids --------------------------------------------- (2022-02-21 10:31) @----
# rev refids volatile study_arm.dat 
rev_refids <- study_char.dat %>% 
  filter(rev_agt == "rev_agt") %>% 
  pull(refid) %>% 
  unique()

neo_dosing_refids <- study_arm.dat %>% 
  filter(subgroup == "neo_dosing") %>% 
  pull(refid) %>% 
  unique()

sug_dosing_refids <- study_arm.dat %>% 
  filter(subgroup == "sug_dosing") %>% 
  pull(refid) %>% 
  unique()

# note that subgroup assigned by arm
subgroup_refids <- study_arm.dat %>% 
  filter(subgroup != "none") %>% 
  pull(refid) %>% 
  unique()

# from latest distiller 2022/02/21 08:13 n=26
rnmb_dist_refids <- dichot.dat %>%
  filter(refid %in% rev_refids) %>%
  # filter(!is.na(rnmb), !refid %in% subgroup_refids) %>% # TODO: check if correct
  filter(!is.na(rnmb), age == "Adult") %>% # TODO: check if correct
  # remove single arm studies; 2022/02/21 08:52 will be Yip 2304, Alenezu 3574
  group_by(refid) %>%
  filter(n() >= 2) %>%
  ungroup() %>%
  select(refid) %>%
  distinct() %>%
  pull()

# temp <- study_arm_rev.dat %>% 
#   filter(refid %in% rnmb_dist_refids_wsub) %>% 
#   mutate(subgroup = ifelse(refid %notin% rnmb_dist_refids, "subgroup", NA)) %>% 
#   relocate(subgroup, .after = refid)
# 
# write_csv(temp, "/Users/mgrant/Desktop/temp.csv", na = "")

## data char, arm, dichot ----------------------------- (2022-02-21 10:32) @----
study_char_rev.dat <- study_char.dat %>%
  filter(refid %in% rev_refids) 

study_arm_rev.dat <- study_arm.dat %>%
  filter(refid %in% rev_refids) %>%
  mutate(
    study = case_when(
      study == "Wu 2014" & arm_n < 50 ~ "Wu 2014 (Caucasian)",
      study == "Wu 2014" & arm_n >= 50 ~ "Wu 2014 (Chinese)",
      TRUE ~ study
    ),
    arm = case_when(
      revagent %in% c("neo") ~ "Neo",
      revagent %in% c("sug") ~ "Sug",
      str_detect(study_arm_k, "pont") ~ "Spont",
      revagent %in% c("other_agent") ~ revother,
      TRUE ~ "Other"
    ),
    arm = ifelse(str_detect(arm, "lacebo|saline"), "Plac", arm),
    arm = ifelse(str_detect(arm, "yridostigmine"), "Pyrid", arm),
    arm = factor(arm, levels = c("Sug", "Neo", "Plac", "Spont", "Pyrid", "Other"), ordered = TRUE),
    volatile = if_any(c(an_isoflurane, an_sevoflurane, an_desf, an_hal), ~ !is.na(.))
  ) %>%
  select(refid, arm_id, study, year, design, arm_n, arm, age, study_arm_k, subgroup, depth, depth_rev_f, starts_with("depth_rev_"), anesth:anes_agent_spec, neo_dose, neo_max_dose, neo_dose_unit, sug_dose, sug_dose_max, nmbagent, gen_type, revtim, revtim_comment, mon_cat, mon_cat_f)

dichot_rev.dat <- dichot.dat %>%
  mutate(
    study = case_when(
      study == "Wu 2014" & arm_n < 50 ~ "Wu 2014 (Caucasian)",
      study == "Wu 2014" & arm_n >= 50 ~ "Wu 2014 (Chinese)",
      TRUE ~ study
    )
  )

# study_arm_rev.dat %>% tabyl(depth_rev_f)
```

```{r rnmbData, echo = FALSE}
## rnmb.dat ------------------------------------------- (2022-02-21 09:00) @----
# add subgroup studies with relevant main effects
# Martinez-Ubieto 2016; need to combine spontaneous arms
rnmb_dist_refids <- sort(unique(c(rnmb_dist_refids, 2896)))

study_arm_rnmb.dat <- study_arm_rev.dat %>% 
  filter(refid %in% rnmb_dist_refids) %>% 
  select(refid, arm_id, study, subgroup, year, arm, study_arm_k, starts_with("depth_rev"), mon_cat, mon_cat_f, neo_dose, neo_max_dose, neo_dose_unit, sug_dose, sug_dose_max, arm_n, nmbagent, gen_type, revtim, revtim_comment)

dichot_rnmb.dat <- dichot_rev.dat %>% 
  filter(refid %in% rnmb_dist_refids) %>% 
  select(refid, study, arm_id, rnmb1_dev, rnmb1_clinical, rnmb1_where, rnmb2_dev, rnmb2_clinical, rnmb2_where, rnmb, rnmb1_n, rnmb1_per, rnmb1_7, rnmb1_8, rnmb1_9, rnmb1_1, rnmb1_clinical, rnmb2_n, rnmb2_per, rnmb2_7, rnmb2_8, rnmb2_9, rnmb2_1, rnmb2_clinical)

rnmb.dat <- left_join(study_arm_rnmb.dat, dichot_rnmb.dat, by = c("refid", "study", "arm_id"))

study_char_rnmb.dat <- study_char_rev.dat %>%
  filter(refid %in% rnmb_dist_refids) %>% 
  select(refid, study_l, age, design)

rnmb.dat <- left_join(rnmb.dat, study_char_rnmb.dat, by = c("refid")) %>%
  relocate(c(study_l, age, design, year), .before = study) %>% 
  filter(refid %in% rnmb_dist_refids) 

tofr_confirm <- study_arm.dat %>% 
group_by(refid) %>%
  slice(1) %>%
  select(refid, extbconf, tofrext) %>%
  mutate(extbconf = case_when(
    extbconf == "yes" ~ "TOFR confirmed",
    extbconf == "no" ~ "TOFR not confirmed",
    extbconf == "ns" ~ "Not stated"
  ),
  tofr = case_when(
    str_detect(tofrext, "1") ~ '1.0',
    str_detect(tofrext, "9") ~ "0.9",
    str_detect(tofrext, "8") ~ "0.8",
    str_detect(tofrext, "7") ~ "0.7",
    str_detect(tofrext, "ns") ~ "NS",
  ))

rnmb.dat <- left_join(rnmb.dat, tofr_confirm, by = "refid")

rnmb_meta_distiller.dat <- rnmb.dat %>%
  filter(!is.na(extbconf), !is.na(rnmb1_9) | !is.na(rnmb2_9) | !is.na(rnmb1_1) | !is.na(rnmb2_1)) %>%
  filter(arm %in% c("Sug", "Neo", "Spont", "Plac")) %>%
  mutate(rnmb_n = case_when(
    !is.na(rnmb1_9) ~ rnmb1_n,
    !is.na(rnmb2_9) ~ rnmb2_n,
    !is.na(rnmb1_1) ~ rnmb1_n,
    !is.na(rnmb2_1) ~ rnmb2_n,
    ),
    extbconf = factor(extbconf, levels = c("TOFR confirmed", "TOFR not confirmed", "Not stated"))
  ) %>% 
  select(refid, study, design, arm, arm_n, rnmb_n, extbconf, tofr, depth_rev_f) %>% 
  arrange(extbconf, depth_rev_f)
```

```{r rnmbDataUpate, echo = FALSE}
## rnmbDataUpate -------------------------------------- (2022-03-19 17:44) @----
endnote <- read.csv("data/nmb_endnote.csv") %>% 
  mutate(study = paste(author, year),
         study = str_replace(study, "^\\s", "")) %>% 
  select(refid, study, year)

ext_confirm_temp <- readxl::read_xlsx("data/Extubationconfirm_031722_mg.xlsx", sheet = "TOFR Confirm", range = "A1:Q97") %>%
  clean_names() %>%
  left_join(., endnote, by = "refid") %>%
  relocate(c(study, year), .after = refid) %>%
  mutate(
    rnmb_n = as.numeric(str_extract(rnmb_np, "^\\d{1,3}")),
    tofr_conf = factor(tofr_confirm, levels = c("Yes", "No", "NS", "PNS"), labels = c("Yes", "No", "Not stated", "PNS")),
    tofr_conf_comb = fct_collapse(tofr_conf, No = c("No", "PNS")),
    volatile = case_when(
      str_detect(anesth, "Vol") ~ "Volatile",
      str_detect(anesth, "NS") ~ "NS/Missing",
      anesth == "TIVA" ~ "TIVA alone",
      is.na(anesth) ~ "NS/Missing",
  ), 
    rnmb_def_comb = case_when(
      str_detect(rnmb_def, "0.9") ~ "0.9",
      str_detect(rnmb_def, "0.8") ~ "0.8",
      str_detect(rnmb_def, "0.7") ~ "0.7",
      str_detect(rnmb_def, "NS") ~ "NS",
    )
  ) %>%
  select(refid, study, year, rev_agent, rnmb_n, arm_n, volatile, monitor, tofr_conf, tofr_conf_comb, tofr_ext, rnmb_def, rnmb_def_comb, rnmb_monitor, depth) %>%
  rename(arm = rev_agent)

# ext_confirm_temp %>% tabyl(depth)

# ext_confirm_temp %>%
#   tabyl(tofr_conf_comb, tofr_ext)

# compare with distiller

```

## TOFR ≥ 0.9 Before Extubation

### Sugammadex

<a id="kq4Fig1"></a>

<br/>

<font size = 4> Figure `r figure_n`. Incidence of residual neuromuscular block (TOFR \<0.9) in randomized and nonrandomized studies among patients given sugammadex according to whether TOFR was reported as confirmed (all ≥ 0.9) prior to extubation.  </font>

```{r rnmbMetaTofrSug, fig.align = 'left', fig.width = 11, fig.height = 9.5}
## rnmbMetaConfirm 0.9 -------------------------------- (2022-03-20 09:36) @----
conf_meta_9 <- ext_confirm_temp %>% 
  filter(tofr_ext == "0.9" | tofr_conf_comb %in% c("No", "Not stated")) %>% 
  filter(rnmb_def_comb == 0.9) %>% 
  mutate(extb_conf_r = case_when(
    tofr_conf_comb == "Yes" ~ "TOFR ≥0.9 confirmed",
    tofr_conf_comb == "No" ~ "TOFR not confirmed",
    tofr_conf_comb == "Not stated" ~ "Not stated"
  )) %>% 
  select(refid, study, arm, arm_n, rnmb_n, extb_conf_r, depth, volatile)
  
# from distiller 0.9 rnmb defn and confirm level
temp <- rnmb_meta_distiller.dat %>%
  filter(refid %notin% ext_confirm_temp$refid) %>%
  select(-design) %>%
  mutate(
    arm_n = case_when(
      study == "Della Rocca 2013" & arm == "Sug" ~ 207,
      study == "Della Rocca 2013" & arm == "Neo" ~ 150,
      TRUE ~ arm_n
    ),
    rnmb_n = case_when(
      study == "Della Rocca 2013" & arm == "Sug" ~ 4,
      study == "Della Rocca 2013" & arm == "Neo" ~ 47,
      TRUE ~ rnmb_n
    ),
    extb_conf_r = ifelse(extbconf == "TOFR confirmed", "TOFR ≥0.9 confirmed", extbconf),
    depth = firstup(as.character(depth_rev_f)),
    volatile = ifelse(study == "Della Rocca 2013", "Volatile", "TIVA alone")
  ) %>% 
  group_by(study, arm) %>% 
  slice(1) %>% 
  ungroup() %>% 
  select(-c(extbconf, tofr, depth_rev_f)) %>% 
  relocate(extb_conf_r, .before = depth)

conf_meta_9 <- conf_meta_9 %>% 
  bind_rows(., temp) %>% 
  mutate(year = as.numeric(str_extract(study, "\\d{4}")),
         extb_conf_r = factor(extb_conf_r, levels = c("TOFR ≥0.9 confirmed", "TOFR not confirmed", "Not stated")),
         study = ifelse(study == "Wu 2014" & arm_n > 100, "Wu 2014 (Chinese)", study),
         study = ifelse(study == "Wu 2014" & arm_n < 100, "Wu 2014 (Caucasian)", study),
         ) %>% 
  arrange(depth, year) %>% 
  distinct()
  
# conf_meta_9 %>% tabyl(tofr_conf_comb, tofr_ext)

rnmb_meta <- metaprop(rnmb_n, arm_n, 
  data = conf_meta_9,
  studlab = study,
  sm = "PAS",
  # method.tau = "PAS",
  hakn = FALSE,
  prediction = FALSE,
  subset = arm == "Sug",
  # subset = arm == "Sug" & extb_conf_r != "Not stated",
  # subset = arm == "Sug" & study != "Alday 2019",
  subgroup = extb_conf_r)

# dmetar::find.outliers(rnmb_meta)

forest(rnmb_meta,
  fixed = FALSE,
  rightcols = c("effect", "ci", "depth"),
  rightlabs = c("Incidence", "(95% CI)", "Depth @ Reversal"),
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  pooled.events = TRUE,
  subgroup = TRUE,
  print.subgroup.name = FALSE,
  text.subgroup.nohet = TRUE,
  colgap.forest.left = "30mm",
  just.addcols.right = "left",
  xlim = c(0, 0.8),
  xlab = "Incidence TOFR <0.9"
  )

# grid::grid.text("Sugammadex", 0.02, .99, just = "left", gp = grid::gpar(cex = 1.2, fontface = "bold"))

figure_n <- fig_inc()
```
Mod: moderate; Min: minimal; Oth: other; NS: not stated.<br/>
Excluding Alday 2019 (an outlier) yielded a pooled result of for not cofirmed of 0.03 (95% CI: 0.01, 0.06) and overall 0.02 (95% CI: 0.00, 0.03). Difference between confirmed and not confirmed p = 0.052.

<br/>

### Neostigmine

<br/>

<font size = 4> Figure `r figure_n`. Incidence of residual neuromuscular block (TOFR \<0.9) in randomized and nonrandomized studies among patients given neostigmine according to whether TOFR was reported as confirmed (all ≥ 0.9) prior to extubation.  </font>

```{r rnmbMetaTofrNeo, fig.width = 11, fig.height = 11.5}
## rnmbMetaTofrNeo ------------------------------------- (2022-03-20 12:01) @----
rnmb_meta <- metaprop(rnmb_n, arm_n, 
  data = conf_meta_9,
  studlab = study,
  sm = "PAS",
  # method.tau = "PAS",
  hakn = FALSE,
  prediction = FALSE,
  subset = arm == "Neo",
  # subset = arm == "Neo" & extb_conf_r != "Not stated",
  subgroup = extb_conf_r)

forest(rnmb_meta,
  fixed = FALSE,
  rightcols = c("effect", "ci", "depth"),
  rightlabs = c("Incidence", "(95% CI)", "Depth @ Reversal"),
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  pooled.events = TRUE,
  subgroup = TRUE,
  print.subgroup.name = FALSE,
  text.subgroup.nohet = TRUE,
  colgap.forest.left = "30mm",
  just.addcols.right = "left",
  xlim = c(0, 0.8),
  xlab = "Incidence TOFR <0.9"
  )
# grid::grid.text("Neostigmine", 0.02, .99, just = "left", gp = grid::gpar(cex = 1.2, fontface = "bold"))

figure_n <- fig_inc()
```
Mod: moderate; Min: minimal; Shall: shallow; Oth: other; NS: not stated.<br/>
Difference between confirmed and not confirmed p < 0.0001.

<br/>

### Neostigmine (volatile anesthetic)

<br/>

<font size = 4> Figure `r figure_n`. Incidence of residual neuromuscular block (TOFR \<0.9) in randomized and nonrandomized studies among patients given neostigmine and volatile anesthetic according to whether TOFR was reported as confirmed (all ≥ 0.9) prior to extubation.  </font>

```{r rnmbMetaTofrNeoVolatile, fig.width = 11, fig.height = 8.4, fig.align = 'left'}
## rnmbMetaTofrNeo ------------------------------------- (2022-03-20 12:01) @----
rnmb_meta <- metaprop(rnmb_n, arm_n, 
  data = conf_meta_9,
  studlab = study,
  sm = "PAS",
  # method.tau = "PAS",
  hakn = FALSE,
  prediction = FALSE,
  subset = arm == "Neo" & volatile == "Volatile", 
  subgroup = extb_conf_r)

forest(rnmb_meta,
  fixed = FALSE,
  # label.e = "Sugammadex",
  # label.c = "Neostigmine",
  rightcols = c("effect", "ci", "depth"),
  rightlabs = c("Incidence", "(95% CI)", "Depth @ Reversal"),
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  pooled.events = TRUE,
  subgroup = TRUE,
  print.subgroup.name = FALSE,
  text.subgroup.nohet = TRUE,
  colgap.forest.left = "30mm",
  just.addcols.right = "left",
  xlim = c(0, 0.8),
  xlab = "Incidence TOFR <0.9"
)

# grid::grid.text("Neostigmine", 0.02, .99, just = "left", gp = grid::gpar(cex = 1.2, fontface = "bold"))

figure_n <- fig_inc()
```
Mod: moderate; Min: minimal; Shall: shallow; Oth: other; NS: not stated.

<br/>

### Neostigmine (TIVA, no volatiles)

<br/>

<font size = 4> Figure `r figure_n`. Incidence of residual neuromuscular block (TOFR \<0.9) in randomized and nonrandomized studies among patients given neostigmine and no volatile anesthetic according to whether TOFR was reported as confirmed (all ≥ 0.9) prior to extubation.  </font>

```{r rnmbMetaTofrNeoNoVolatile, fig.width = 10.5, fig.height = 6.2}
## rnmbMetaTofrNeo ------------------------------------- (2022-03-20 12:01) @----
rnmb_meta <- metaprop(rnmb_n, arm_n, 
  data = conf_meta_9,
  studlab = study,
  sm = "PAS",
  # method.tau = "PAS",
  hakn = FALSE,
  prediction = FALSE,
  subset = arm == "Neo" & volatile == "TIVA alone", 
  subgroup = extb_conf_r)

forest(rnmb_meta,
  fixed = FALSE,
  # label.e = "Sugammadex",
  # label.c = "Neostigmine",
  rightcols = c("effect", "ci", "depth"),
  rightlabs = c("Incidence", "(95% CI)", "Depth @ Reversal"),
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  pooled.events = TRUE,
  subgroup = TRUE,
  print.subgroup.name = FALSE,
  text.subgroup.nohet = TRUE,
  colgap.forest.left = "30mm",
  just.addcols.right = "left",
  xlim = c(0, 0.8),
  xlab = "Incidence TOFR <0.9"
  )

# grid::grid.text("Neostigmine", 0.02, .99, just = "left", gp = grid::gpar(cex = 1.2, fontface = "bold"))

figure_n <- fig_inc()
```
Mod: moderate; Min: minimal; Shall: shallow; Oth: other; NS: not stated.



