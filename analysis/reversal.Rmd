---
title: "Reversal"
date: "`r format(Sys.time(), '%d %B, %Y (%H:%M)')`"
output:
  html_document:
    font: Source Sans Pro
    theme: cosmo
    anchor_sections: TRUE
    toc_float: 
      collapsed: FALSE
      smooth_scroll: TRUE
    toc_depth: 3
    linkcolor: blue
  latex_engine: xelatex
  pdf_document:
    toc: yes
    toc_depth: '3'
bibliography: "bib/kq4.bib"
csl: jama.csl
link-citations: no
workflowr:
  suppress_report: false
nocite: '@*'
---

```{=html}
<style type="text/css">
  body{
  font-size: 9.5pt;
  font-family: Source Sans Pro;
}

.caption {
  font-size: 15px;
}

.list-group-item.active, .list-group-item.active:hover, .list-group-item.active:focus {
  color: #090909;
  background-color: #0909093d;
}

.lightable-classic.lightable-hover tbody tr:hover {
    background-color: #c5d4e4;
}
.btn-xs, .btn-group-xs>.btn { 
display: none; 
}

.btn-default {
display: none !important; 
}

.popover-title {
      font-size: 12px;
  }

.popover-content {
      font-size: 12px;
  }
  
.popover-content {
    background-color: white;
    <!-- color: #FFFFFF; -->
    padding: 2px;
  }

<!-- .arrow { -->
<!--   border-right-color: red !important; -->
<!-- } -->

:target {  /* fix target location so caption appears */
    display: block;
    position: relative;
    top: -25px;
    visibility: hidden;
}

</style>

<script>
$(document).ready(function(){
    $('[data-toggle="popover"]').popover({html: true, placement: top});
});
</script>
```

```{r setup, include = FALSE}
## setup ---------------------------------------------- (2022-02-14 16:17) @----
knitr::opts_chunk$set(echo = TRUE)
source("code/readfiles_nmb_102721.R")
```

```{r data}
## data/refids ---------------------------------------- (2022-02-15 10:28) @
## refids --------------------------------------------- (2022-02-21 10:31) @----
# rev refids volatile study_arm.dat 
rev_refids <- study_char.dat %>% 
  filter(rev_agt == "rev_agt") %>% 
  pull(refid) %>% 
  unique()

neo_dosing_refids <- study_arm.dat %>% 
  filter(subgroup == "neo_dosing") %>% 
  pull(refid) %>% 
  unique()

sug_dosing_refids <- study_arm.dat %>% 
  filter(subgroup == "sug_dosing") %>% 
  pull(refid) %>% 
  unique()

# note that subgroup assigned by arm
subgroup_refids <- study_arm.dat %>% 
  filter(subgroup != "none") %>% 
  pull(refid) %>% 
  unique()

# from latest distiller 2022/02/21 08:13 n=26
rnmb_dist_refids <- dichot.dat %>%
  filter(refid %in% rev_refids) %>%
  filter(!is.na(rnmb), !refid %in% subgroup_refids) %>%
  # remove single arm studies; 2022/02/21 08:52 will be Yip 2304, Alenezu 3574
  group_by(refid) %>%
  filter(n() >= 2) %>%
  ungroup() %>%
  select(refid) %>%
  distinct() %>%
  pull()

## from spreadsheet ----------------------------------- (2022-02-22 14:32) @----
# rcts only from spreadsheet 2022/02/21 08:04 n=21 (checked same in excel sheet) 
rnmb_ma.dat <- suppressMessages(read_csv("data/rnmb_read_011322.csv")) %>% 
  clean_names() %>% 
  filter(!is.na(arm)) %>% 
  fill(refid, study) %>% 
  remove_empty(which = "cols") %>% 
  mutate(
    study_orig = study,
    study = str_extract(study, "\\w*.{0,1}\\w* \\d{4}"),
    mg_kg = ifelse(is.na(mg_kg) & !is.na(mg), paste0("<u>", mg, "</u>"), mg_kg),
    refid = suppressWarnings(as.numeric(refid))
  ) %>% 
  select(-mg) # milligram can delete

## data char, arm, dichot ----------------------------- (2022-02-21 10:32) @----
study_char_rev.dat <- study_char.dat %>%
  filter(refid %in% rev_refids) 

study_arm_rev.dat <- study_arm.dat %>%
  filter(refid %in% rev_refids) %>%
  mutate(
    study = case_when(
      study == "Wu 2014" & arm_n < 50 ~ "Wu 2014 (Caucasian)",
      study == "Wu 2014" & arm_n >= 50 ~ "Wu 2014 (Chinese)",
      TRUE ~ study
    ),
    arm = case_when(
      revagent %in% c("neo") ~ "Neo",
      revagent %in% c("sug") ~ "Sug",
      str_detect(study_arm_k, "pont") ~ "Spont",
      revagent %in% c("other_agent") ~ revother,
      TRUE ~ "Other"
    ),
    arm = ifelse(str_detect(arm, "lacebo|saline"), "Plac", arm),
    arm = ifelse(str_detect(arm, "yridostigmine"), "Pyrid", arm),
    arm = factor(arm, levels = c("Sug", "Neo", "Plac", "Spont", "Pyrid", "Other"), ordered = TRUE),
    volatile = if_any(c(an_isoflurane, an_sevoflurane, an_desf, an_hal), ~ !is.na(.))
  ) %>%
  select(refid, arm_id, study, year, design, arm_n, arm, age, study_arm_k, subgroup, depth, starts_with("depth_rev_"), anesth:anes_agent_spec, neo_dose, neo_max_dose, neo_dose_unit, sug_dose, sug_dose_max, nmbagent, gen_type, revtim, revtim_comment, mon_cat, mon_cat_f, volatile)

depth_rev.dat <- study_arm_rev.dat %>% 
  select(refid, arm, arm_n, depth_rev_f, volatile) %>% 
  rename(arm_dist = arm) # rename to join with spreadsheet that includes subgroup

dichot_rev.dat <- dichot.dat %>%
  mutate(
    study = case_when(
      study == "Wu 2014" & arm_n < 50 ~ "Wu 2014 (Caucasian)",
      study == "Wu 2014" & arm_n >= 50 ~ "Wu 2014 (Chinese)",
      TRUE ~ study
    )
  )

# study_arm_rev.dat %>% tabyl(depth)

## comparators ---------------------------------------- (2022-02-21 10:32) @----
comparators <- study_arm_rev.dat %>% 
  # filter(design == "rct") %>% 
  arrange(year) %>% 
  select(refid, study, design, subgroup, arm_id, arm, age) %>% 
  pivot_wider(id_cols = c(refid, study, design, subgroup), names_from = arm, values_from = arm_id, values_fn = list) %>% 
  select(refid:design, subgroup, Sug, Neo, Plac, Spont, Pyrid, Other) %>% 
  mutate(across(Sug:Other, ~ as.numeric(. != "NULL"))) %>% 
  mutate(across(Sug:Other, ~ as.character(.))) %>% 
  mutate(across(Sug:Other, ~ ifelse(. == "1", cur_column(), ""))) %>% 
  mutate(compare = str_c(Sug, Neo, Plac, Spont, Pyrid, sep = ":"),
         compare = str_replace_all(compare, ":{2,3}", ":"),
         compare = str_replace(compare, "^:", ""),
         compare = str_replace_all(compare, ":{1,3}$", ""))

# subgroups with comparators
comp_subgroup <- comparators %>% 
  filter(subgroup != "none", str_detect(compare, ":")) 

rct_nosub_comp <- comparators %>% 
  filter(design == "rct", refid %notin% subgroup_refids) 

## comparators by arm --------------------------------- (2022-02-21 13:33) @----
comp_rct_arm <- study_arm_rev.dat %>% 
  mutate(study = case_when(
    study == "Wu 2014" & arm_n < 50 ~ "Wu 2014 (Caucasian)",
    study == "Wu 2014" & arm_n >= 50 ~"Wu 2014 (Chinese)",
    TRUE ~ study)) %>% 
  filter(design == "rct", refid %notin% subgroup_refids) %>% 
  arrange(year) %>% 
  select(refid, study, design, subgroup, arm_id, arm, arm_n, age) %>% 
  mutate(event_placeholder = 1)

## netmeta code --------------------------------------- (2022-02-21 14:08) @----
# library(netmeta)  
# pairs.dat <- pairwise(
#   treat = arm,
#   event = event_placeholder, 
#   n = arm_n,
#   studlab = study,
#   data = comp_rct_arm,
#   sm = "RR"
# )
# 
# # trts <- c("Clinical", "Qualitative", "Quantitative")
# 
# nmm_netmeta_nma <- netmeta(
#   pairs.dat,
#   random = TRUE,
#   # backtransf = TRUE,
#   # prediction = TRUE,
#   # seq = trts,
#   sm = "RR",
#   reference.group = "Spont"
# )
```

```{r checks, eval = FALSE}
## checkRefids TEMP ----------------------------------- (2022-02-21 09:17) @----
rnmb_ma_refids <- rnmb_ma.dat %>% 
  select(refid) %>% 
  distinct() %>% 
  pull()
  
# check in distiller pull
# refids 2834, 3491, 4997 appear to be missing
# 2304 and 3574 are single arm
# rnmb_ma_refids %in% rev_refids
# rnmb_ma_refids[!rnmb_ma_refids %in% rnmb_dist_refids]
# rnmb_dist_refids[!rnmb_dist_refids %in% rnmb_ma_refids]
## rnmb_dist_refids ----------------------------------- (2022-02-21 08:59) @----
rnmb_ma.dat %>% 
  select(refid, study, arm, deep:ns_depth)

temp_depth_rev <- study_arm_rev.dat %>% 
  filter(refid %in% rnmb_dist_refids) %>% 
  select(refid, study, arm, depth_rev_f) %>% 
  mutate(check = 1) %>% 
  pivot_wider(id_cols = c(refid, study, arm), names_from = depth_rev_f, values_from = check)
```

# **Included Studies**

<font size = 4> Table `r table_n`. Number of included studies according to age and design. </font>

```{r tablesIncluded, include = TRUE, echo = FALSE}
## tablesIncluded ------------------------------------- (2022/04/02 14:49) @----
# list of studies, age, surgical/non surgical, design 
study_char.dat %>% 
  filter(refid %in% rev_refids) %>% 
  group_by(age, design, .drop = TRUE) %>%
  summarise(total = n()) %>%
  ungroup() %>%
  arrange(age, design) %>%
  group_by(age, .drop = TRUE) %>%
  mutate(row = row_number()) %>%
  ungroup() %>%
  janitor::adorn_totals("row") %>%
  mutate(
    age = ifelse(row != 1, NA, age),
    design = case_when(
      design == "rct" ~ "RCT",
      design == "quasiexp" ~ "Before-After/Time Series",
      design == "cluster" ~ "Cluster Randomized",
      design == "nrsi" ~ "Nonrandomized Trial",
      design == "prospect_coh" ~ "Prospective Cohort",
      design == "retrospect_coh" ~ "Retrospective Cohort",
      design == "casecontrol" ~ "Case-Control",
      design == "other" ~ "Before-After",
      design == "fully_paired" ~ "Fully Paired"),
      age = ifelse(row_number() == n(), "Total", age)
  ) %>%
  select(age, design, total) %>%
  kbl(
    booktabs = T, align = c("llr"),
    col.names = c("Age", "Design", "N")
  ) %>%
  row_spec(c(0, 11), bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "8em") %>%
  column_spec(2, width = "14em") %>%
  column_spec(3, width = "3em") %>% 
  footnote(
    general = "RCT: randomized controlled trial.",
    # alphabet = c("Footnote a", "Footnote b", ...),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

<font size = 4>  Figure `r figure_n`. Comparators in randomized controlled trials in adult and pediatric populations. </font>

``` {r rctComparatorsPlots, include = TRUE, out.width="80%"}
## network plot --------------------------------------- (2022-02-21 14:07) @----
comp_rct_arm_adult <- comp_rct_arm %>% 
  group_by(refid) %>% 
  filter(n() > 1) %>% 
  ungroup() %>% 
  filter(age == "Adult") %>% 
  slice(1:108)

comp_rct_arm_peds<- comp_rct_arm %>% 
  filter(age == "Pediatric")

nmm.data <- BUGSnet::data.prep(
  arm.data = comp_rct_arm_adult,
  varname.t = "arm",
  varname.s = "study"
)

BUGSnet::net.plot(nmm.data,
  node.scale = 0.8,
  edge.scale = .5,
  # label.offset2 = 3,
  # label.offset1 = 8,
  study.counts = TRUE,
  # node.lab.cex = 1,
  # edge.lab.cex = 1.2
)

title("Adult")

nmm.data <- BUGSnet::data.prep(
  arm.data = comp_rct_arm_peds,
  varname.t = "arm",
  varname.s = "study"
)

BUGSnet::net.plot(nmm.data,
  node.scale = 0.8,
  edge.scale = .5,
  # label.offset2 = 3,
  # label.offset1 = 8,
  study.counts = TRUE,
  # node.lab.cex = 1,
  # edge.lab.cex = 1.2
)

title("Pediatric")

figure_n <- fig_inc()

```

## *Design, centers, country, surgery*

<br/>

<font size = 4> Table `r table_n`. Study design, enrollment, centers, country, and surgery (see [References](#references) for citations). </font>

```{r studiesIncludedList, echo = FALSE, include = TRUE}
## studiesIncluded ------------------------------------ (2022-04-02 14:55) @----
# study_char_rev.dat %>%
#   filter(rev_agt == "rev_agt") %>%
#   arrange(age, design, study) %>%
#   select(study, refid, age, design) %>%
#   group_by(age, design) %>%
#   tally() %>%
#   ungroup() %>%
#   mutate(
#     end = cumsum(n),
#     start = end - n + 1
#   ) %>%
#   select(age, design, start, end)

included_studies.dat <- study_char_rev.dat %>%
  mutate(
    across(surg_various:surg_other, ~ str_replace(.x, "surg_", "")),
    across(surg_various:surg_other, ~ str_c(.x, ", ")),
    across(surg_various:surg_other, ~ firstup(.x)),
    across(surg_various:surg_other, ~ replace_na(.x, "")),
    surg_list = ifelse(grepl("abdom", surg_list), "Abdominal, ", ""),
    surgs = str_c(surg_various, surg_car, surg_cr, surg_gyn, surg_gi, surg_gen, surg_headneck, surg_hep, surg_neuro, surg_opth, surg_oralmax, surg_ortho, surg_otolar, surg_plastic, surg_thor, surg_urol, surg_list),
    surgs = str_replace(surgs, "Otolar", "ENT"),
    surgs = str_replace(surgs, "Headneck", "ENT"),
    surgs = str_sub(surgs, 1, nchar(surgs) - 2),
    country = ifelse(grepl("USA", country), "USA", country),
    country = ifelse(grepl("UK", country), "UK", country),
    country = ifelse(!is.na(non_vh_hdi), str_c(country, "^a^"), country)
  ) %>%
  select(refid, study_l, year, age, design, n_analyze, country, centers, non_vh_hdi, surgs) %>%
  arrange(age, design, year)

## kable ---------------------------------------------- (2022-04-02 14:55) @----
included_studies.dat %>% 
  select(refid, study_l, n_analyze, centers, country, surgs) %>% 
  kbl(
    booktabs = T, align = c("llccll"), escape = TRUE, # format = "latex",
    col.names = c("            ID", "Study", "Analyzed (N)", "Centers", "Country^a^", "Surgery")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "6em") %>%
  column_spec(2, width = "10em") %>%
  column_spec(3, width = "6em") %>%
  column_spec(4, width = "6em") %>%
  column_spec(5, width = "10em") %>%
  column_spec(6, width = "25em") %>%
  pack_top(., "Adult",                      1, 165) %>%
  pack_sub(., "RCT",                        1, 121) %>% 
  pack_sub(., "Before-After/Time Series", 122, 123) %>% 
  pack_sub(., "Nonrandomized Trial",      124, 134) %>% 
  pack_sub(., "Prospective Cohort",       135, 156) %>% 
  pack_sub(., "Retrospective Cohort",     157, 165) %>% 
  pack_top(., "All ages",                 166, 172) %>% 
  pack_sub(., "RCT",                      166, 169) %>% 
  pack_sub(., "Retrospective Cohort",     170, 172) %>% 
  pack_top(., "Pediatric",                173, 188) %>%
  pack_sub(., "RCT",                      173, 184) %>% 
  pack_sub(., "Prospective Cohort",       185, 187) %>% 
  pack_sub(., "Case-control",             188, 188) %>% 
  footnote(
    general = "RCT: randomized controlled trial; Car: cardiac; GI: gastrointestinal; Ortho: orthopedic; Abdom: abdominal; ENT: otolaryngology (ear, nose, and throat); Gyn: gynecologic; Urol: urologic; Neuro: neurological; Hep: hepatic; Thor: thoracic; Oralmax: oral maxillofacial.",
    alphabet = c(
      "Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
rm(temp)
```

# **Outcomes**

<br/>

## *Residual Neuromuscular Block (TOFR/Clinical)*

```{r rnmbData, echo = FALSE}
## rnmbData_ma_sheet ---------------------------------- (2022-02-15 11:25) @----
rnmb_depth <- rnmb_ma.dat %>%
  select(refid, study, study_orig, arm, n, deep:ns_depth) %>%
  mutate(across(deep:ns_depth, ~ ifelse(. == "x", cur_column(), ""))) %>%
  unite(., col = "depth_rev_ma_f", deep:ns_depth, sep = ":", remove = FALSE, na.rm = TRUE) %>%
  mutate(
    depth_rev_ma_f = factor(depth_rev_ma_f, levels = c("deep", "deep:mod", "deep:mod:shallow", "mod", "mod:shallow", "mod:shallow:min", "min", "shallow", "clincrit", "endsurg", "oth", "ns")),
    study = study_orig
  ) %>%
  rename(arm_n = n) %>%
  select(c(-study_orig))

## rnmb.dat ------------------------------------------- (2022-02-21 09:00) @----
# add subgroup studies with relevant main effects
# Martinez-Ubieto 2016; need to combine spontaneous arms
rnmb_dist_refids <- sort(unique(c(rnmb_dist_refids, 2896)))

study_arm_rnmb.dat <- study_arm_rev.dat %>% 
  filter(refid %in% rnmb_dist_refids) %>% 
  select(refid, arm_id, study, subgroup, year, arm, study_arm_k, starts_with("depth_rev"), mon_cat, mon_cat_f, neo_dose, neo_max_dose, neo_dose_unit, sug_dose, sug_dose_max, arm_n, nmbagent, gen_type, revtim, revtim_comment)

dichot_rnmb.dat <- dichot_rev.dat %>% 
  filter(refid %in% rnmb_dist_refids) %>% 
  select(refid, study, arm_id, rnmb1_dev, rnmb1_clinical, rnmb1_where, rnmb2_dev, rnmb2_clinical, rnmb2_where, rnmb, rnmb1_n, rnmb1_per, rnmb1_7, rnmb1_8, rnmb1_9, rnmb1_1, rnmb1_clinical, rnmb2_n, rnmb2_per, rnmb2_7, rnmb2_8, rnmb2_9, rnmb2_1, rnmb2_clinical)

rnmb.dat <- left_join(study_arm_rnmb.dat, dichot_rnmb.dat, by = c("refid", "study", "arm_id"))

study_char_rnmb.dat <- study_char_rev.dat %>%
  filter(refid %in% rnmb_dist_refids) %>% 
  select(refid, study_l, age, design)

rnmb.dat <- left_join(rnmb.dat, study_char_rnmb.dat, by = c("refid")) %>%
  relocate(c(study_l, age, design, year), .before = study) %>% 
  filter(refid %in% rnmb_dist_refids) 

rnmb.dat <- left_join(rnmb.dat, rnmb_depth, by = c("refid", "study", "arm", "arm_n"))
  
# depth_freq <- proc_freq(rnmb.dat, depth, depth_rev_f)
# write_csv(depth_freq, "/Users/mgrant/Desktop/depth_freq.csv", na = "")
# depth_compare <- rnmb.dat %>% 
#   select(refid, study, depth_rev_f, depth)
# write_csv(depth_compare, "/Users/mgrant/Desktop/depth_compare.csv", na = "")
# 3 refids (2834 3491 4997) to be added 2022/02/21 17:01
# rnmb_dist_refids[rnmb_dist_refids %notin% rnmb_ma.dat$refid]

rm(study_arm_rnmb.dat, dichot_rnmb.dat, study_char_rnmb.dat)

## table ---------------------------------------------- (2022-02-21 17:35) @----
temp <- rnmb.dat %>%
  mutate(
    # dose_comb = neo_dose,
    dose_comb = case_when(
      arm == "Neo" ~ ifelse(!is.na(neo_dose + neo_max_dose), paste0(neo_dose, "-", neo_max_dose), as.character(neo_dose)),
      arm == "Sug" ~ ifelse(!is.na(sug_dose + sug_dose_max), paste0(sug_dose, "-", sug_dose_max), as.character(sug_dose)),
    ),
    dose_comb = ifelse(neo_dose_unit %in% c("mg"), paste0("<u>", dose_comb, "</u>"), dose_comb),
    nmb_agent = ifelse(is.na(nmbagent), "NS", nmbagent),
    tiva = ifelse(str_detect(gen_type, "tiva"), "&times;", NA),
    volatile = ifelse(str_detect(gen_type, "inhal"), "&times;", NA),
    anesth_ns = ifelse(is.na(gen_type), "&times;", NA),
    rnmb_where = coalesce(rnmb1_where, rnmb2_where), # approximation, but generally correct
    rnmb_dev = coalesce(rnmb1_dev, rnmb2_dev), # approximation, but generally correct
    # depth_rev = as.character(depth_rev),
    # depth_rev = coalesce(depth_rev, depth),
    # fix Wu study for pulled from distiller
    study_l = case_when(
      study == "Wu 2014" & arm_n > 75 ~ "[Wu 2014 (Chinese)](evidence_tables.html#2710)",
      study == "Wu 2014" & arm_n < 75 ~ "[Wu 2014 (Caucasian)](evidence_tables.html#2710)",
      # study == "Nemes 2017 (nl)" ~ "[Nemes 2017 (nl)](evidence_tables.html#3058)", # used normalized 
      TRUE ~ study_l),
  ) %>%
  # select(refid, study, arm, arm_id, nmbagent, nmb_agent) %>% 
  pivot_wider(id_cols = c(refid, study, arm, arm_id, everything()), names_from = nmb_agent, values_from = nmbagent, values_fn = ~ firstup(str_extract(.x, "\\w{3}"))) %>% 
  rename_with(.fn = ~ str_extract(.x, "\\w{3}"), .cols = vecuronium:cisatracurium) %>% 
  select(refid, design, study_l, study, arm_n, arm, depth_rev_f, deep:ns_depth, dose_comb, roc, vec, cis, var, tiva, volatile, anesth_ns, rnmb_where, rnmb_dev, mon_cat_f)
  
## rnmbData_ma ---------------------------------------- (2022-02-28 08:51) @----
rnmb_ma.dat <- read_csv("data/rnmb_read_011322.csv") %>% 
  clean_names() %>% 
  filter(!is.na(arm)) %>% 
  fill(refid, study) %>% 
  remove_empty(which = "cols") %>% 
  mutate(
    study_orig = study,
    study = str_extract(study, "\\w*.{0,1}\\w* \\d{4}"),
    mg_kg = ifelse(is.na(mg_kg) & !is.na(mg), paste0("<u>", mg, "</u>"), mg_kg),
    refid = as.numeric(refid)
  ) %>% 
  select(-mg) # milligram can delete

temp <- study_char.dat %>% select(refid, study_l, age, design, year)

rnmb_ma.dat <- inner_join(rnmb_ma.dat, temp, by = "refid") %>%
  relocate(c(study_orig, study_l, age, design, year), .before = study) %>%
  # fix links
  mutate(
    study_l = case_when(
      study_orig == "Wu 2014 (Chinese)" ~ "[Wu 2014 (Chinese)](evidence_tables.html#2710)",
      study_orig == "Wu 2014 (Caucasian)" ~ "[Wu 2014 (Caucasian)](evidence_tables.html#2710)",
      study_orig == "Nemes 2017 (nl)" ~ "[Nemes 2017 (nl)](evidence_tables.html#3058)",
      TRUE ~ study_l),
    design = fct_drop(design),
    depth_f = case_when(
      !is.na(deep) ~ "Deep",
      !is.na(mod) ~ "Moderate",
      !is.na(shallow) ~ "Shallow",
      !is.na(min) ~ "Minimal",
      !is.na(ns_depth) ~ "NS",
      TRUE ~ NA_character_
    ),
  ) %>% 
    arrange(age, design, year)

# rnmb.dat %>% 
#   mutate(across(deep:ns_depth, ~ ifelse(!is.na(.x), 1, 0))) %>% 
#   summarise(across(deep:ns_depth, ~ sum(.x)/length(.x)))

# add volatile anesthestic from study arm if necessary
# temp <- study_arm_rev.dat %>% 
#   select(refid, arm, arm_n, volatile) %>% 
#   filter(refid %in% rnmb.dat$refid) %>% 
#   rename(n = arm_n)
# 
# left_join(rnmb.dat, temp, by = c("refid, arm, arm_n"))

# get n from dichot data
# temp <- dichot.dat %>% 
#   filter(refid %in% rev_refids) %>% 
#   select(refid, study, starts_with("rnmb")) %>% 
#   remove_empty(which = "cols")

rm(temp)
```

### <u>Adults</u>

###  Agents, Anesthetics, and Monitors

<br/>

<font size = 4> Table `r table_n`. Reversal and neuromuscular blocking agents, anesthetic, and monitor in studies reporting residual neuromuscular blockade in adults. </font>

```{r rnmbDescrKbl}
## groupings ------------------------------------------ (2022-03-02 11:24) @----
# roc <- cell_spec("Rocuromiun", angle = -60, align = "r")
# rnmb_ma.dat %>%
#   filter(age == "Adult") %>%
#   arrange(design, study_l) %>%
#   select(study_l, refid, design) %>%
#   group_by(design) %>%
#   tally() %>%
#   ungroup() %>%
#   mutate(
#     end = cumsum(n),
#     start = end - n + 1
#   ) %>%
#   select(design, start, end)

## rnmbDescrKbl --------------------------------------- (2022-03-10 07:16) @----
# rnmb.dat %>% 
rnmb_ma.dat %>% 
  filter(age == "Adult") %>%
  select(study_l, arm:ns_mon) %>% 
  relocate(n, .before = arm) %>% 
  group_by(study_l) %>% 
  mutate(
    # across(c(roc:ns_mon), ~ str_replace(.x, "x", "&#x25cf;")),
    across(c(roc:ns_mon), ~ str_replace(.x, "x", "&times;")),
    study_l = ifelse(row_number() != 1, "", study_l),
    study_l = str_replace(study_l, "Nemes 2017", "Nemes 2017^a^")) %>% 
  ungroup() %>% 
  select(study_l, n, arm, mg_kg, roc:ns_mon) %>% 
  kbl(
    booktabs = T, align = c("llcccccccccccc"), escape = FALSE, # format = "latex",
    col.names = c("Study", " N", "Agent", "mg/kg; <u>mg</u>", "Roc", "Vec", "Cis", "TIVA", "Volat", "NS", "AMG", "KMG", "Clin", "NS")
  ) %>%
  add_header_above(c(" " = 2, "Reversal" = 2, "NMBA" = 3, "Anesthetic" = 3, "Monitoring" =  4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>% 
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "3em") %>% 
  column_spec(3, width = "4em") %>% 
  column_spec(4, width = "7em") %>% 
  column_spec(c(5:14), width = "4em") %>% 
  pack_top(., "RCT", 1, 30, indent_tf = FALSE) %>% 
  pack_top(., "Nonrandomized Trials", 31, 32, indent_tf = FALSE) %>% 
  pack_top(., "Prospective Cohort", 33, 43, indent_tf = FALSE) %>% 
  pack_top(., "Retrospective Cohort", 44, 45, indent_tf = FALSE) %>% 
    footnote(
    general = "NMBA: neuromuscular blocking agent; Neo: neostigmine; Sug: sugammadex; Cis: cisatracurium; Spont: spontaneous; Roc: rocuronium; Vec: vecuronium; TIVA: total intravenous anesthesia; Volat: volatile; NS: not specified; AMG: acceleromyography; EMG: electromyography; KMG: kinemyography; nl: normalized AMG; Clin: clinical.",
    alphabet = c("Used normalized readings."),
    general_title = "",
    footnote_as_chunk = FALSE
  )  

table_n <- tab_inc()
```

<br/>

```{r rnmbKblPrimary, eval = FALSE, include = FALSE}
## rnmbKbl -------------------------------------------- (2022-04-02 20:02) @----
rnmb_prim.dat <- dichot.dat %>% 
  filter(refid %in% rev_refids) %>% 
  filter(if_any(starts_with("rnmb"), ~ !is.na(.))) %>% 
  select(refid, arm_id, study, study_l, year, design, age, subgroups, subgroup, starts_with("rnmb"), notes_d) %>% 
  filter(if_any(c(rnmb1_7, rnmb1_9, rnmb2_7, rnmb2_9, rnmb1_clinical, rnmb2_clinical),  ~ !is.na(.))) %>% 
  # only rcts
  filter(design == "rct") %>% 
  remove_empty(which = "cols")

rnmb_rev_agent <- study_arm.dat %>% 
  filter(refid %in% rnmb_prim.dat$refid) %>% 
  select(refid, study, arm_id, revagent, revtim, revtim_comment, -study)

rnmb_prim.dat <- 
  left_join(rnmb_prim.dat, rnmb_rev_agent, by = c("refid", "arm_id")) %>% 
  relocate(revagent, .after = arm_id)

# write_csv(rnmb_prim.dat, "/Users/mgrant/Desktop/rnmb_prim.dat.csv", na = "")
# refids
temp <- rnmb_prim.dat %>% 
  select(refid, study) %>% 
  distinct()

# write_csv(temp, "data/reversal_rnmb_refids.csv", na = "")

length(unique(rnmb_prim.dat$refid))
```

<br/>

###  Incidence

<a id="revTab4"></a>

<br/>

<font size = 4> Table `r table_n`. Incidence of residual neuromuscular blockade and depth of block according to reversal in adults.</font>

```{r rnmbKbl}
## ## rnmbKbl ----------------------------------------- (2022-04-02 14:57) @----
# calculate relative risks for 0.9
dichot_format <- function(x) (x)

temp <- rnmb_ma.dat %>%
# temp <- rnmb.dat %>%
  filter(age == "Adult") %>%
  group_by(study_orig) %>%
  mutate(
    rx_n = n,
    comp_n = lag(n),
    rx_event = as.numeric(str_extract(lt_9, "\\d{1,2}")),
    comp_event = lag(as.numeric(str_extract(lt_9, "\\d{1,2}")))
  ) %>%
  ungroup() %>%
  mutate(
    # fix for multiarm
    rx_event = ifelse(refid == 3058, 1, rx_event),
    rx_n = ifelse(refid == 3058, 27, rx_n),
    rx_event = ifelse(refid == 2557, 5, rx_event),
    rx_n = ifelse(refid == 2557, 117, rx_n),
    rx_event = ifelse(refid == 2560, 4, rx_event),
    rx_n = ifelse(refid == 2560, 57, rx_n),
    rr_ci_calc = case_when(
      if_all(c(rx_event, rx_n, comp_event, comp_n), ~ !is.na(.)) ~ risk_ratio_y(rx_event, rx_n, comp_event, comp_n),
      TRUE ~ NA_character_
    ),
    # relocate 
    rr_ci_calc = str_replace(rr_ci_calc, "NA \\(NA-NA\\)", NA_character_),
    # fix percentages
    lt_1_n = as.numeric(str_extract(lt_1, "\\d{1,2}")),
    lt_9_n = as.numeric(str_extract(lt_9, "\\d{1,2}")),
    lt_7_n = as.numeric(str_extract(lt_7, "\\d{1,2}")),
    clin_n = as.numeric(str_extract(clin, "\\d{1,2}")),
    lt_1_per = lt_1_n / n,
    lt_9_per = lt_9_n / n,
    lt_7_per = lt_7_n / n,
    clin_per = clin_n / n,
    lt_1 = ifelse(!is.na(lt_1_per), paste0(lt_1_n, " (", round_0(lt_1_per * 100), ")"), lt_1),
    lt_9 = ifelse(!is.na(lt_9_per), paste0(lt_9_n, " (", round_0(lt_9_per * 100), ")"), lt_9),
    lt_7 = ifelse(!is.na(lt_7_per), paste0(lt_7_n, " (", round_0(lt_7_per * 100), ")"), lt_7),
    clin = ifelse(!is.na(clin_per), paste0(clin_n, " (", round_0(clin_per * 100), ")"), clin),
  ) %>%
  group_by(study_l) %>% 
  mutate(
    rr_ci_calc = lead(rr_ci_calc),
    # ns_rnmb = ifelse(ns_rnmb %in% "0 (0)", "0 (0.0)", ns_rnmb)
  ) %>% 
  ungroup() %>% 
  select(refid, study_l, arm, n, lt_1, lt_9, lt_7, clin, rx_n:rr_ci_calc, lt_1_n:clin_per, ns_rnmb, deep:ns_depth, rr_ci_calc, design, age, study_orig, year, volatiles) %>%
  mutate(
    lt_1_bar = 0, lt_9_bar = 0, lt_7_bar = 0, clin_bar = 0,
    lt_1_bar = color_bar2("#fdcccc", fun = dichot_format)(lt_1_per),
    lt_9_bar = color_bar2("#fdcccc", fun = dichot_format)(lt_9_per),
    lt_7_bar = color_bar2("#fdcccc", fun = dichot_format)(lt_7_per),
    clin_bar = color_bar2("#fdcccc", fun = dichot_format)(clin_per),
    lt_1_bar = str_replace(lt_1_bar, ">.*<", paste0(">", lt_1, "<")),
    lt_9_bar = str_replace(lt_9_bar, ">.*<", paste0(">", lt_9, "<")),
    lt_7_bar = str_replace(lt_7_bar, ">.*<", paste0(">", lt_7, "<")),
    clin_bar = str_replace(clin_bar, ">.*<", paste0(">", clin, "<")),
    across(lt_1_bar:clin_bar, ~ str_replace(., ">NA<", "><")),
    across(lt_1_bar:clin_bar, ~ case_when(
       arm == "Sug" ~ str_replace_all(., "#fdcccc", color_1),
       arm == "Neo" ~ str_replace_all(., "#fdcccc", color_2),
       arm == "Placebo" ~ str_replace_all(., "#fdcccc", color_4),
       arm == "Spont" ~ str_replace_all(., "#fdcccc", color_4)),
       ),
    arm_c = case_when(
      arm == "Sug" ~ cell_spec(arm, color = color_1),
      arm == "Placebo" ~ cell_spec(arm, color = color_4),
      arm == "Spont" ~ cell_spec(arm, color = color_4),
      arm == "Neo" ~ cell_spec(arm, color = color_2),
    )
  )

mod <- color_bar2("#d6dbdf", fun = dichot_format)(1)
lt1 <- str_replace(mod, ">.*<", paste0(">", "    <1.0", "<"))
lt9 <- str_replace(mod, ">.*<", paste0(">", "    <0.9", "<"))
lt7 <- str_replace(mod, ">.*<", paste0(">", "    <0.7", "<"))
clin <- str_replace(mod, ">.*<", paste0(">", "    Clin", "<"))
ns_rnmb <- str_replace(mod, ">.*<", paste0(">", "      ns_rnmb", "<"))

# temp %>%
#   filter() %>%
#   arrange(age, design, study_l) %>%
#   select(study_l, refid, age, design) %>%
#   group_by(age, design) %>%
#   tally() %>%
#   ungroup() %>%
#   mutate(
#     end = cumsum(n),
#     start = end - n + 1
#   ) %>%
#   select(age, design, start, end)

temp %>%
  select(study_l, n, arm_c, deep:ns_depth, volatiles, lt_1_bar:clin_bar, ns_rnmb, rr_ci_calc) %>%
  group_by(study_l) %>%
  mutate(
    # across(c(roc:ns_mon), ~ str_replace(.x, "x", "&#x25cf;")),
    across(c(deep:ns_depth), ~ str_replace(.x, "x", "&times;")),
    study_l = ifelse(row_number() != 1, "", study_l)
  ) %>%
  ungroup() %>%
  kbl(
    booktabs = T, align = c("llcccccclllllll"), escape = FALSE, # format = "latex")
    col.names = c("Study", " N", "Agent", "Deep", "Mod", "Shal", "Min", "NS", "Volat", lt1, lt9, lt7, clin, "NS", "RR (95% CI)^c^")
  ) %>%
  add_header_above(c(" " = 2, "Reversal" = 1, "Depth of Block^a^" = 5, " " = 1,"Residual Neuromuscular Block, N (%)^b^" = 5, "  " = 1), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "2em") %>%
  column_spec(3, width = "4em") %>%
  column_spec(c(4:8), width = "3em") %>%
  column_spec(9, width = "3em", popover = "Volatiles") %>% 
  column_spec(10, width = "4em", popover = "<1.0") %>%
  column_spec(11, width = "4em", popover = "<0.9") %>%
  column_spec(12, width = "4em", popover = "<0.7") %>%
  column_spec(13, width = "4em", popover = "Clinical") %>%
  column_spec(14, width = "3em", popover = "Not specified") %>%
  column_spec(15, width = or_width, popover = "OR (95% CI)") %>%
  pack_top(., "RCT", 1, 30, indent_tf = FALSE) %>% 
  pack_top(., "Nonrandomized Studies of Intervention", 31, 32, indent_tf = FALSE) %>% 
  pack_top(., "Prospective Cohort", 33, 43, indent_tf = FALSE) %>% 
  pack_top(., "Retrospective Cohort", 44, 45, indent_tf = FALSE) %>% 
  footnote(
    general = "RR: risk ratio; Neo: neostigmine; Sug: sugammadex; Spont: spontaneous; Roc: rocuronium; Vec: vecuronium; NS: not specified; nl: normalized AMG.",
    alphabet = c(
      "Depth of block categorized according to Naguib et al., Consensus Statement on Perioperative Use of Neuromuscular Monitoring. Anesth Analg 2018;127:71-80.",
      "Bar width for reference as 100%.",
      "Comparing the 2nd or last arm with previous for TOFR <0.9. If no events in one arm, continuity correction used to allow estimating RR (Schwarzer G, Carpenter JR, Rücker G: Meta-analysis with R, Springer, 2015)."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

###  Pooled TOFR <0.9 (RCTs)

```{r rnmbMetaData}
## rnmbMetaData --------------------------------------- (2022-04-02 19:43) @----
rnmb_meta.dat <- temp %>%
  filter(design == "rct", arm %in% c("Neo", "Sug"), age == "Adult") %>%
  mutate(
    depth = case_when(
      !is.na(deep) ~ "Deep",
      !is.na(mod) ~ "Moderate",
      !is.na(shallow) ~ "Shallow",
      !is.na(min) ~ "Minimal",
      TRUE ~ "Not specified",
    )
  ) %>%
  select(refid, depth, volatiles, study_orig, lt_9_n, n, arm, year) %>%
  pivot_wider(id_cols = c("refid", "study_orig", "year", "volatiles"), names_from = "arm", values_from = c("lt_9_n", "n")) %>%
  filter(if_all(c(lt_9_n_Neo:n_Sug), ~ !is.na(.))) %>% 
  mutate(volatiles = ifelse(volatiles %in% "x", "Volatile Anesthetic", "No Volatiles")) %>% 
  arrange(year)

# add depth of block
temp1 <- temp %>% 
  filter(design == "rct", arm %in% c("Neo", "Sug"), age == "Adult") %>%
  mutate(
    depth = case_when(
      !is.na(deep) ~ "Deep",
      !is.na(mod) ~ "Moderate",
      !is.na(shallow) ~ "Shallow",
      !is.na(min) ~ "Minimal",
      TRUE ~ "Not specified",
    )
  ) %>%
  select(refid, study_orig, arm, depth) %>% 
  pivot_wider(id_cols = c("refid", "study_orig"), names_from = "arm", values_from = "depth") %>% 
  mutate(
    depth = ifelse(Neo == Sug, Neo, paste0(Neo, ":", Sug))
  )

rnmb_meta.dat <- left_join(rnmb_meta.dat, temp1, by = c("refid", "study_orig")) %>% 
  select(-c(Neo, Sug)) %>% 
  arrange(depth, year)

```

<a id="revFig2"></a>

<br/>

<font size = 4> Figure `r figure_n`. Pooled residual neuromuscular blockade (TOFR <0.9) from randomized trials comparing sugammadex and neostigmine by depth of block. </font>

```{r rnmbMetaRctByDepth, fig.width = 10, fig.height = 7}
# TODO: fig.height
## rnmbMetaRctByVolatile -----------------------------+ (2022-04-03 10:08) @----
rnmb_meta <- metabin(lt_9_n_Sug, n_Sug, lt_9_n_Neo, n_Neo, 
  data = rnmb_meta.dat,
  studlab = study_orig,
  sm = "RR",
  method = "MH",
  method.tau = "PM",
  hakn = FALSE,
  prediction = FALSE,
  # subset = !study_orig %in% c("Wu 2014 (Chinese)", "Wu 2014 (Caucasian)"),
  subgroup = depth)

forest(rnmb_meta,
  allstudies = TRUE,
  fixed = FALSE,
  label.e = "Sugammadex",
  label.c = "Neostigmine",
  rightcols = c("effect", "ci"),
  rightlabs = c("RR", "(95% CI)"),
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  subgroup = TRUE,
  print.subgroup.name = FALSE,
  text.subgroup.nohet = TRUE,
  colgap.forest.left = "10mm",
  colgap.forest.right = "10mm",
  xlim = c(0.001, 5),
  at = c(.001, 0.01, .1, 1, 5),
  xlab = "Favors:     Sugammadex          Neostigmine")

figure_n <- fig_inc()
```
Risk difference -23.5% (95% CI, -36.2% to -10.8%); n.b., includes 9 studies (n = 1434), while RR estimate 8 studies (n = 1143). Too few studies to examine small study effects. 

<br/>

```{r smallStudyEffectsRnmb, eval = FALSE}
## smallStudyEffects ---------------------------------- (2022-04-04 09:58) @----
temp_meta <- rnmb_meta
temp_meta <- update(temp_meta, subgroup = NULL, sm = "RR")
metabias(temp_meta, method.bias = "Harbord", k.min = 8)
metabias(temp_meta, method.bias = "Egger", k.min = 8)
funnel(temp_meta)
```

<br/>

###  Pooled TOFR <0.7 (RCTs)

<a id="revFig3"></a>

<br/>

<font size = 4> Figure `r figure_n`. Pooled residual neuromuscular blockade (TOFR <0.7) from randomized trials comparing sugammadex and neostigmine by depth of block. </font>

```{r rnmbMetaRct0.7, fig.width = 10, fig.height = 4.5}
# TODO: fig.height

## rnmbMetaData0.7 ------------------------------------ (2022-04-02 19:43) @----
rnmb_meta.dat <- temp %>%
  filter(design == "rct", arm %in% c("Neo", "Sug"), age == "Adult") %>%
  mutate(
    depth = case_when(
      !is.na(deep) ~ "Deep",
      !is.na(mod) ~ "Moderate",
      !is.na(shallow) ~ "Shallow",
      !is.na(min) ~ "Minimal",
      TRUE ~ "Not specified",
    )
  ) %>%
  select(refid, depth, volatiles, study_orig, lt_7_n, n, arm, year) %>%
  pivot_wider(id_cols = c("refid", "study_orig", "year", "volatiles"), names_from = "arm", values_from = c("lt_7_n", "n")) %>%
  filter(if_all(c(lt_7_n_Neo:n_Sug), ~ !is.na(.))) %>% 
  mutate(volatiles = ifelse(volatiles %in% "x", "Volatile Anesthetic", "No Volatiles")) %>% 
  arrange(year)

# add depth of block
temp1 <- temp %>% 
  filter(design == "rct", arm %in% c("Neo", "Sug"), age == "Adult") %>%
  mutate(
    depth = case_when(
      !is.na(deep) ~ "Deep",
      !is.na(mod) ~ "Moderate",
      !is.na(shallow) ~ "Shallow",
      !is.na(min) ~ "Minimal",
      TRUE ~ "Not specified",
    )
  ) %>%
  select(refid, study_orig, arm, depth) %>% 
  pivot_wider(id_cols = c("refid", "study_orig"), names_from = "arm", values_from = "depth") %>% 
  mutate(
    depth = ifelse(Neo == Sug, Neo, paste0(Neo, ":", Sug))
  )

rnmb_meta.dat <- left_join(rnmb_meta.dat, temp1, by = c("refid", "study_orig")) %>% 
  select(-c(Neo, Sug)) %>% 
  arrange(depth, year)

rm(temp, temp1)
## rnmbMeta0.7 ---------------------------------------+ (2022-04-03 10:08) @----
rnmb_meta <- metabin(lt_7_n_Sug, n_Sug, lt_7_n_Neo, n_Neo, 
  data = rnmb_meta.dat,
  studlab = study_orig,
  sm = "RR",
  method = "MH",
  method.tau = "PM",
  hakn = FALSE,
  prediction = TRUE,
  # subset = !study_orig %in% c("Wu 2014 (Chinese)", "Wu 2014 (Caucasian)"),
  subgroup = depth)

forest(rnmb_meta,
  fixed = FALSE,
  label.e = "Sugammadex",
  label.c = "Neostigmine",
  rightcols = c("effect", "ci"),
  rightlabs = c("RR", "(95% CI)"),
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  subgroup = TRUE,
  print.subgroup.name = FALSE,
  text.subgroup.nohet = TRUE,
  colgap.forest.left = "10mm",
  colgap.forest.right = "10mm",
  xlim = c(0.001, 5),
  at = c(.001, 0.01, .1, 1, 5),
  xlab = "Favors:     Sugammadex          Neostigmine")

 figure_n <- fig_inc()
```
Risk difference -16.0% (95% CI, -23.8% to -8.2%). Too few studies to examine small study effects. 

<br/>

### <u>Pediatric</u>

###  Agents, Anesthetics, and Monitors

<br/>

<font size = 4> Table `r table_n`. Reversal and neuromuscular blocking agents, anesthetic, and monitor in studies reporting residual neuromuscular blockade in pediatric patients. </font>

```{r rnmbDescrPedsKbl}
## groupings -----------------------------------------+ (2022-03-02 11:24) @----
# rnmb_ma.dat %>%
#   filter(age == "Pediatric") %>%
#   arrange(design, study_l) %>%
#   select(study_l, refid, design) %>%
#   group_by(design) %>%
#   tally() %>%
#   ungroup() %>%
#   mutate(
#     end = cumsum(n),
#     start = end - n + 1
#   ) %>%
#   select(design, start, end)
# roc <- cell_spec("Rocuromiun", angle = -60, align = "r")
# temp <- rnmb.dat %>%
# rnmb.dat %>% 

## rnmbDescrPedsKbl ----------------------------------+ (2022-03-02 11:25) @----
# rnmb.dat %>% 
rnmb_ma.dat %>% 
  filter(age == "Pediatric") %>%
  select(study_l, arm:ns_mon) %>% 
  relocate(n, .before = arm) %>% 
  group_by(study_l) %>% 
  mutate(
    # across(c(roc:ns_mon), ~ str_replace(.x, "x", "&#x25cf;")),
    across(c(roc:ns_mon), ~ str_replace(.x, "x", "&times;")),
    study_l = ifelse(row_number() != 1, "", study_l),
    study_l = str_replace(study_l, "Nemes 2017", "Nemes 2017^a^")) %>% 
  ungroup() %>% 
  kbl(
    booktabs = T, align = c("llcccccccccccc"), escape = FALSE, # format = "latex",
    col.names = c("Study", " N", "Agent", "mg/kg", "Roc", "Vec", "Cis", "TIVA", "Inh", "NS", "AMG", "KMG", "Clin", "NS")
  ) %>%
  add_header_above(c(" " = 2, "Reversal" = 2, "NMBA" = 3, "Anesthetic" = 3, "Monitoring" =  4), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>% 
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "3em") %>% 
  column_spec(3, width = "4em") %>% 
  column_spec(4, width = "6em") %>% 
  column_spec(c(5:14), width = "4em") %>% 
  pack_top(., "RCT", 1, 2, indent_tf = FALSE) %>% 
  pack_top(., "Prospective Cohort", 3, 4, indent_tf = FALSE) %>% 
    footnote(
    general = "NMBA: neuromuscular blocking agent; Neo: neostigmine; Sug: sugammadex; Cis: cisatracurium; Spont: spontaneous; Roc: rocuronium; Vec: vecuronium; TIVA: total intravenous anesthesia; Inh: inhalation; NS: not specified; AMG: acceleromyography; EMG: electromyography; KMG: kinemyography; nl: normalized AMG; Clin: clinical.",
    # alphabet = c(""),
    general_title = "",
    footnote_as_chunk = FALSE
  )  

table_n <- tab_inc()
```

<br/>

###  Incidence

<br/>

<font size = 4> Table `r table_n`. Incidence of residual neuromuscular blockade and depth of block according to reversal in pediatric patients.</font>

```{r rnmbPedsKbl}
## rnmbPedsKbl ---------------------------------------+ (2022-04-03 10:55) @----
dichot_format <- function(x) (x)

temp <- rnmb_ma.dat %>%
  filter(age == "Pediatric") %>%
  group_by(study_orig) %>%
  mutate(
    rx_n = n,
    comp_n = lag(n),
    rx_event = as.numeric(str_extract(lt_9, "\\d{1,2}")),
    comp_event = lag(as.numeric(str_extract(lt_9, "\\d{1,2}")))
  ) %>%
  ungroup() %>%
  mutate(
    # fix for multiarm
    rx_event = ifelse(refid == 3058, 1, rx_event),
    rx_n = ifelse(refid == 3058, 27, rx_n),
    rx_event = ifelse(refid == 2557, 5, rx_event),
    rx_n = ifelse(refid == 2557, 117, rx_n),
    rx_event = ifelse(refid == 2560, 4, rx_event),
    rx_n = ifelse(refid == 2560, 57, rx_n),
    rr_ci_calc = case_when(
      if_all(c(rx_event, rx_n, comp_event, comp_n), ~ !is.na(.)) ~ risk_ratio_y(rx_event, rx_n, comp_event, comp_n),
      TRUE ~ NA_character_
    ),
    # relocate 
    rr_ci_calc = str_replace(rr_ci_calc, "NA \\(NA-NA\\)", NA_character_),
    # fix percentages
    lt_1_n = as.numeric(str_extract(lt_1, "\\d{1,2}")),
    lt_9_n = as.numeric(str_extract(lt_9, "\\d{1,2}")),
    lt_7_n = as.numeric(str_extract(lt_7, "\\d{1,2}")),
    clin_n = as.numeric(str_extract(clin, "\\d{1,2}")),
    lt_1_per = lt_1_n / n,
    lt_9_per = lt_9_n / n,
    lt_7_per = lt_7_n / n,
    clin_per = clin_n / n,
    lt_1 = ifelse(!is.na(lt_1_per), paste0(lt_1_n, " (", round_1(lt_1_per * 100), ")"), lt_1),
    lt_9 = ifelse(!is.na(lt_9_per), paste0(lt_9_n, " (", round_1(lt_9_per * 100), ")"), lt_9),
    lt_7 = ifelse(!is.na(lt_7_per), paste0(lt_7_n, " (", round_1(lt_7_per * 100), ")"), lt_7),
    clin = ifelse(!is.na(clin_per), paste0(clin_n, " (", round_1(clin_per * 100), ")"), clin),
  ) %>%
  group_by(study_l) %>% 
  mutate(
    rr_ci_calc = lead(rr_ci_calc)
  ) %>% 
  ungroup() %>% 
  select(refid, study_l, arm, n, lt_1, lt_9, lt_7, clin, rx_n:rr_ci_calc, lt_1_n:clin_per, ns_rnmb, deep:ns_depth, rr_ci_calc, design, age, study_orig, year) %>%
  mutate(
    lt_1_bar = 0, lt_9_bar = 0, lt_7_bar = 0, clin_bar = 0,
    lt_1_bar = color_bar2("#fdcccc", fun = dichot_format)(lt_1_per),
    lt_9_bar = color_bar2("#fdcccc", fun = dichot_format)(lt_9_per),
    lt_7_bar = color_bar2("#fdcccc", fun = dichot_format)(lt_7_per),
    clin_bar = color_bar2("#fdcccc", fun = dichot_format)(clin_per),
    lt_1_bar = str_replace(lt_1_bar, ">.*<", paste0(">", lt_1, "<")),
    lt_9_bar = str_replace(lt_9_bar, ">.*<", paste0(">", lt_9, "<")),
    lt_7_bar = str_replace(lt_7_bar, ">.*<", paste0(">", lt_7, "<")),
    clin_bar = str_replace(clin_bar, ">.*<", paste0(">", clin, "<")),
    across(lt_1_bar:clin_bar, ~ str_replace(., ">NA<", "><")),
    across(lt_1_bar:clin_bar, ~ case_when(
       arm == "Sug" ~ str_replace_all(., "#fdcccc", color_1),
       arm == "Neo" ~ str_replace_all(., "#fdcccc", color_2),
       arm == "Placebo" ~ str_replace_all(., "#fdcccc", color_4),
       arm == "Spont" ~ str_replace_all(., "#fdcccc", color_4)),
       ),
    arm_c = case_when(
      arm == "Sug" ~ cell_spec(arm, color = color_1),
      arm == "Placebo" ~ cell_spec(arm, color = color_4),
      arm == "Spont" ~ cell_spec(arm, color = color_4),
      arm == "Neo" ~ cell_spec(arm, color = color_2),
    )
  )

mod <- color_bar2("#d6dbdf", fun = dichot_format)(1)
lt1 <- str_replace(mod, ">.*<", paste0(">", "    <1.0", "<"))
lt9 <- str_replace(mod, ">.*<", paste0(">", "    <0.9", "<"))
lt7 <- str_replace(mod, ">.*<", paste0(">", "    <0.7", "<"))
clin <- str_replace(mod, ">.*<", paste0(">", "    Clin", "<"))
ns_rnmb <- str_replace(mod, ">.*<", paste0(">", "      ns_rnmb", "<"))

temp %>%
  select(study_l, n, arm_c, deep:ns_depth, lt_1_bar:clin_bar, ns_rnmb, rr_ci_calc) %>%
  group_by(study_l) %>%
  mutate(
    # across(c(roc:ns_mon), ~ str_replace(.x, "x", "&#x25cf;")),
    across(c(deep:ns_depth), ~ str_replace(.x, "x", "&times;")),
    study_l = ifelse(row_number() != 1, "", study_l)
  ) %>%
  ungroup() %>%
  kbl(
    booktabs = T, align = c("llccccclllllll"), escape = FALSE, # format = "latex")
    col.names = c("Study", "N", "Agent", "Deep", "Mod", "Shal", "Min", "NS", lt1, lt9, lt7, clin, "NS", "RR (95% CI)^c^")
  ) %>%
  add_header_above(c(" " = 2, "Reversal" = 1, "Depth of Block^a^" = 5, "Residual Neuromuscular Block, N (%)^b^" = 5, "  " = 1), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "2em") %>%
  column_spec(3, width = "4em") %>%
  column_spec(c(4:8), width = "3em") %>%
  column_spec(c(9:12), width = "4em") %>%
  column_spec(c(13), width = "3em") %>%
  column_spec(14, width = or_width) %>%
  pack_top(., "RCT", 1, 2, indent_tf = FALSE) %>%
  pack_top(., "Prospective Cohort", 3, 4, indent_tf = FALSE) %>%
  footnote(
    general = "RR: risk ratio; Neo: neostigmine; Sug: sugammadex; Spont: spontaneous; Roc: rocuronium; Vec: vecuronium; NS: not specified; nl: normalized AMG.",
    alphabet = c(
      "Depth of block categorized according to Naguib et al., Consensus Statement on Perioperative Use of Neuromuscular Monitoring. Anesth Analg 2018;127:71-80.",
      "Bar width for reference as 100%.",
      "Comparing the 2nd or last arm with previous for TOFR <0.9. If no events in one arm, continuity correction used to allow estimating RR (Schwarzer G, Carpenter JR, Rücker G: Meta-analysis with R, Springer, 2015)."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

## *Time to Recovery*

```{r timeData}
## verify all refids not run  ------------------------- (2022/02/11 08:48) @----
# time.dat <- suppressWarnings(read_csv("data/recoveryTime_012122.csv", col_types = c("nccccncccccccccccccncccccccc"))) %>%
#   clean_names() %>%
#   remove_empty(which = c("cols", "rows")) %>% # why new names
#   fill(refid, study, arm, mg_kg, n, depth) %>% 
#   mutate(id = row_number()) %>% 
#   relocate(id, .before = refid) %>% 
#   group_by(refid) %>% 
#   fill(volatiles) %>% 
#   ungroup()
# 
# temp <- readxl::read_xlsx("data/RevAgentSummary011122_mg.xlsx", sheet = "RecoveryTimeCopy", range = "A1:A160") %>%
#     clean_names() %>%
#   remove_empty(which = c("cols", "rows")) %>% # why new names
#   mutate(refid = as.numeric(refid)) %>%
#   filter(!is.na(refid)) %>%
#   distinct(refid)
# 
# mark_refid <- unique(time.dat$refid)
# curr_sp_refid <- unique(temp$refid)
# 
# sum(!mark_refid %in% curr_sp_refid)
# sum(!curr_sp_refid %in% mark_refid)

## data ----------------------------------------------- (2022-02-10 10:41) @----
time.dat <- suppressWarnings(read_csv("data/recoveryTime_012122.csv", col_types = c("nccccncccccccccccccncccccccc"))) %>%
  clean_names() %>%
  remove_empty(which = c("cols", "rows")) %>% # why new names
  fill(refid, study, arm, mg_kg, n, depth) %>% 
  mutate(id = row_number()) %>% 
  relocate(id, .before = refid) %>% 
  group_by(refid) %>% 
  fill(volatiles) %>% 
  ungroup()

time.dat8 <- time.dat %>% 
  filter(tofr == 0.8) %>% 
  group_by(refid) %>%
  mutate(
    arm_id = paste0(row_number(), "_8")
  ) %>% 
  ungroup() %>% 
  relocate(arm_id, .before = arm)

time.dat9 <- time.dat %>% 
  filter(tofr == 0.9) %>% 
  group_by(refid) %>%
  mutate(
    arm_id = paste0(row_number(), "_9")
  ) %>% 
  ungroup() %>% 
  relocate(arm_id, .before = arm)

time.dat1 <- time.dat %>% 
  filter(tofr == 1.0) %>% 
  group_by(refid) %>%
  mutate(
    arm_id = paste0(row_number(), "_9")
  ) %>% 
  ungroup() %>% 
  relocate(arm_id, .before = arm)

time.dat <- bind_rows(time.dat9, time.dat8, time.dat1) %>% 
  arrange(id)

# time.dat %>% tabyl(tofr)

## add study_char.dat data ---------------------------- (2022-02-10 10:42) @----
temp <- study_char.dat %>% select(refid, study_l, age, design, year)
time.dat <- inner_join(time.dat, temp, by = "refid") %>%
  relocate(c(study_l, age, design, year), .before = arm_id) %>%
  # fix links
  mutate(
    study_l = case_when(
      study == "Wu 2014 (Chinese)" ~ "[Wu 2014 (Chinese)](evidence_tables.html#2710)",
      study == "Wu 2014 (Caucasian)" ~ "[Wu 2014 (Caucasian)](evidence_tables.html#2710)",
      study == "Nemes 2017 (nl)" ~ "[Nemes 2017 (nl)](evidence_tables.html#3058)",
      TRUE ~ study_l
    )
  )

## add agent and anesthetic
temp <- study_arm.dat %>% 
  filter(refid %in% time.dat$refid) %>% 
  select(refid, nmbagent, study_arm_k, gen_type) %>% 
  mutate(
    arm = str_replace(study_arm_k, "rev_agt\\|", ""),
    arm = str_replace(arm, "an$", ""),
    arm = recode(arm, "other" = "placebo"),
    arm = firstup(arm)
  ) %>% 
  select(-study_arm_k)

time.dat <- left_join(time.dat, temp, by = c("refid", "arm")) %>% 
  relocate(c(nmbagent, gen_type), .before = amg) %>% 
  group_by(id) %>% 
  slice(1) %>% 
  ungroup()

# write_csv(time.dat, "/Users/mgrant/Desktop/time_1.dat.csv", na = "")
```

### <u>Adults RCTs</u>

###  Agents, Anesthetics, and Monitors 

<br/>

<font size = 4> Table `r table_n`. By depth of block, reversal and neuromuscular blocking agents, anesthetic, and monitor in RCTs reporting time to recovery from neuromuscular blockade in adults. </font>

```{r timeDescrKblRct}
## timeDescrKblRct -----------------------------------+ (2022-02-10 10:45) @----
# select only unique arms for studies reporting 0.8 and 0.9
time_9 <- time.dat %>%
  filter(tofr == 0.9)

time_8 <- time.dat %>%
  filter(tofr == 0.8) %>% 
  # only no time to tofr 0.9
  filter(!refid %in%  time_9$refid)

time_kbl_adult <- bind_rows(time_9, time_8) %>% 
  filter(age == "Adult") %>%
  # filter(refid == 2000) %>% 
  mutate(
    mg_kg = ifelse(arm %in%  c("Placebo", "Spont"), NA, mg_kg),
    roc = ifelse(nmbagent == "rocuronium", "&times;", NA),
    vec = ifelse(nmbagent == "vecuronium", "&times;", NA),
    cis = ifelse(nmbagent == "cisatracurium", "&times;", NA),
    miv = ifelse(nmbagent == "mivacurium", "&times;", NA),
    oth = ifelse(nmbagent %in% c("atracurium", "other"), "&times;", NA),
    tiva = ifelse(str_detect(gen_type, "tiva"), "&times;", NA),
    volatiles = ifelse(!is.na(volatiles), "&times;", NA),
    inhalation = ifelse(str_detect(gen_type, "inhal"), "&times;", NA),
    mg_kg = ifelse(!is.na(mg), paste0("<u>", mg, "</u>"), mg_kg),
    tofr_arm = str_extract(arm_id, pattern = "\\d{1}$"),
    arm_n_tofr = str_extract(arm_id, pattern = "^\\d{1}"),
    tofr_arm = factor(tofr_arm, levels = c(8, 9))
  ) %>% 
  mutate(
    depth_f = factor(depth, levels = c("Deep", "Moderate", "Shallow", "Minimal", "End of surgery", "Other"))
  ) %>%
  group_by(refid) %>% 
  mutate(
     depth_lowest_f = case_when(
      any(str_detect(depth, "Deep")) ~ "Deep",
      any(str_detect(depth, "Moderate")) ~ "Moderate",
      any(str_detect(depth, "Shallow")) ~ "Shallow",
      any(str_detect(depth, "End")) ~ "End of Surgery",
      any(str_detect(depth, "Other")) ~ "Other",
    ),
    depth_lowest_f = factor(depth_lowest_f, levels = c("Deep", "Moderate", "Shallow", "End of Surgery", "Other"))) %>% 
  ungroup() %>% 
  arrange(design, depth_lowest_f, year, refid) %>% 
  select(refid, year, design, age, depth, depth_f, study_l, id, arm_id, tofr_arm, arm_n_tofr, n, arm, mg_kg, roc, vec, cis, miv, oth,  volatiles, amg, emg, kmg, mmg, ns)

# time_kbl_adult %>%
#   filter(age == "Adult") %>%
#   arrange(design, study_l, depth_f) %>%
#   select(study_l, refid, design, depth_f) %>%
#   group_by(design, depth_f) %>%
#   tally() %>%
#   ungroup() %>%
#   mutate(
#     end = cumsum(n),
#     start = end - n + 1
#   ) %>%
#   select(design, depth_f, start, end)

time_kbl_adult %>%
  filter(design == "rct") %>% 
  group_by(study_l) %>%
  mutate(
    # depth_i = lag(depth),
    # depth = ifelse(!is.na(depth_i) & depth_i == depth, NA, depth),
    # depth = ifelse(!is.na(depth) & depth == "End of surgery", "End Surg", depth),
    # depth = ifelse(!is.na(depth) & depth == "Moderate", "Mod", depth),
    # depth = ifelse(!is.na(depth) & depth == "Shallow", "Shal", depth),
    # depth = ifelse(!is.na(depth) & depth == "Deep to Shallow", "Deep→Shal", depth),
    study_l = ifelse(row_number() != 1, "", study_l),
    tofr_arm = paste0("0.", tofr_arm),
    depth = ifelse(depth == "End of surgery", "End Surg", depth),
  ) %>%
  ungroup() %>%
  select(-c(refid:age, depth_f, arm_id, id, arm_n_tofr)) %>%
  relocate(depth, .after = mg_kg) %>%
  relocate(tofr_arm, .after = depth) %>%
  kbl(
    booktabs = T, align = c("lllllcccccccccccc"), escape = FALSE, # format = "latex",
    col.names = c("Study", " N", "Agent", "mg/kg <u>mg</u>", "Depth", "TOFR", "Roc", "Vec", "Cis", "Miv", "Oth", "Anesthetic", "AMG", "EMG", "KMG", "MMG", "NS")
  ) %>%
  add_header_above(c(" " = 2, "Reversal" = 2, " " = 1, "From" = 1, "Neuromuscular Blocking Agent" = 5, "Volatile" = 1, "Monitoring" = 5), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "4em") %>%
  column_spec(3, width = "4em", popover = "Reversal Agent") %>% 
  column_spec(4, width = "6em", popover = "mg/kg or <u>mg</u>") %>%
  column_spec(5, width = "5em", popover = "Depth of Block") %>%
  column_spec(6, width = "4em", popover = "Time from TOFR of") %>%
  column_spec(7, width = "3em", popover = "Rocuronium") %>%  
  column_spec(8, width = "3em", popover = "Vecuronium") %>%  
  column_spec(9, width = "3em", popover = "Cisatracurium") %>%  
  column_spec(10, width = "3em", popover = "Mivacurium") %>%  
  column_spec(11, width = "3em", popover = "Other") %>%  
  column_spec(12, width = "3em", popover = "Volatiles") %>%  
  column_spec(13, width = "3em", popover = "AMG") %>%  
  column_spec(14, width = "3em", popover = "EMG") %>%  
  column_spec(15, width = "3em", popover = "KMG") %>%  
  column_spec(16, width = "3em", popover = "MMG") %>%  
  column_spec(17, width = "3em", popover = "Not specified") %>%  
  pack_top(., "RCT", 1, 84, indent_tf = FALSE) %>%
  # pack_top(., "Nonrandomized Studies of Intervention", 86, 93, indent = FALSE) %>%
  # pack_top(., "Prospective Cohort", 94, 107, indent = FALSE) %>%
  # pack_top(., "Retrospective Cohort", 108, 109, indent = FALSE) %>%
  footnote(
    general = "RCT: randomized controlled trial; Neo: neostigmine; Sug: sugammadex; Spont: spontaneous; Roc: rocuronium; Vec: vecuronium; Cis: cisatracurium; Miv: mivacurium; NS: not specified; AMG: acceleromyography; EMG: electromyography; KMG: kinemyography; MMG: mechanomyography; nl: normalized AMG; Shal: shallow; Surg: surgery.",
    # alphabet = c("Used normalized readings."),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

```{r timeResultsData}
## timeResultsData ------------------------------------ (2022-02-10 10:46) @----
time_result_adult <- time.dat %>%
  filter(age == "Adult") %>%
  # filter(refid == 2287) %>% 
  mutate(
    roc = ifelse(nmbagent == "rocuronium", "&times;", NA),
    vec = ifelse(nmbagent == "vecuronium", "&times;", NA),
    cis = ifelse(nmbagent == "cisatracurium", "&times;", NA),
    miv = ifelse(nmbagent == "mivacurium", "&times;", NA),
    oth = ifelse(nmbagent %in% c("atracurium", "other"), "&times;", NA),
    tiva = ifelse(str_detect(gen_type, "tiva"), "&times;", NA),
    volatiles = ifelse(!is.na(volatiles), "&times;", NA),    
    inhalation = ifelse(str_detect(gen_type, "inhal"), "&times;", NA),
    mg_kg = ifelse(!is.na(mg), paste0("<u>", mg, "</u>"), mg_kg),
    tofr_arm = str_extract(arm_id, pattern = "\\d{1}$"),
    arm_n_tofr = str_extract(arm_id, pattern = "^\\d{1}"),
    tofr_arm = factor(tofr_arm, levels = c(8, 9))
  ) %>% 
  arrange(design, year, refid, desc(tofr_arm)) %>%
  group_by(refid) %>%
  mutate(
    tofr_compare = lag(tofr_arm, 2),
    tofr_compare = as.numeric(strtoi(tofr_compare)),
    tofr_arm = as.numeric(strtoi(tofr_arm)),
    diff = tofr_arm - tofr_compare,
    diff = ifelse(is.na(diff), 1, diff),
    depth_f = case_when(
      any(str_detect(depth, "Moderate")) ~ "Moderate",
      any(str_detect(depth, "Deep")) ~ "Deep",
      any(str_detect(depth, "Shallow")) ~ "Shallow",
      any(str_detect(depth, "Minimal")) ~ "Minimal",
      any(str_detect(depth, "End")) ~ "End of Surgery",
      any(str_detect(depth, "Other")) ~ "Other",
    ),
    depth_f = factor(depth_f, levels = c("Deep", "Moderate", "Shallow", "Minimal", "End of Surgery", "Other"))
  ) %>%
  ungroup() %>%
  # select(diff, refid, study, tofr_compare, tofr_arm, design, depth_f, year) %>% 
  arrange(design, depth_f, year, refid, desc(tofr_arm)) %>% 
  # relocate(diff, .before = refid) %>% 
  filter(diff %in% c(0, 1)) %>% # TODO: unclear if needed verify 
  mutate(
    mean = as.numeric(str_extract(mean_sd, "^\\d{1,2}\\.\\d{0,1}")),
    sd = str_extract(mean_sd, "\\d{1,2}\\.?\\d{0,2}\\)"),
    sd = as.numeric(str_replace(sd, "\\)", "")),
    conf_l = as.numeric(str_extract(mean_ci, "^\\d{1,2}\\.\\d{1,2}")),
    conf_u = as.numeric(str_extract(mean_ci, "\\d{1,2}\\.\\d{1,2}$")),
    sd = ifelse(is.na(sd) & !is.na(conf_l), sd_conf_cont_t(conf_l, conf_u, n), sd),
    med = as.numeric(str_extract(med_iqr, "^\\d{1,2}\\.?\\d{0,1}")),
    iqr_l =  str_extract(med_iqr, "\\(\\d{1,2}\\.\\d{1,2}"),
    iqr_l = as.numeric(str_replace(iqr_l, "\\(", "")),
    iqr_u =  str_extract(med_iqr, "\\d{1,2}\\.\\d{1,2}\\)"),
    iqr_u = as.numeric(str_replace(iqr_u, "\\)", "")),
    range_l = as.numeric(str_extract(range, "^\\d{1,2}\\.?\\d{0,2}")),
    range_u = as.numeric(str_extract(range, "\\d{1,3}\\.\\d{1,2}$")),
    mean_ci = ifelse(!is.na(mean_ci), paste0("(", mean_ci, ")"), mean_ci),
    range = ifelse(!is.na(range), paste0("(", range, ")"), range),
  ) %>%
  select(refid, year, design, age, depth, depth_f, study_l, study, id, arm_id, arm, mg_kg, time_from_rev, time_ns, tofr, n, mean_sd, mean_ci, med_iqr, range, mean, sd, med, iqr_l, iqr_u, range_l, range_u, volatiles)

# to verify
# select(refid, year, design, age, depth, depth_f, study_l, study, id, arm_id, arm, mg_kg, time_from_rev, time_ns, tofr, n, mean_sd, mean_ci, med_iqr, range, mean, sd, med, iqr_l, iqr_u, range_l, range_u, conf_l, conf_u) %>% 
# select(mean_sd, mean, sd, mean_ci, conf_l, conf_u, med_iqr, med, iqr_l, iqr_u, range, range_l, range_u)
# time_result_adult
``` 

<br/>

###  Minutes to Recovery

<a id="revTab8"></a>

<br/>

<font size = 4> Table `r table_n`. Time to recovery of neuromuscular blockade (TOFR >0.9) according to depth of block at reversal in RCTs enrolling adults. </font>

```{r timeResultsRctAdult}
## timeResultsRctAdult -------------------------------+ (2022-02-10 10:47) @----
temp <- time_result_adult %>%
  filter(design == "rct") %>%
  mutate(
    mean_med = coalesce(mean, med),
    # gunes 2019 set to missing as time referent not specified
    mean_med = ifelse(refid == 3285, NA, mean_med),
    study_l = ifelse(refid == 3285, str_replace(study_l, "Gunes 2019", "Gunes 2019^c^"), study_l),
    mean_med_bar = NA_character_,
    mean_med_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(mean_med, mean_med, color_4, 100), mean_med_bar),
    mean_med_bar = ifelse(arm %in% c("Sug"), bar_wn1d(mean_med, mean_med, color_1, 100), mean_med_bar),
    mean_med_bar = ifelse(arm %in% c("Neo"), bar_wn1d(mean_med, mean_med, color_2, 100), mean_med_bar),
    mean_med_bar = str_replace(mean_med_bar, ">\\d{1,2}\\.\\d{1}<", ">&nbsp;<"),
   arm_c = case_when(
     arm == "Sug" ~ cell_spec(arm, color = color_1),
     arm == "Placebo" ~ cell_spec(arm, color = color_4),
     arm == "Spont" ~ cell_spec(arm, color = color_4),
     arm == "Neo" ~ cell_spec(arm, color = color_2),
   )
  ) %>%
  select(study_l, n, arm_c, mg_kg, depth_f, mean_sd, mean_ci, med_iqr, range, mean_med_bar, tofr)

# temp %>%
#   filter(tofr == 0.9) %>%
#   arrange(depth_f) %>%
#   select(depth_f) %>%
#   group_by(depth_f) %>%
#   tally() %>%
#   ungroup() %>%
#   mutate(
#     end = cumsum(n),
#     start = end - n + 1
#   ) %>%
#   select(depth_f, start, end)

bar_ref_min <- "<span style='display: inline-block; direction: auto; unicode-bidi: plaintext; border-radius: 0px; padding-right: 0px; background-color: #e0e0de ; width: 100.00%'>  0 → 100 min</span>"

temp %>%
  filter(tofr == 0.9) %>% 
  group_by(study_l) %>%
  mutate(
    study_l = ifelse(row_number() != 1, "", study_l),
  ) %>%
  ungroup() %>%
  select(-c(tofr, depth_f)) %>% 
  kbl(
    booktabs = T, align 
    = c("lllllllll"), escape = FALSE, # format = "latex")
    col.names = c("Study", " N", "Agent",  "mg/kg <u>mg</u>", "M (SD)", "(95% CI)", "Med (IQR)", "(Range)", bar_ref_min)) %>% 
  add_header_above(c(" " = 2, "Reversal" = 2, "Minutes from Reversal to TOFR > 0.9                                                                             M or Med" = 5), bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "2em") %>%
  column_spec(3, width = "4em") %>%
  column_spec(4, width = "6em") %>%
  column_spec(5, width = "8em", popover = "Mean (SD)") %>%
  column_spec(6, width = "8em", popover = "95% CI" ) %>%
  column_spec(7, width = "8em", popover = "Med (IQR") %>%
  column_spec(8, width = "8em", popover = "Range") %>%
  column_spec(9, width = bar_width) %>% 
  pack_top(., "Deep Block^a^", 1, 12, indent_tf = FALSE) %>% 
  pack_top(., "Moderate Block^b^", 13, 48, indent_tf = FALSE) %>% 
  pack_top(., "Shallow Block^a^", 49, 56, indent_tf = FALSE) %>% 
  pack_top(., "Minimal^a^", 57, 67, indent_tf = FALSE) %>% 
  pack_top(., "End of Surgery^a^", 68, 77, indent_tf = FALSE) %>% 
  footnote(
    general = "Neo: neostigmine; Sug: sugammadex; Spont: spontaneous; M: mean; Med: median; CI: confidence interval; min: minutes.",
    alphabet = c(
      "Depth of block categorized according to Naguib et al., Consensus Statement on Perioperative Use of Neuromuscular Monitoring. Anesth Analg 2018;127:71-80.",
      "Included studies with moderate depth in neostigmine arm but deep for sugammadex.",
      "Starting time not specified."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

<a id="revFig3"></a>

###   Pooled Reversal to TOFR >0.9    

```{r metaTime9, fig.width = 10}
## metaTime9 data ------------------------------------- (2022-02-10 10:50) @----
meta_time.dat <- time_result_adult %>%
  filter(design == "rct", tofr == 0.9) %>% 
  filter(arm %in% c("Sug", "Neo")) %>% 
  select(refid, study, arm, depth_f, n, mean, sd, med, iqr_l, iqr_u, range_l, range_u, volatiles) 

# exclude studies without sug neo comparison, ie single row
compare_refids <- meta_time.dat %>% 
  group_by(refid) %>% 
  mutate(rows = row_number()) %>% 
  slice_max(rows) %>% 
  ungroup() %>% 
  filter(rows == 2) %>% 
  select(refid, rows) %>% 
  pull(refid)

meta_time.dat <- meta_time.dat %>% 
  filter(refid %in% compare_refids) %>% 
  pivot_wider(names_from = "arm", values_from = n:range_u) %>% 
  mutate(volatiles = ifelse(!is.na(volatiles), "Volatile anesthetic", "No volatiles"))

## meta analysis (updated 2022/01/18 10:27) ------------------------------
temp <- metacont(
  n.e = n_Sug, 
  n.c = n_Neo,
  # fixed = TRUE,
  mean.e = mean_Sug,
  sd.e = sd_Sug,
  median.e = med_Sug,
  q1.e = iqr_l_Sug,
  q3.e = iqr_u_Sug,
  min.e = range_l_Sug,
  max.e = range_u_Sug,
  mean.c = mean_Neo,
  sd.c = sd_Neo,
  median.c = med_Neo,
  q1.c = iqr_l_Neo,
  q3.c = iqr_u_Neo,
  min.c = range_l_Neo,
  max.c = range_u_Neo,
  data = meta_time.dat,
  # subgroup = depth_f,
  subgroup = volatiles,
  # subset = depth_f == "Moderate",
  sm = "MD",
  method.tau = "REML",
  hakn = FALSE,
  prediction = TRUE,
  studlab = study
)

forest_time <- function(time_meta){
  forest(time_meta,
  # weight.study = "random",
  fixed = FALSE,
  label.e = "Sugammadex",
  label.c = "Neostigmine",
  print.tau2 = FALSE,
  print.tau = TRUE,
  print.tau.ci = TRUE,
  digits = 1,
  digits.sd = 1,
  digits.mean = 1,
  digits.tau = 1,
  digits.pval.Q = 2,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  print.subgroup.name = FALSE,
  bylab = FALSE,
  # overall = FALSE,
  fs.xlab = 10,
  # sortvar = -TE,
  xlim = c(-80, 10),
  rightcols = c("effect", "ci"),
  rightlabs = c("MD", "95% CI     "),
  xlab = "Favors Sugammadex      Favors Neostigmine",
  smlab = "Mean Difference (minutes)",
)
}

deep <- update.meta(temp, subset = depth_f == "Deep", prediction = FALSE, subgroup = NULL)
moderate <- update.meta(temp, subset = depth_f == "Moderate")
shallow <- update.meta(temp, subset = depth_f == "Shallow", prediction = FALSE, subgroup = NULL)
minimal <- update.meta(temp, subset = depth_f == "Minimal", prediction = TRUE, subgroup = NULL)
end_surg <- update.meta(temp, subset = depth_f == "End of Surgery", prediction = FALSE, subgroup = NULL)
# forest_time(temp)

## save ----------------------------------------------- (2022-02-10 14:08) @----
# forest_time(shallow)
# forest_time(deep)
# forest_time(minimal)
# forest_time(end_surg)

# summary(temp)

# forest(temp,
#   weight.study = "random",
#   fixed = FALSE,
#   label.e = "Sugammadex",
#   label.c = "Neostigmine",
#   print.tau2 = FALSE,
#   print.tau = TRUE,
#   print.tau.ci = TRUE,
#   digits = 1,
#   digits.sd = 1,
#   digits.mean = 1,
#   digits.tau = 1,
#   digits.pval.Q = 2,
#   overall.hetstat = TRUE,
#   print.I2.ci = TRUE,
#   print.subgroup.name = FALSE,
#   bylab = FALSE,
#   # overall = FALSE,
#   fs.xlab = 10,
#   # sortvar = -TE,
#   xlim = c(-50, 10),
#   rightcols = c("effect", "ci"),
#   rightlabs = c("SD", "95% CI     "),
#   xlab = "Favors Sugammadex      Favors Neostigmine",
#   smlab = "Mean Difference (minutes)"
# )

# 
# par(bty = "n", xaxt = "l", yaxt = "l")
# funnel(temp, contour = c(0.9, 0.95, 0.99))
# figure_n <- fig_inc()
# temp_1 <- update(temp, subgroup = NULL)
# metabias(temp_1)
# metabias(temp_1, plotit = TRUE, k.min = 5, method = "Pustejovsky")

```

<a id="revFig4"></a>

<br/>

<font size = 4> Figure `r figure_n`. Difference in time to recovery in minutes (TOFR >0.9) from deep block to reversal in RCTs enrolling adults. </font>

```{r metaTimeDeep, fig.width = 10, fig.height = 3.7}
forest_time(deep)
grid::grid.text("Deep Block", .1, .9, gp = grid::gpar(cex = 1.3))
figure_n <- fig_inc()
```

<a id="revFig5"></a>

<br/>

<font size = 4> Figure `r figure_n`. Difference in time to recovery in minutes (TOFR >0.9) from moderate block to reversal in RCTs enrolling adults. </font>

```{r metaTimeModerate, fig.width = 10, fig.height = 6.9}
forest_time(moderate)
grid::grid.text("Moderate Block", .1, .95, gp = grid::gpar(cex = 1.2))
figure_n <- fig_inc()
```
Hartung-Knapp adjustment not applied to allow comparability with other levels of block; overall result yielded the same confidence interval with or without. No indication of potential small-study effects in funnel plot or regression test. 

```{r smallStudyEffectsModerate, eval = FALSE}
## smallStudyEffects ---------------------------------- (2022-04-04 09:58) @----
temp_meta <- moderate
temp_meta <- update(temp_meta, subgroup = NULL)
metabias(temp_meta, method.bias = "Egger")
funnel(temp_meta)
```

<a id="revFig6"></a>

<br/>

<font size = 4> Figure `r figure_n`. Difference in time to recovery in minutes (TOFR >0.9) from shallow block to reversal in RCTs enrolling adults. </font>

```{r metaTimeShallow, fig.width = 10, fig.height = 3.7}
forest_time(shallow)
grid::grid.text("Shallow Block", .1, .9, gp = grid::gpar(cex = 1.2))
figure_n <- fig_inc()
```

<a id="revFig7"></a>

<br/>

<font size = 4> Figure `r figure_n`. Difference in time to recovery in minutes (TOFR >0.9) from minimal block to reversal in RCTs enrolling adults. </font>

```{r metaTimeMinimal, fig.width = 10, fig.height = 3}
forest_time(minimal)
grid::grid.text("Minimal Block", .1, .9, gp = grid::gpar(cex = 1.2))
figure_n <- fig_inc()
```

<a id="revFig8"></a>

<br/>

<font size = 4> Figure `r figure_n`. Difference in time to recovery in minutes (TOFR >0.9) from end of surgery block to reversal in RCTs enrolling adults. </font>

```{r metaTimeEndSurg, fig.width = 10, fig.height = 3.8}
forest_time(end_surg)
grid::grid.text("From End of Surgery", .14, .8, gp = grid::gpar(cex = 1.2))
figure_n <- fig_inc()
```

### <u>Adults Observational</u>

###  Agents, Anesthetics, and Monitors 

<br/>

<font size = 4> Table `r table_n`. Reversal and neuromuscular blocking agents, anesthetic, and monitor in observational studies reporting time to recovery from neuromuscular blockade in adults. </font>

```{r timeDescrKblObs}

## timeDescrKblRct (updated 2022/01/17 14:02) -----------------------------
# time_kbl_adult %>%
#   filter(design != "rct") %>% 
#   arrange(design, study_l) %>%
#   select(study_l, refid, age, design) %>%
#   group_by(age, design) %>%
#   tally() %>%
#   ungroup() %>%
#   mutate(end = cumsum(n),
#          start = end - n + 1) %>%
#   select(age, design, start, end)

time_kbl_adult %>%
  filter(design != "rct") %>%
  group_by(study_l) %>%
  mutate(
    depth_i = lag(depth),
    depth = ifelse(!is.na(depth_i) & depth_i == depth, NA, depth),
    depth = ifelse(!is.na(depth) & depth == "End of surgery", "End Surg", depth),
    # depth = ifelse(!is.na(depth) & depth == "Moderate", "Mod", depth),
    # depth = ifelse(!is.na(depth) & depth == "Shallow", "Shal", depth),
    depth = ifelse(!is.na(depth) & depth == "Deep to Shallow", "Deep→Shal", depth),
    study_l = ifelse(row_number() != 1, "", study_l),
  ) %>%
  ungroup() %>%
  select(-c(refid:age, depth_f, id:arm_n_tofr, depth_i, cis, miv, oth, emg:ns)) %>%
  relocate(depth, .after = mg_kg) %>%
  kbl(
    booktabs = T, align = c("lllllccccc"), escape = FALSE, # format = "latex",
    col.names = c("Study", " N", "Agent (subgroup)", "mg/kg", "Depth", "Roc", "Vec", "Anesthetic", "AMG")
  ) %>%
  add_header_above(c(" " = 2, "Reversal" = 2, "Block" = 1, "NMBA" = 2, "Volatile" = 1, "Monitoring" = 1), line = TRUE, bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "4em") %>%
  column_spec(3, width = "10em", popover = "Reversal Agent") %>%
  column_spec(4, width = "6em", popover = "mg/kg or <u>mg</u>") %>%
  column_spec(5, width = "5em", popover = "Depth of Block") %>%
  column_spec(6, width = "3em", popover = "Rocuronium") %>%
  column_spec(7, width = "3em", popover = "Vecuronium") %>%
  column_spec(8, width = "3em", popover = "Volatile") %>%
  column_spec(9, width = "3em", popover = "AMG") %>%
  pack_top(., "Nonrandomized Studies of Intervention", 1, 8, indent_tf = FALSE) %>%
  pack_top(., "Prospective Cohort", 9, 22, indent_tf = FALSE) %>%
  pack_top(., "Retrospective Cohort", 23, 24, indent_tf = FALSE) %>%
  footnote(
    general = c("Neo: neostigmine; Sug: sugammadex; Roc: rocuronium; Vec: vecuronium; AMG: acceleromyography."),
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
``` 

<br/>

###  Minutes to Recovery

<a id="revTab8"></a>

<br/>

<font size = 4> Table `r table_n`. Time to recovery of neuromuscular blockade (TOFR >0.9) according to depth of block at reversal in observational studies enrolling adults.</font>

```{r timeResultsObsAdults}
## timeResultsRctAdults ------------------------------ (2022-04-03 14:31) @----
temp <- time_result_adult %>%
  filter(design != "rct") %>%
  mutate(
    mean_med = coalesce(mean, med),
    # gunes 2019 set to missing as time referent not specified
    mean_med_bar = NA_character_,
    mean_med_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(mean_med, mean_med, color_4, 30), mean_med_bar),
    mean_med_bar = ifelse(str_detect(arm, "Sug"), bar_wn1d(mean_med, mean_med, color_1, 30), mean_med_bar),
    mean_med_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(mean_med, mean_med, color_2, 30), mean_med_bar),
    # mean_med_bar = str_replace(mean_med_bar, ">\\d{1,2}\\.\\d{1}<", ">&nbsp;<"),
   arm_c = case_when(
     str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
     str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
     str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
     str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
   )
  ) %>%
  arrange(depth_f, design, refid) %>% 
  select(study_l, n, arm_c, design, mg_kg, depth_f, mean_sd, mean_ci, med_iqr, range, mean_med_bar, tofr)

bar_ref_min <- "<span style='display: inline-block; direction: auto; unicode-bidi: plaintext; border-radius: 0px; padding-right: 0px; background-color: #e0e0de ; width: 100.00%'>  0   →   30 min</span>"

# temp %>%
#   filter(design != "rct") %>%
#   arrange(design, depth_f, study_l) %>%
#   select(study_l,  depth_f, design) %>%
#   group_by(depth_f, design) %>%
#   tally() %>%
#   ungroup() %>%
#   mutate(end = cumsum(n),
#          start = end - n + 1) %>%
#   select(depth_f, design, start, end)

temp %>%
  filter(tofr == 0.9) %>% 
  group_by(study_l) %>%
  mutate(
    study_l = ifelse(row_number() != 1, "", study_l),
  ) %>%
  ungroup() %>%
  select(-c(design, tofr, depth_f)) %>% 
  kbl(
    booktabs = T, align = c("lllllllll"), escape = FALSE, # format = "latex")
    col.names = c("Study", " N", "Agent",  "mg/kg", "M (SD)", "(95% CI)", "Med (IQR)", "(Range)", bar_ref_min)) %>% 
  add_header_above(c(" " = 2, "Reversal" = 2, "Minutes from Reversal to TOFR > 0.9                                                               M or Med" = 5), bold = TRUE) %>%   row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "2em") %>%
  column_spec(3, width = "12em") %>%
  column_spec(4, width = "4em") %>%
  column_spec(5, width = "6em", popover = "Mean (SD)") %>%
  column_spec(6, width = "7em", popover = "95% CI" ) %>%
  column_spec(7, width = "5em", popover = "Med") %>%
  column_spec(8, width = "7em", popover = "Range") %>%
  column_spec(9, width = bar_width, popover = "Mean or Median") %>% 
  # pack_top(., "Deep Block^a^", 1, 5, indent_tf = FALSE) %>% 
  # pack_sub_bold(., "Nonrandomized Studies of Interventions", 1, 2) %>% 
  # pack_sub_bold(., "Prospective Cohort", 3, 4) %>% 
  # pack_sub_bold(., "Retrospective Cohort", 5, 5) %>% 
  pack_top(., "Moderate Block^a^", 1, 14, indent_tf = FALSE) %>% 
  pack_sub_bold(., "Nonrandomized Studies of Interventions", 1, 8) %>% 
  pack_sub_bold(., "Prospective Cohort", 9, 12) %>% 
  pack_sub_bold(., "Retrospective Cohort", 13, 14) %>% 
  pack_top(., "Shallow Block^a^", 15, 16, indent_tf = FALSE) %>% 
  pack_sub_bold(., "Prospective Cohort", 15, 16) %>%
  pack_top(., "Other", 17, 24, indent_tf = FALSE) %>% 
  pack_sub_bold(., "Prospective Cohort", 17, 24) %>%
  footnote(
    general = "Neo: neostigmine; Sug: sugammadex; Spont: spontaneous; M: mean; Med: median; CI: confidence interval; NS: not specified; RBW: actual body weight; IBW: ideal body weight; ",
    alphabet = c(
      "Depth of block categorized according to Naguib et al., Consensus Statement on Perioperative Use of Neuromuscular Monitoring. Anesth Analg 2018;127:71-80."
    ),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

## <u>Adults</u>

## * Adverse Events*

```{r adverseData}
## adverseData ---------------------------------------- (2022-02-28 16:07) @----
adverse.dat <- suppressWarnings(readxl::read_xlsx("data/RevAgentSummary011122_mg.xlsx",
  sheet = "Adverse Events", range = "A4:N79",
  col_types = c("numeric", rep("text", 6), "numeric", rep("text", 6))
)) %>%
  rename_with(., ~ tolower(.x)) %>%
  clean_names() %>%
  remove_empty(which = "cols") %>%
  mutate(refid = as.numeric(refid)) %>%
  remove_empty(which = "rows") %>%
  fill(refid:study) %>%
  mutate(
    antichol = ifelse(arm != "Neo", NA, antichol),
    design = tolower(design),
    anaph_n = as.numeric(str_extract(anaphylaxis, "^\\d*")),
    brady_n = as.numeric(str_extract(bradycardia, "^\\d*")),
    tachy_n = as.numeric(str_extract(tachycardia, "^\\d*")),
    arrhyth_n = as.numeric(str_extract(arrhythmias, "^\\d*")),
    other_n = str_extract(other, "^\\d*"),
    upper_dose = str_extract(mg_kg, "\\d?\\.?\\d{1,3}$"), # upper dose reversal agent
    arm_dist = str_extract(arm, "^\\w{3,5}"),
    # age = ifelse(refid %in% c(3280, 7030, 2976, 3628, 2177, 3381, 3384), "peds", "adult")
  ) %>%
  relocate(c(anaph_n, brady_n, tachy_n, arrhyth_n, other_n), .after = n) %>% 
  select(-c(design)) %>% # replace with from study char
  left_join(., study_ident[, c("refid", "study_l", "age", "design")], by = "refid") %>% 
  relocate(study_l:design, .before = study)

popc.dat <- suppressWarnings(readxl::read_xlsx("data/RevAgentSummary011122_mg.xlsx",
  sheet = "POPC", range = "A4:U121",
  col_types = c("numeric", rep("text", 4), "numeric", rep("text", 15))
)) %>%
  rename_with(., ~ tolower(.x)) %>%
  clean_names() %>%
  remove_empty(which = "cols") %>%
  mutate(
    # fix cells with space
    refid = as.numeric(refid),
    across(everything(), ~ na_if(., " ")),
    across(everything(), ~ na_if(., " ")),
    hypox_le_90_n = as.numeric(str_extract(le_90, "^\\d*")),
    hypox_gt_90_95_n = as.numeric(str_extract(gt_90_95, "^\\d*")),
    hypox_ns_n = as.numeric(str_extract(ns, "^\\d*")),
    composite_n = as.numeric(str_extract(composite, "^\\d*")),
    altelectasis_n = as.numeric(str_extract(atelectasis, "^\\d*")),
    pneumonia_n = as.numeric(str_extract(pneumonia, "^\\d*")),
    obstruct_n = as.numeric(str_extract(up_obstruct, "^\\d*")),
    resp_fail_n = as.numeric(str_extract(resp_fail, "^\\d*")),
    reintub_n = as.numeric(str_extract(reintub, "^\\d*")),
    bronchospasm_n = as.numeric(str_extract(bronchospasm, "^\\d*")),
    upper_dose = str_extract(mg_kg, "\\d?\\.?\\d{1,3}$"), # upper dose reversal agent
    arm_dist = str_extract(arm, "^\\w{3,5}"),
  ) %>%
  remove_empty(which = "rows") %>%
  mutate(across(.fns = ~ replace(., str_detect(., "^ {1,2}"), NA))) %>%
  fill(refid:study) %>%
  # select(-age) %>%
  left_join(., study_ident[, c("refid", "study_l", "age", "design")], by = "refid") %>%
  relocate(study_l:design, .before = study) %>%
  rename(arm_n = n) %>%
  left_join(., study_arm_rev.dat[, c("refid", "arm", "arm_n", "depth_rev_f")], by = c("refid", "arm", "arm_n")) %>%
  # delete eroneous Niu 2020 match
  distinct() %>% 
  relocate(depth_rev_f, .before = arm) %>% 
  select(-c(le_90:resp_fail))

ponv.dat <- suppressWarnings(readxl::read_xlsx("data/RevAgentSummary011122_mg.xlsx",
  sheet = "PONV", range = "A5:K113",
  col_types = c("numeric", rep("text", 5), "numeric", rep("text", 4))
)) %>%
  rename_with(., ~ tolower(.x)) %>%
  clean_names() %>%
  remove_empty(which = "cols") %>%
  mutate(refid = as.numeric(refid)) %>%
  remove_empty(which = "rows") %>%
  fill(refid:study) %>%
  mutate(
    mg_kg = ifelse(!is.na(mg), paste0("<u>", mg, "</u>"), mg_kg),
    design = tolower(design),
    ponv_n = as.numeric(str_extract(ponv, "^\\d*")),
    nausea_n = as.numeric(str_extract(nausea, "^\\d*")),
    vomit_n = as.numeric(str_extract(vomit, "^\\d*")),
    upper_dose = str_extract(mg_kg, "\\d?\\.?\\d{1,3}$"), # upper dose reversal agent
    arm_dist = str_extract(arm, "^\\w{3,5}"),
  ) %>%
  relocate(c(ponv_n, nausea_n, vomit_n), .after = arm_n) %>% 
  select(-c(design, ponv, nausea, vomit)) %>% # replace with from study char
  left_join(., study_ident[, c("refid", "study_l", "age", "design")], by = "refid") %>% 
  relocate(study_l:design, .before = study)

# refids from spreadsheets
adverse_refids <- unique(adverse.dat$refid)
popc_refids <- unique(popc.dat$refid)
ponv_refids <- unique(ponv.dat$refid)

```

###  Reversal Agent Dosing

<br/>

<font size = 4> Table `r table_n`. Reversal agent dosing in randomized controlled trials. </font>

```{r reversalDoseRct}
## reversalDoseRct ------------------------------------ (2022-02-13 05:36) @----
adverse_rct <- adverse.dat %>% 
  filter(design == "rct", age == "Adult")

# reversal agent doses
adverse_rct %>% 
  mutate(
    arm = str_replace(arm, " .*$", ""),
  ) %>%
  filter(!arm %in% c("Placebo", "Spont")) %>% 
  rename(Agent = arm) %>% 
  group_by(Agent) %>% 
  tabyl(Agent, mg_kg) %>% 
  select(-NA_) %>% 
  kbl(
    booktabs = T, align = c("lcccccccccccc"), escape = TRUE, # format = "latex",
    # col.names = c("            ID", "Study", "Analyzed (N)", "Centers", "Country^a^", "Surgery")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>% 
  add_header_above(c(" " = 1, "Dose (mg/kg), Studies (N)" = 12), line = TRUE, bold = TRUE, align = "c") %>% 
  column_spec(1, width = "8em") %>%
  column_spec(c(2:13), width = "4em")

table_n <- tab_inc()
```

<br/>

<font size = 4> Table `r table_n`. Reversal agent dosing in adult observational studies. </font>

```{r reversalDoseObs}
## reversalDoseObs ------------------------------------ (2022-02-13 05:36) @----
adverse_obs <- adverse.dat %>% 
  filter(!design == "rct", age == "Adult")

# reversal agent dose
adverse_obs %>% 
  mutate(
    arm = str_replace(arm, " .*", ""),
  ) %>%
  filter(!arm %in% c("Placebo", "Spont")) %>% 
  rename(Agent = arm) %>% 
  select(Agent, mg_kg, refid) %>% 
  distinct() %>%  # study level data if multiple arms same dose
  group_by(Agent) %>% 
  tabyl(Agent, mg_kg) %>% 
  kbl(
    booktabs = T, align = c("lccc"), escape = TRUE, # format = "latex",
    # col.names = c("            ID", "Study", "Analyzed (N)", "Centers", "Country^a^", "Surgery")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>% 
  add_header_above(c(" " = 1, "Dose (mg/kg), Studies (N)" = 3), line = TRUE, bold = TRUE, align = "c") %>% 
  column_spec(1, width = "8em") %>%
  column_spec(c(2:4), width = "4em") %>% 
  footnote(general = "NS: not specified.",
           # number = c("● Limited, ●● Important, ●●● Critical."),
           general_title = "",
           footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

###  Anaphylaxis

<a id="revTab13"></a>

<br/>

<font size = 4> Table `r table_n`. Anaphylaxis in studies enrolling adult patients.  </font>

```{r anaphylaxis}
## anaphylaxis ---------------------------------------+ (2022/04/02 10:07) @----
adverse.dat %>% 
  filter(age %in% c("Adult", "All ages")) %>% 
  mutate(year = str_extract(study, "\\d{4}"),
         anaph_np = n_percent_dig(anaph_n, anaph_n/n * 100, 2),
         # design = factor(design, levels = c("prospective", "retro", "case control"))
         ) %>% 
  filter(!is.na(anaph_n)) %>%
  arrange(age, design, year, refid) %>% 
  select(study_l, arm, n, anaph_np) %>% 
  group_by(study_l) %>% 
  mutate(study_l = ifelse(row_number() != 1, NA, study_l)) %>% 
 kbl(
    booktabs = T, align = c("llrc"), escape = TRUE, # format = "latex",
    col.names = c("Study", "Agent", "N   ", "Anaphylaxis, N (%)")
  ) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>% 
  # add_header_above(c(" " = 1, "Dose (mg/kg)" = 6), line = TRUE, bold = TRUE, align = "c") %>% 
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "5em") %>% 
  column_spec(3, width = "6em") %>% 
  column_spec(4, width = "14em") %>% 
  pack_rows(., "Prospective Cohort", 1, 2, indent = FALSE) %>% 
  pack_rows(., "Retrospective Cohort", 3, 8, indent = FALSE) %>% 
  pack_sub_bold(., "All ages", 5, 8) %>% 
  # pack_rows(., "Case Control", 9, 10) %>% 
  footnote(general = "IBW: ideal body weight.",
  #        number = c("● Limited, ●● Important, ●●● Critical."),
           general_title = "",
           footnote_as_chunk = FALSE)

  table_n <- tab_inc()
```
Anaphylaxis was unreported with neostigmine (3 studies, 26051 patients); in patients receiving sugammadex (5 studies, 88192 patients) the pooled incidence was 1.6 per 10,000 (95% CI, 0.9, 2.7), 𝜏 = 0.8 (identical to the exact confidence interval for 8 events in a sample of 88192).


```{r anaphylaxisPooled, eval = FALSE}
anaphylaxis <- adverse.dat %>% 
  filter(age %in% c("Adult", "All ages")) %>% 
  mutate(year = str_extract(study, "\\d{4}"),
         # anaph_np = n_percent_dig(anaph_n, anaph_n/n * 100, 2),
         # design = factor(design, levels = c("prospective", "retro", "case control"))
         ) %>% 
  filter(!is.na(anaph_n)) %>%
  # arrange(age, design, year, refid) %>% 
  select(study, arm, n, anaph_n)

metaprop(anaph_n,
  n,
  pscale = 10000,
  subset = str_detect(arm, "Sug"),
  data = anaphylaxis
)

```

<br/>

###  Bradycardia

<a id="revTab14"></a>

<br/>

<font size = 4> Table `r table_n`. Bradycardia </font>

```{r bradycardia}
## tally ---------------------------------------------- (2022/04/02 10:20) @----
# temp %>%
#     filter() %>%
#     arrange(design, study) %>%
#     select(study, refid, design) %>%
#     group_by(design) %>%
#     tally() %>%
#     ungroup() %>%
#     mutate(
#           end = cumsum(n),
#               start = end - n + 1
#             ) %>%
#     select(design, start, end)

## bradycardia ---------------------------------------- (2022/04/02 10:20) @----
depth_rev_brad.dat <- depth_rev.dat %>% 
  mutate(arm_n = case_when(
    refid == 2287 & arm_dist == "Sug" ~ 43,
    refid == 2287 & arm_dist == "Neo" ~ 51,
    TRUE ~ arm_n
  ))

adverse.dat %>%
  rename(arm_n = n) %>% 
  left_join(., depth_rev_brad.dat, by = c("refid", "arm_dist", "arm_n")) %>% 
  # select(refid, study, arm, arm_n, arm_c, depth_rev_f, volatile) %>% 
  filter(age == "Adult") %>%
  mutate(
    year = str_extract(study, "\\d{4}"),
    brady_p = brady_n / arm_n * 100,
    brady_np = n_percent_dig(brady_n, brady_n / arm_n * 100, 1),
    brady_p_bar = NA_character_,
    brady_p_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(brady_p, brady_p, color_4, 100), brady_p_bar),
    brady_p_bar = ifelse(arm %in% c("Sug"), bar_wn1d(brady_p, brady_p, color_1, 100), brady_p_bar),
    brady_p_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(brady_p, brady_p, color_2, 100), brady_p_bar),
    brady_p_bar = str_replace(brady_p_bar, ">.*<", ">&nbsp;<"),
    volatile = ifelse(volatile, "\U000D7", NA), 
    depth_rev_f = paste0("   ", depth_rev_f),
    arm_c = case_when(
      str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
      str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
    )
  ) %>%
  filter(!is.na(brady_n)) %>%
  arrange(design, year, refid) %>%
  select(study_l, arm_n, arm_c, mg_kg, volatile, depth_rev_f, brady_np, brady_p_bar) %>%
  group_by(study_l) %>%
  mutate(study_l = ifelse(row_number() != 1, NA, study_l)) %>%
  ungroup() %>% 
  kbl(
    booktabs = T, align = c("llllclll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "N", "Agent", "mg/kg", "Volatile", "  Depth", "N (%)", bar_ref)
  ) %>%
  add_header_above(c(" " = 3, "Dose              " = 1, " " = 1, "Reversal             " = 1, "Bradycardia" = 2), line = TRUE, border_left = TRUE, bold = TRUE, align = "c") %>%
  row_spec(0, bold = TRUE, align = "l") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "6em") %>%
  column_spec(3, width = "8em") %>%
  column_spec(4, width = "6em") %>%
  column_spec(5, width = "4em") %>%
  column_spec(6, width = "6em") %>%
  column_spec(7, width = "6em") %>%
  column_spec(8, width = bar_width) %>%
  pack_rows(., "RCT", 1, 44, indent = FALSE) %>%
  pack_rows(., "Nonrandomized Trial", 45, 46, indent = FALSE) %>%
  pack_rows(., "Retrospective Cohort", 47, 48, indent = FALSE) %>%
  # pack_rows(., "Case Control", 9, 10) %>%
  footnote(
    general = "IBW: ideal body weight.",
    #        number = c("● Limited, ●● Important, ●●● Critical."),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

###     *Pooled*

<a id="revFig9"></a>

<br/>

<font size = 4> Figure `r figure_n`. Bradycardia pooled results from RCTs comparing sugammadex and neostigmine. </font>

```{r pooledBrady, fig.width = 10, fig.height = 6}
## pooledBrady --------------------------------------- (2022/04/02 10:21) @----
brady_meta.dat <- adverse.dat %>%
  filter(age == "Adult", design == "rct") %>%
  filter(arm %in% c("Neo", "Sug", "Neo LBW", "Sug TBW", "Neo (no Mg)", "Spont (no Mg)")) %>%
  filter(!is.na(brady_n)) %>%
  mutate(arm = str_replace(arm, " .*", "")) %>%
  group_by(study) %>%
  filter(n() > 1) %>%
  ungroup() %>%
  filter(refid != 2004) %>% # Suy 2007 not sug:neo comparison
  select(refid, study, arm, brady_n, n, mg_kg) %>%
  pivot_wider(names_from = arm, values_from = c(brady_n, n, mg_kg)) %>% 
  # means when range neo
  mutate(
    mg_kg_Neo = case_when(
      study == "Schaller 2010"   ~ "0.02", 
      study == "Brueckmann 2015" ~ "0.05", 
      study == "Quang 2019"      ~ "0.05", 
      TRUE ~ mg_kg_Neo
    )
  ) 
  # add reversal depth; need to use only selected arm
  # left_join(., study_arm_rev.dat %>% select(refid, depth_rev_f), by = "refid")

# get upper dose data
# temp_upper_dose <- adverse.dat %>% 
#   filter(arm == "Neo") %>% 
#   select(refid, upper_dose)
# brady_meta_upper.dat <- left_join(brady_meta.dat, temp_upper_dose, by = "refid") %>% 
#   filter(upper_dose < 0.05)
# rm(temp_upper_dose)

brady_meta <- metabin(brady_n_Sug, n_Sug, brady_n_Neo, n_Neo,  
  data = brady_meta.dat,
  # data = brady_meta_upper.dat,
  studlab = study,
  sm = "RD",
  method = "MH",
  method.tau = "PM",
  pscale = 100,
  # allstudies = FALSE,
  hakn = TRUE,
  prediction = TRUE)
  # subset = !study_orig %in% c("Wu 2014 (Chinese)", "Wu 2014 (Caucasian)"),
  #subgroup = depth)

forest(brady_meta,
  fixed = FALSE,
  label.c = "Sugammadex",
  label.e = "Neostigmine",
  rightcols = c("effect", "ci"),
  rightlabs = c(" ", "(95% CI)"),
  digits = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  allstudies = FALSE,
  colgap.left = "4mm",
  # subgroup = FALSE,
  # print.subgroup.name = FALSE,
  # text.subgroup.nohet = TRUE,
  colgap.forest.left = "5mm",
  xlim = c(-40, 10),
  # at = c(0.1, 1, 10, 100),
  xlab = "Neostigmine                         Sugammadex \n Worse                                   Worse")

figure_n <- fig_inc()

# pdf("/Users/mgrant/Desktop/bradyUpperLTE0.4.pdf", width = 10.5, height = 7.5)
# dev.off()
```
No indication for small study effects (potential publication bias) for risk ratio or odds ratio in regression tests or funnel plot. 

```{r smallStudyEffectsBrady, eval = FALSE}
## smallStudyEffects ---------------------------------- (2022-04-04 09:58) @----
temp_meta <- brady_meta
temp_meta <- update(temp_meta, subgroup = NULL, sm = "OR")
metabias(temp_meta, method.bias = "Egger")
metabias(temp_meta, method.bias = "Harbord")
funnel(temp_meta)
```


<br/>

<a id="revFig10"></a>

<br/>

<font size = 4> Figure `r figure_n`. Bradycardia in neostigmine arms by dose. </font>

```{r neoRate, fig.width = 10, fig.height = 5.5}
## neoRate -------------------------------------------- (2022-02-28 16:09) @----
temp <- brady_meta.dat %>% 
  arrange(mg_kg_Neo)

neo_brady_meta <- metaprop(brady_n_Neo, n_Neo,
  data = temp,
  fixed = FALSE,
  studlab = study
)

neo_brady_meta$neo_dose <- temp$mg_kg_Neo

forest(neo_brady_meta,
  rightcols = c("effect", "ci", "neo_dose"),
  rightlabs = c(" ", "95% CI    " , "Mean Dose (mg/kg)"),
  studlab = TRUE,
  comb.fixed = FALSE,
  digits = 1,
  digits.tau2 = 1,
  pscale = 100,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  allstudies = FALSE,
  colgap.left = "5mm",
  colgap.forest.left = "20mm"
  # subgroup = FALSE,
  # print.subgroup.name = FALSE,
  # text.subgroup.nohet = TRUE,
  # log = "x"
)

figure_n <- fig_inc()
```

<br/>

###  Tachycardia (adults) RCTs

<a id="revTab15"></a>

<br/>

<font size = 4> Table `r table_n`. Tachycardia. </font>

```{r tachycardia}
## tachyData ------------------------------------ (2022-02-28 16:15) @----
# temp %>%
#     filter() %>%
#     arrange(age, design, study) %>%
#     select(study, refid, age, design) %>%
#     group_by(age, design) %>%
#     tally() %>%
#     ungroup() %>%
#     mutate(
#           end = cumsum(n),
#               start = end - n + 1
#             ) %>%
#     select(age, design, start, end)

adverse.dat %>%
  filter(age == "Adult") %>%
  mutate(
    year = str_extract(study, "\\d{4}"),
    tachy_p = tachy_n / n * 100,
    tachy_np = n_percent_dig(tachy_n, tachy_n / n * 100, 1),
    design = factor(design, levels = c("rct", "prospective", "retro", "case control")),
    tachy_p_bar = NA_character_,
    tachy_p_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(tachy_p, tachy_p, color_4, 100), tachy_p_bar),
    tachy_p_bar = ifelse(arm %in% c("Sug"), bar_wn1d(tachy_p, tachy_p, color_1, 100), tachy_p_bar),
    tachy_p_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(tachy_p, tachy_p, color_2, 100), tachy_p_bar),
    tachy_p_bar = str_replace(tachy_p_bar, ">.*<", ">&nbsp;<"),
    arm_c = case_when(
      str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
      str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
    )
  ) %>%
  filter(!is.na(tachy_n)) %>%
  arrange(design, year, refid) %>%
  select(study, n, arm_c, mg_kg, tachy_np, tachy_p_bar) %>%
  group_by(study) %>%
  mutate(study = ifelse(row_number() != 1, NA, study)) %>%
  kbl(
    booktabs = T, align = c("llllll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "N", "Agent", "mg/kg", "Tachycardia, N (%)", bar_ref)
  ) %>%
  row_spec(0, bold = TRUE, align = "l") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  # add_header_above(c(" " = 1, "Dose (mg/kg)" = 6), line = TRUE, bold = TRUE, align = "c") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "6em") %>%
  column_spec(c(3, 4), width = "8em") %>%
  column_spec(5, width = "11em") %>%
  column_spec(6, width = bar_width) %>%
  pack_rows(., "RCT", 1, 10, indent = FALSE)
# footnote(general = "IBW: ideal body weight.",
#        number = c(""),
#          general_title = "",
#          footnote_as_chunk = FALSE)

table_n <- tab_inc()  
```

<br/>

###     *Pooled*

<a id="revFig11"></a>

<br/>

<font size = 4> Figure `r figure_n`. Tachycardia pooled results from RCTs comparing sugammadex and neostigmine. </font>

```{r pooledTachy, fig.width = 10, fig.height = 3.5}
## pooledTachy --------------------------------------- (2022-02-28 16:07) @----
tachy_meta.dat <- adverse.dat %>%
  filter(age == "Adult", design == "rct") %>%
  filter(arm %in% c("Neo", "Sug", "Neo LBW", "Sug TBW", "Neo (no Mg)", "Spont (no Mg)")) %>%
  filter(!is.na(tachy_n)) %>%
  mutate(arm = str_replace(arm, " .*", "")) %>%
  group_by(study) %>%
  filter(n() > 1) %>%
  ungroup() %>%
  filter(refid != 2004) %>% # Suy 2007 not sug:neo comparison
  select(refid, study, arm, tachy_n, n, mg_kg) %>%
  pivot_wider(names_from = arm, values_from = c(tachy_n, n, mg_kg)) %>% 
  # means when range neo
  mutate(
    mg_kg_Neo = case_when(
      study == "Schaller 2010"   ~ "0.02", 
      study == "Brueckmann 2015" ~ "0.05", 
      study == "Quang 2019"      ~ "0.05", 
      TRUE ~ mg_kg_Neo
    )
  ) 
  # add reversal depth; need to use only selected arm
  # left_join(., study_arm_rev.dat %>% select(refid, depth_rev_f), by = "refid")

tachy_meta <- metabin(tachy_n_Neo, n_Neo, tachy_n_Sug, n_Sug, 
  data = tachy_meta.dat,
  studlab = study,
  sm = "RD",
  method = "MH",
  method.tau = "PM",
  # allstudies = FALSE,
  hakn = FALSE,
  prediction = FALSE)
  # subset = !study_orig %in% c("Wu 2014 (Chinese)", "Wu 2014 (Caucasian)"),
  #subgroup = depth)

forest(tachy_meta,
  fixed = FALSE,
  label.c = "Sugammadex",
  label.e = "Neostigmine",
  rightcols = c("effect", "ci"),
  rightlabs = c(" ", "(95% CI)"),
  pscale = 100,
  digits = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  pooled.events = TRUE,
  allstudies = FALSE,
  colgap.left = "4mm",
  # subgroup = FALSE,
  # print.subgroup.name = FALSE,
  # text.subgroup.nohet = TRUE,
  colgap.forest.left = "5mm",
  xlim = c(-10, 30),
  # at = c(0.1, 1, 10, 100),
  xlab = "Sugammadex                      Neostigmine\n Worse                           Worse")

figure_n <- fig_inc()
```

<br/>

###  Arrhythmias (adults) RCTs

<a id="revTab16"></a>

<br/>

<font size = 4> Table `r table_n`. Arrhythmia </font>

```{r arrythmia}
## arrhythmia ----------------------------------------- (2022-02-28 16:15) @----
# temp %>%
#     filter() %>%
#     arrange(age, design, study) %>%
#     select(study, refid, age, design) %>%
#     group_by(age, design) %>%
#     tally() %>%
#     ungroup() %>%
#     mutate(
#           end = cumsum(n),
#               start = end - n + 1
#             ) %>%
#     select(age, design, start, end)

adverse.dat %>%
  filter(age == "Adult") %>%
  mutate(
    year = str_extract(study, "\\d{4}"),
    arrhyth_p = arrhyth_n / n * 100,
    arrhyth_np = n_percent_dig(arrhyth_n, arrhyth_n / n * 100, 1),
    design = factor(design, levels = c("rct", "prospective", "retro", "case control")),
    arrhyth_p_bar = NA_character_,
    arrhyth_p_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(arrhyth_p, arrhyth_p, color_4, 100), arrhyth_p_bar),
    arrhyth_p_bar = ifelse(arm %in% c("Sug"), bar_wn1d(arrhyth_p, arrhyth_p, color_1, 100), arrhyth_p_bar),
    arrhyth_p_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(arrhyth_p, arrhyth_p, color_2, 100), arrhyth_p_bar),
    arrhyth_p_bar = str_replace(arrhyth_p_bar, ">.*<", ">&nbsp;<"),
    arm_c = case_when(
      str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
      str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
    )
  ) %>%
  filter(!is.na(arrhyth_n)) %>%
  arrange(design, year, refid) %>%
  select(study, n, arm_c, mg_kg, arrhyth_np, arrhyth_p_bar) %>%
  group_by(study) %>%
  mutate(study = ifelse(row_number() != 1, NA, study)) %>%
  kbl(
    booktabs = T, align = c("llllll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "N", "Agent", "mg/kg", "Arrhythmia, N (%)", bar_ref)
  ) %>%
  row_spec(0, bold = TRUE, align = "l") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  # add_header_above(c(" " = 1, "Dose (mg/kg)" = 6), line = TRUE, bold = TRUE, align = "c") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "6em") %>%
  column_spec(c(3, 4), width = "8em") %>%
  column_spec(5, width = "11em") %>%
  column_spec(6, width = bar_width)
  # footnote(general = "",
  #        number = c(""),
  #          general_title = "",
  #          footnote_as_chunk = FALSE)

table_n <- tab_inc()  
```
Risk differnce for sugammadex vs. neostigmine -1.2% (95% CI, -5.3% to 3.0%).

```{r arrhythmiaMeta, eval = FALSE}
arrhyth <- adverse.dat %>% 
  filter(age %in% c("Adult", "All ages")) %>% 
  mutate(year = str_extract(study, "\\d{4}")) %>% 
  filter(!is.na(arrhyth_n)) %>%
  # arrange(age, design, year, refid) %>% 
  select(study, arm, n, arrhyth_n) %>% 
  pivot_wider(names_from = arm, values_from = c(arrhyth_n, n))

metabin(
  arrhyth_n_Sug, n_Sug,
  arrhyth_n_Neo, n_Neo,
  pscale = 100,
  sm = "RD",
  data = arrhyth
)
  
```


<br/>

## * PONV*

###  PONV (adults)

<a id="revTab17"></a>

<br/>

<font size = 4> Table `r table_n`. Postoperative nausea and vomiting. </font>

```{r PONV}
## tally ---------------------------------------------- (2022/03/04 08:22) @----
# ponv.dat %>%
#     filter(age == "Adult") %>%
#     filter(!is.na(ponv_n)) %>%
#     arrange(design, study) %>%
#     select(study, refid, design) %>%
#     group_by(design) %>%
#     tally() %>%
#     ungroup() %>%
#     mutate(
#           end = cumsum(n),
#               start = end - n + 1
#             ) %>%
#     select(design, start, end)

## ponv ----------------------------------------------- (2022-03-04 08:21) @----
ponv.dat %>%
  filter(age == "Adult") %>%
  mutate(
    year = str_extract(study, "\\d{4}"),
    ponv_p = ponv_n / arm_n * 100,
    ponv_np = n_percent_dig(ponv_n, ponv_n / arm_n * 100, 1),
    ponv_p_bar = NA_character_,
    ponv_p_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(ponv_p, ponv_p, color_4, 100), ponv_p_bar),
    ponv_p_bar = ifelse(arm %in% c("Sug"), bar_wn1d(ponv_p, ponv_p, color_1, 100), ponv_p_bar),
    ponv_p_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(ponv_p, ponv_p, color_2, 100), ponv_p_bar),
    ponv_p_bar = str_replace(ponv_p_bar, ">.*<", ">&nbsp;<"),
    arm_c = case_when(
      str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
      str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
    )
  ) %>%
  filter(!is.na(ponv_n)) %>%
  arrange(design, year, refid) %>%
  select(study_l, arm_n, arm_c, mg_kg, ponv_np, ponv_p_bar) %>%
  group_by(study_l) %>%
  mutate(study_l = ifelse(row_number() != 1, NA, study_l)) %>%
  kbl(
    booktabs = T, align = c("llllll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "N", "Agent", "mg/kg <u>mg</u>", "PONV, N (%)", bar_ref)
  ) %>%
  row_spec(0, bold = TRUE, align = "l") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  # add_header_above(c(" " = 1, "Dose (mg/kg)" = 6), line = TRUE, bold = TRUE, align = "c") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "6em") %>%
  column_spec(c(3, 4), width = "8em") %>%
  column_spec(5, width = "11em") %>%
  column_spec(6, width = bar_width) %>%
  pack_rows(., "RCT", 1, 32, indent = FALSE) %>%
  pack_rows(., "Nonrandomized Trial", 33, 34, indent = FALSE) %>%
  pack_rows(., "Retrospective Cohort", 35, 38, indent = FALSE) %>%
  footnote(
    # general = "IBW: ideal body weight.",
    #        number = c("● Limited, ●● Important, ●●● Critical."),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

###     *Pooled*

<a id="revFig12"></a>

<br/>

<font size = 4> Figure `r figure_n`. Network of comparators in RCTs. </font>

```{r ponvMeta}
## ponvnmaData ---------------------------------------- (2022-03-04 09:31) @----
library(netmeta)
nma_ponv <- ponv.dat %>%
  filter(design == "rct", !is.na(ponv_n)) %>%
  select(refid, study, arm, arm_n, ponv_n) %>% 
  filter(!(study == "Zhu 2020" & arm_n == 38), study != "McDonagh 2011") %>% 
  mutate(
    arm_n = ifelse(study == "Zhu 2020" & arm == "Neo", 78, arm_n),
    ponv_n = ifelse(study == "Zhu 2020" & arm == "Neo", 7, ponv_n),
    arm = ifelse(arm %in% c("Spont", "Plac"), "Spont/Plac", arm),
    study = ifelse(study == "Wu 2014" & str_detect(arm, "Cauc"), "Wu 2014, Caucasian", study),
    study = ifelse(study == "Wu 2014" & str_detect(arm, "Chin"), "Wu 2014, Chinese", study),
    arm = str_remove(arm, " Chinese"),
    arm = str_remove(arm, " Caucasian"),
  )
```


```{r ponvMetaPlot, include = TRUE, echo = FALSE, fig.align = 'left', fig.width = 10, fig.asp = .5}
## plot ----------------------------------------------- (2022-03-04 09:29) @----
temp <- BUGSnet::data.prep(
  arm.data = nma_ponv,
  # arm.data = rgv_meta_log.dat,
  varname.t = "arm",
  varname.s = "study"
)

BUGSnet::net.plot(temp,
  node.scale = 4,
  edge.scale = 1.5,
  label.offset2 = 3,
  label.offset1 = 8,
  study.counts = TRUE,
  node.lab.cex = 1,
  edge.lab.cex = 1.2
)

figure_n <- fig_inc()
```

<a id="revFig13"></a>

<br/>

<font size = 4> Figure `r figure_n`. Network results. </font>

```{r ponvMetaForest, fig.align = 'left', fig.width = 10, fig.height = 2.5}
# <!-- fig.asp = .5} -->
pairs.dat <- pairwise(
  treat = arm,
  event = ponv_n,
  n = arm_n,
  studlab = study,
  data = nma_ponv,
  sm = "RR",
  warn = FALSE
)

trts <- c("Sug", "Neo", "Spont/Plac")

ponv_netmeta_nma <- netmeta(
  pairs.dat,
  random = TRUE,
  # backtransf = TRUE,
  prediction = TRUE,
  seq = trts,
  sm = "RR",
  reference.group = "Sug",
  warn = FALSE
)

forest(ponv_netmeta_nma,
       xlab = "Risk Ratio",
       xlim = c(.5, 4),
       # at = c(0.01, .1, 0.5, 1, 2)
       )

figure_n <- fig_inc()
```
I^2^ = 0% (0.0%, 55.0%)

<a id="revTab18"></a>

<br/>

<font size = 4> Table `r table_n`. League table. </font>

```{r leagueTable}
## leagueTable (updated 2022/01/19 06:34) ---------------------------------
ponv_league <- netleague(ponv_netmeta_nma,
  digits = 2,
  fixed = FALSE,
  # direct = FALSE,
  seq = trts
)

temp <- as_tibble(ponv_league$random) %>% 
  mutate(
    across(V1:V3, ~ if_else(.x %in% c("Sug", "Neo", "Spont/Plac"),
      cell_spec(.x, bold = TRUE), .x
    ))
  ) 

temp %>% 
  kbl(
    booktabs = T, align = c("ccc"), escape = FALSE,
    col.names = c(rep(" ", 3))
  ) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "center", font_size = 18) %>%
  # kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  row_spec(1:3, extra_css = "vertical-align: middle !important; border-top: 1px solid LightGray; border-bottom: 1px solid LightGray;") %>% 
  column_spec(1:3, width = "10em")
  # footnote(
  #   general = "I^2^ = 30 (95% CI: 0%, 66%)",
  #   # alphabet = c("Footnote a", "Footnote b", ...),
  #   general_title = "",
  #   footnote_as_chunk = FALSE
  # )

table_n <- tab_inc()
```

<br/>

### &ensp;Node Splitting Forest Plot

<a id="revFig14"></a>

<br/>

<font size = 4> Figure `r figure_n`. Comparison of direct and indirect evidence (network meta-analysis). </font>

```{r ponvNodeSplit, include = TRUE, echo = FALSE, fig.align = 'left', fig.width = 8, fig.height = 6.2}
netsplit(ponv_netmeta_nma,
         order = trts) %>% 
  forest(., xlab = "Risk Ratio")

figure_n <- fig_inc()
```

<br/>

<font size = 4> Comparison-adjusted funnel plot. </font>

```{r ponvFunnel, fig.width = 7, fig.height = 3}
funnel(ponv_netmeta_nma, order = trts)
```

<br/>

###  Nausea (adults)

<a id="revTab19"></a>
<br/>


<font size = 4> Table `r table_n`. Postoperative nausea. </font>

```{r nausea}
## tally ---------------------------------------------- (2022/03/04 11:22) @----
# temp %>%
#     filter() %>%
#     arrange(design, study) %>%
#     select(study, refid, design) %>%
#     group_by(design) %>%
#     tally() %>%
#     ungroup() %>%
#     mutate(
#           end = cumsum(n),
#               start = end - n + 1
#             ) %>%
#     select(design, start, end)

## nausea --------------------------------------------- (2022/03/04 11:22) @----
ponv.dat %>%
  filter(age == "Adult") %>%
  mutate(
    year = str_extract(study, "\\d{4}"),
    nausea_p = nausea_n / arm_n * 100,
    nausea_np = n_percent_dig(nausea_n, nausea_n / arm_n * 100, 1),
    nausea_p_bar = NA_character_,
    nausea_p_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(nausea_p, nausea_p, color_4, 100), nausea_p_bar),
    nausea_p_bar = ifelse(str_detect(arm, "Sug"), bar_wn1d(nausea_p, nausea_p, color_1, 100), nausea_p_bar),
    nausea_p_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(nausea_p, nausea_p, color_2, 100), nausea_p_bar),
    nausea_p_bar = str_replace(nausea_p_bar, ">.*<", ">&nbsp;<"),
    arm_c = case_when(
      str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
      str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
    )
  ) %>%
  filter(!is.na(nausea_n)) %>%
  arrange(design, year, refid) %>%
  select(study, arm_n, arm_c, mg_kg, nausea_np, nausea_p_bar) %>%
  group_by(study) %>%
  mutate(study = ifelse(row_number() != 1, NA, study)) %>%
  kbl(
    booktabs = T, align = c("llllll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "N", "Agent", "mg/kg <u>mg</u>", "Nausea, N (%)", bar_ref)
  ) %>%
  row_spec(0, bold = TRUE, align = "l") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  # add_header_above(c(" " = 1, "Dose (mg/kg)" = 6), line = TRUE, bold = TRUE, align = "c") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "6em") %>%
  column_spec(c(3, 4), width = "8em") %>%
  column_spec(5, width = "11em") %>%
  column_spec(6, width = bar_width) %>%
  pack_rows(., "RCT", 1, 60, indent = FALSE) %>%
  pack_rows(., "Nonrandomized Trial", 61, 62, indent = FALSE) %>%
  pack_rows(., "Retrospective Cohort", 63, 68, indent = FALSE) %>%
  # pack_rows(., "Case Control", 9, 10) %>%
  footnote(
    general = "IBW: ideal body weight; CBW: corrected body weight; RBW: real body weight.",
    #        number = c("● Limited, ●● Important, ●●● Critical."),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

###     *Pooled*

<font size = 4> Figure `r figure_n`. Network of comparators in RCTs. </font>

```{r nauseaMeta}
## nauseanmaData ---------------------------------------- (2022-03-04 09:31) @----
library(netmeta)
nma_nausea <- ponv.dat %>%
  filter(design == "rct", !is.na(nausea_n)) %>%
  select(refid, study, arm, arm_n, nausea_n) %>% 
  # Plaud 2009 no events, McDonagh 2011 only sugammadex
  filter(!(study == "Li 2021" & arm == "Sug (TBW)"), study != "McDonagh 2011", study != "Plaud 2009") %>% 
  mutate(
    # arm_n = ifelse(study == "Zhu 2020" & arm == "Neo", 78, arm_n),
    # nausea_n = ifelse(study == "Zhu 2020" & arm == "Neo", 7, nausea_n),
    study = ifelse(study == "Alkenany 2013" & str_detect(arm, "vec"), "Alkenany 2013, Vec", study),
    study = ifelse(study == "Alkenany 2013" & str_detect(arm, "roc"), "Alkenany 2013, Roc", study),
    study = ifelse(study == "Wu 2014" & str_detect(arm, "Cauc"), "Wu 2014, Caucasian", study),
    study = ifelse(study == "Wu 2014" & str_detect(arm, "Chin"), "Wu 2014, Chinese", study),
    arm = ifelse(arm %in% c("Spont", "Plac"), "Spont/Plac", arm),
    arm = str_remove(arm, " Chinese"),
    arm = str_remove(arm, " Caucasian"),
    arm = str_remove(arm, " vec"),
    arm = str_remove(arm, " roc"),
    arm = str_remove(arm, " \\(CBW\\)"),
    arm = str_remove(arm, " \\(TBW\\)"),
    arm_n = ifelse(study == "Li 2021" & arm == "Sug", 96, arm_n),
    nausea_n = ifelse(study == "Li 2021" & arm == "Sug", 30, nausea_n),
  )
```

```{r nauseaMetaPlot, include = TRUE, echo = FALSE, fig.align = 'left', fig.width = 10, fig.asp = .5}
## plot ----------------------------------------------- (2022-03-04 09:29) @----
temp <- BUGSnet::data.prep(
  arm.data = nma_nausea,
  # arm.data = rgv_meta_log.dat,
  varname.t = "arm",
  varname.s = "study"
)

BUGSnet::net.plot(temp,
  node.scale = 2,
  edge.scale = 1.5,
  label.offset2 = 3,
  label.offset1 = 8,
  study.counts = TRUE,
  node.lab.cex = 1,
  edge.lab.cex = 1.2
)

figure_n <- fig_inc()
```

<a id="revFig16"></a>

<br/>

<font size = 4> Figure `r figure_n`. Network results. </font>

```{r nauseaMetaForest, fig.align = 'left', fig.width = 10, fig.height = 2.5}
pairs.dat <- pairwise(
  treat = arm,
  event = nausea_n,
  n = arm_n,
  studlab = study,
  data = nma_nausea,
  sm = "RR"
)

trts <- c("Sug", "Neo", "Spont/Plac")

nausea_netmeta_nma <- netmeta(
  pairs.dat,
  random = TRUE,
  # backtransf = TRUE,
  prediction = TRUE,
  seq = trts,
  sm = "RR",
  reference.group = "Sug"
)

forest(nausea_netmeta_nma,
       xlab = "Risk Ratio",
       xlim = c(.5, 2),
       rightlabs = c("RR", "95% CI  "),
       # at = c(0.01, .1, 0.5, 1, 2)
       )

figure_n <- fig_inc()
```
I^2^ = 12% (0%, 44%)

<a id="revTab20"></a>

<br/>

<font size = 4> Table `r table_n`. League table. </font>

```{r leagueTableNausea}
## leagueTable (updated 2022/01/19 06:34) ---------------------------------
nausea_league <- netleague(nausea_netmeta_nma,
  digits = 2,
  fixed = FALSE,
  # direct = FALSE,
  seq = trts
)

temp <- as_tibble(nausea_league$random) %>% 
  mutate(
    across(V1:V3, ~ if_else(.x %in% c("Sug", "Neo", "Spont/Plac"),
      cell_spec(.x, bold = TRUE), .x
    ))
  ) 

temp %>% 
  kbl(
    booktabs = T, align = c("ccc"), escape = FALSE,
    col.names = c(rep(" ", 3))
  ) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "center", font_size = 18) %>%
  # kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  row_spec(1:3, extra_css = "vertical-align: middle !important; border-top: 1px solid LightGray; border-bottom: 1px solid LightGray;") %>% 
  column_spec(1:3, width = "10em")
  # footnote(
  #   general = "I^2^ = 30 (95% CI: 0%, 66%)",
  #   # alphabet = c("Footnote a", "Footnote b", ...),
  #   general_title = "",
  #   footnote_as_chunk = FALSE
  # )

table_n <- tab_inc()
```

<br/>

### &ensp;Node Splitting Forest Plot

<a id="revFig17"></a>

<br/>

<font size = 4> Figure `r figure_n`. Comparison of direct and indirect evidence (network meta-analysis). </font>

```{r nauseaNodeSplit, include = TRUE, echo = FALSE, fig.align = 'left', fig.width = 8, fig.height = 6.2}
netsplit(nausea_netmeta_nma,
         order = trts) %>% 
  forest(., xlab = "Risk Ratio", rightlabs = c("RR", "95% CI"))

figure_n <- fig_inc()
```

<font size = 4> Comparison-adjusted funnel plot. </font>

```{r nauseaFunnel, fig.width = 7, fig.height = 3}
funnel(nausea_netmeta_nma, order = trts)
```

###  Vomiting (adults)

<a id="revTab21"></a>

<br/>

<font size = 4> Table `r table_n`. Postoperative vomiting. </font>

```{r vomit}
## tally ---------------------------------------------- (2022/03/04 11:22) @----
# temp %>%
#     filter() %>%
#     arrange(design, study) %>%
#     select(study, refid, design) %>%
#     group_by(design) %>%
#     tally() %>%
#     ungroup() %>%
#     mutate(
#           end = cumsum(n),
#               start = end - n + 1
#             ) %>%
#     select(design, start, end)

## vomit --------------------------------------------- (2022/03/04 11:22) @----
ponv.dat %>%
  filter(age == "Adult") %>%
  mutate(
    year = str_extract(study, "\\d{4}"),
    vomit_p = vomit_n / arm_n * 100,
    vomit_np = n_percent_dig(vomit_n, vomit_n / arm_n * 100, 1),
    vomit_p_bar = NA_character_,
    vomit_p_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(vomit_p, vomit_p, color_4, 100), vomit_p_bar),
    vomit_p_bar = ifelse(str_detect(arm, "Sug"), bar_wn1d(vomit_p, vomit_p, color_1, 100), vomit_p_bar),
    vomit_p_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(vomit_p, vomit_p, color_2, 100), vomit_p_bar),
    vomit_p_bar = str_replace(vomit_p_bar, ">.*<", ">&nbsp;<"),
    arm_c = case_when(
      str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
      str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
    )
  ) %>%
  filter(!is.na(vomit_n)) %>%
  arrange(design, year, refid) %>%
  select(study, arm_n, arm_c, mg_kg, vomit_np, vomit_p_bar) %>%
  group_by(study) %>%
  mutate(study = ifelse(row_number() != 1, NA, study)) %>%
  kbl(
    booktabs = T, align = c("llllll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "N", "Agent", "mg/kg <u>mg</u>", "Vomiting, N (%)", bar_ref)
  ) %>%
  row_spec(0, bold = TRUE, align = "l") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  # add_header_above(c(" " = 1, "Dose (mg/kg)" = 6), line = TRUE, bold = TRUE, align = "c") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "6em") %>%
  column_spec(c(3, 4), width = "8em") %>%
  column_spec(5, width = "11em") %>%
  column_spec(6, width = bar_width) %>%
  pack_rows(., "RCT", 1, 44, indent = FALSE) %>%
  pack_rows(., "Nonrandomized Trial", 45, 46, indent = FALSE) %>%
  pack_rows(., "Retrospective Cohort", 47, 50, indent = FALSE) %>%
  # pack_rows(., "Case Control", 9, 10) %>%
  footnote(
    general = "IBW: ideal body weight; CBW: corrected body weight.",
    #        number = c("● Limited, ●● Important, ●●● Critical."),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

###     *Pooled*

<font size = 4> Figure `r figure_n`. Network of comparators in RCTs. </font>

```{r vomitMeta}
## vomitnmaData ---------------------------------------- (2022-03-04 09:31) @----
library(netmeta)
nma_vomit <- ponv.dat %>%
  filter(design == "rct", !is.na(vomit_n)) %>%
  select(refid, study, arm, arm_n, vomit_n) %>%
  mutate(
    # arm_n = ifelse(study == "Zhu 2020" & arm == "Neo", 78, arm_n),
    # vomit_n = ifelse(study == "Zhu 2020" & arm == "Neo", 7, vomit_n),
    study = ifelse(study == "Alkenany 2013" & str_detect(arm, "vec"), "Alkenany 2013, Vec", study),
    study = ifelse(study == "Alkenany 2013" & str_detect(arm, "roc"), "Alkenany 2013, Roc", study),
    study = ifelse(study == "Wu 2014" & str_detect(arm, "Cauc"), "Wu 2014, Caucasian", study),
    study = ifelse(study == "Wu 2014" & str_detect(arm, "Chin"), "Wu 2014, Chinese", study),
    arm = ifelse(arm %in% c("Spont", "Plac"), "Spont/Plac", arm),
    arm = str_remove(arm, " Chinese"),
    arm = str_remove(arm, " Caucasian"),
    arm = str_remove(arm, " vec"),
    arm = str_remove(arm, " roc"),
    arm = str_remove(arm, " \\(CBW\\)"),
    arm = str_remove(arm, " \\(TBW\\)"),
    arm_n = ifelse(study == "Li 2021" & arm == "Sug", 96, arm_n),
    vomit_n = ifelse(study == "Li 2021" & arm == "Sug", 30, vomit_n),
  ) %>%
  group_by(study) %>%
  filter(!all(vomit_n == 0)) %>% # remove no events any arm
  ungroup()

```

```{r vomitMetaPlot, include = TRUE, echo = FALSE, fig.align = 'left', fig.width = 10, fig.asp = .5}
## plot ----------------------------------------------- (2022-03-04 09:29) @----
temp <- BUGSnet::data.prep(
  arm.data = nma_vomit,
  # arm.data = rgv_meta_log.dat,
  varname.t = "arm",
  varname.s = "study"
)

BUGSnet::net.plot(temp,
  node.scale = 2,
  edge.scale = 1.5,
  label.offset2 = 3,
  label.offset1 = 8,
  study.counts = TRUE,
  node.lab.cex = 1,
  edge.lab.cex = 1.2
)

figure_n <- fig_inc()
```

<a id="revFig19"></a>

<br/>

<font size = 4> Figure `r figure_n`. Network results. </font>

```{r vomitMetaForest, echo = FALSE, fig.align = 'left', fig.width = 10, fig.height = 2.5}
pairs.dat <- pairwise(
  treat = arm,
  event = vomit_n,
  n = arm_n,
  studlab = study,
  data = nma_vomit,
  sm = "RR"
)

trts <- c("Sug", "Neo", "Spont/Plac")

vomit_netmeta_nma <- netmeta(
  pairs.dat,
  random = TRUE,
  # backtransf = TRUE,
  prediction = TRUE,
  seq = trts,
  sm = "RR",
  reference.group = "Sug"
)

forest(vomit_netmeta_nma,
       xlab = "Risk Ratio",
       xlim = c(.5, 3),
       rightlabs = c("RR", "95% CI  "),
       at = c(0.5, 1, 2, 3)
       )

figure_n <- fig_inc()
```
I^2^ = 12% (0%, 50%)

<br/>

<a id="revTab22"></a>

<br/>

<font size = 4> Table `r table_n`. League table. </font>

```{r leagueTableVomiting}
## leagueTable (updated 2022/01/19 06:34) ---------------------------------
vomit_league <- netleague(vomit_netmeta_nma,
  digits = 2,
  fixed = FALSE,
  # direct = FALSE,
  seq = trts
)

temp <- as_tibble(vomit_league$random) %>% 
  mutate(
    across(V1:V3, ~ if_else(.x %in% c("Sug", "Neo", "Spont/Plac"),
      cell_spec(.x, bold = TRUE), .x
    ))
  ) 

temp %>% 
  kbl(
    booktabs = T, align = c("ccc"), escape = FALSE,
    col.names = c(rep(" ", 3))
  ) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "center", font_size = 18) %>%
  # kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  row_spec(1:3, extra_css = "vertical-align: middle !important; border-top: 1px solid LightGray; border-bottom: 1px solid LightGray;") %>% 
  column_spec(1:3, width = "10em")
  # footnote(
  #   general = "I^2^ = 30 (95% CI: 0%, 66%)",
  #   # alphabet = c("Footnote a", "Footnote b", ...),
  #   general_title = "",
  #   footnote_as_chunk = FALSE
  # )

table_n <- tab_inc()
```

<br/>

### &ensp;Node Splitting Forest Plot

<a id="revFig20"></a>

<br/>

<font size = 4> Figure `r figure_n`. Comparison of direct and indirect evidence (network meta-analysis). </font>

```{r vomitNodeSplit, include = TRUE, echo = FALSE, fig.align = 'left', fig.width = 8, fig.height = 6.2}
netsplit(vomit_netmeta_nma,
         order = trts) %>% 
  forest(., xlab = "Risk Ratio", rightlabs = c("RR", "95% CI"))

figure_n <- fig_inc()
```

<br/>

<font size = 4> Comparison-adjusted funnel plot. </font>

```{r vomitFunnel, fig.width = 7, fig.height = 3}
funnel(vomit_netmeta_nma, order = trts)
```

<br/>

## * Pulmonary Complications*

###  Hypoxia (adults)

<a id="revTab23"></a>

<br/>

<font size = 4> Table `r table_n`. Hypoxia </font>

```{r hypoxia} 
## groupings ------------------------------------------ (2022-03-02 08:30) @----
# temp %>%
#   filter() %>%
#   arrange(hypox_defn, design, study) %>%
#   select(hypox_defn, study, design) %>%
#   group_by(hypox_defn, design) %>%
#   tally() %>%
#   ungroup() %>%
#   mutate(
#     end = cumsum(n),
#     start = end - n + 1
#   ) %>%
#   select(hypox_defn, design, start, end)

## hypoxia -------------------------------------------- (2022-03-02 08:01) @----
hypox_dat <- popc.dat %>%
  filter(age == "Adult") %>%
  mutate(
    year = str_extract(study, "\\d{4}"),
    hypox_defn = case_when(
      !is.na(hypox_le_90_n) ~ "≤90",
      !is.na(hypox_gt_90_95_n) ~ "90-95",
      !is.na(hypox_ns_n) ~ "NS",
      TRUE ~ NA_character_
    ),
    hypox_n = case_when(
      !is.na(hypox_le_90_n) ~ hypox_le_90_n,
      !is.na(hypox_gt_90_95_n) ~ hypox_gt_90_95_n,
      !is.na(hypox_ns_n) ~ hypox_ns_n
      # TRUE ~ NA
    ),
    hypox_p = case_when(
      !is.na(hypox_le_90_n) ~ hypox_le_90_n / arm_n,
      !is.na(hypox_gt_90_95_n) ~ hypox_gt_90_95_n / arm_n,
      !is.na(hypox_ns_n) ~ hypox_ns_n / arm_n,
      # TRUE ~ NA
    ),
    hypox_np = case_when(
      !is.na(hypox_le_90_n) ~ n_percent_dig(hypox_le_90_n, hypox_le_90_n / arm_n * 100, 1),
      !is.na(hypox_gt_90_95_n) ~ n_percent_dig(hypox_gt_90_95_n, hypox_gt_90_95_n / arm_n * 100, 1),
      !is.na(hypox_ns_n) ~ n_percent_dig(hypox_ns_n, hypox_ns_n / arm_n * 100, 1),
      # TRUE ~ NA
    )
  )

hypox_dat %>%
  mutate(
    hypox_p_bar = NA_character_,
    hypox_p_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(hypox_p * 100, hypox_p * 100, color_4, 100), hypox_p_bar),
    hypox_p_bar = ifelse(arm %in% c("Sug"), bar_wn1d(hypox_p * 100, hypox_p * 100, color_1, 100), hypox_p_bar),
    hypox_p_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(hypox_p * 100, hypox_p * 100, color_2, 100), hypox_p_bar),
    hypox_p_bar = str_replace(hypox_p_bar, ">.*<", ">&nbsp;<"),
    arm_c = case_when(
      str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
      str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
    )
  ) %>%
  filter(!is.na(hypox_np)) %>%
  arrange(hypox_defn, design, year, refid) %>%
  select(study, arm_n, arm_c, mg_kg, depth_rev_f, hypox_np, hypox_p_bar) %>%
  group_by(study) %>%
  mutate(study = ifelse(row_number() != 1, NA, study)) %>%
  kbl(
    booktabs = T, align = c("lllllll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "N", "Agent", "mg/kg", "Reversal", "Hypoxia, N (%)", bar_ref)
  ) %>%
  add_header_above(c(" " = 4, " Depth at" = 1, " " = 2), bold = TRUE, align = "l", line = FALSE) %>%
  row_spec(0, bold = TRUE, align = "l") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "6em") %>%
  column_spec(c(3, 5), width = "8em") %>%
  column_spec(6, width = "11em") %>%
  column_spec(7, width = bar_width) %>%
  pack_topnoind(., "    SaO^2^ ≤90%", 1, 19) %>%
  pack_sub_bold(., "RCT", 1, 13) %>%
  pack_sub_bold(., "Nonrandomized Trials", 14, 15) %>%
  pack_sub_bold(., "Prospective Cohort", 16, 19) %>%
  pack_topnoind(., "    SaO^2^ 90-95%", 20, 37) %>%
  pack_sub_bold(., "RCT", 20, 37) %>%
  pack_topnoind(., "    SaO^2^ Not Specfified", 38, 41) %>%
  pack_sub_bold(., "RCT", 38, 39) %>%
  footnote(
    general = "NS: not specified; mod: moderate; endsurg: end of surgery; shall: shallow; min: minimal; oth: other ",
    # number = c(""),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

###     *Pooled*

<a id="revFig21"></a>

<br/>

<font size = 4> Figure `r figure_n`. Pooled incidence of hypoxia by definition in adult RCTs. </font>

```{r hypoxiaPooled,  fig.width = 10, fig.height = 7.2}
## hypoxiaPooled -------------------------------------- (2022-03-02 10:25) @----
hypox_meta.dat <- hypox_dat %>% 
  filter(design == "rct", str_detect(arm, "Neo|Sug"), !is.na(hypox_n), refid %notin% c(7015, 4935)) %>% 
  mutate(arm = case_when(
    str_detect(arm, "Neo") ~ "Neo",
    str_detect(arm, "Sug") ~ "Sug"
  ),
  hypox_defn = case_when(
    str_detect(hypox_defn, "90-95") ~ "SaO2 90% to 95%",
    str_detect(hypox_defn, "90") ~ "SaO2 ≤90%",
    str_detect(hypox_defn, "NS") ~ "SaO2 Not Specified",
  )) %>% 
  select(refid, year, study, arm, hypox_defn, hypox_n, arm_n) %>%  
  arrange(hypox_defn, year) %>% 
  pivot_wider(id_cols = c(refid, year, study, hypox_defn), names_from = arm, values_from = c(hypox_n, arm_n))

hypox_meta <- metabin(hypox_n_Sug, arm_n_Sug, hypox_n_Neo, arm_n_Neo,
  data = hypox_meta.dat,
  studlab = study,
  sm = "RD",
  method = "MH",
  method.tau = "PM",
  hakn = TRUE,
  prediction = TRUE,
  # subset = hypox_defn == "SaO2 ≤90%",
  # subset = hypox_defn == "SaO2 90% to 95%",
  subgroup = hypox_defn)

forest(hypox_meta,
  fixed = FALSE,
  label.e = "Sugammadex",
  label.c = "Neostigmine",
  rightcols = c("effect", "ci"),
  rightlabs = c(" ", "(95% CI)"),
  pscale = 100,
  digits = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  subgroup = TRUE,
  print.subgroup.name = FALSE,
  text.subgroup.nohet = TRUE,
  colgap.forest.left = unit(5, "mm"),
  # xlim = c(0.001, 5),
  # at = c(.001, 0.01, .1, 1, 2),
  xlab = "Favors: Sugammadex             Neostigmine")

figure_n <- fig_inc()

# hypox_meta <- update(hypox_meta, subgroup = NULL, sm = "RR")
# metabias(hypox_meta, method.bias = "Harbord")
# metabias(hypox_meta, method.bias = "Egger")
# funnel(hypox_meta)
```
No indication for small study effects (potential publication bias) for risk ratio or odds ratio in regression tests or funnel plot.  

<br/>

###  Composite (adults)

<a id="revTab24"></a>

<br/>

<font size = 4> Table `r table_n`. Studies reporting a composite pulmonary complication outcome. </font>

```{r composite} 
## groupings ------------------------------------------ (2022-03-02 08:30) @----
# temp %>%
#     filter() %>%
#     arrange(design, study) %>%
#     select(study, refid, design) %>%
#     group_by(design) %>%
#     tally() %>%
#     ungroup() %>%
#     mutate(
#           end = cumsum(n),
#               start = end - n + 1
#             ) %>%
#     select(design, start, end)

## composite ------------------------------------------ (2022-03-02 14:30) @----
composite <- popc.dat %>%
  filter(age == "Adult") %>%
  mutate(
    year = str_extract(study, "\\d{4}"),
    composite_np = n_percent_dig(composite_n, composite_n / arm_n * 100, 1),
    composite_p_bar = NA_character_,
    composite_p = composite_n / arm_n,
    composite_p_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(composite_p, composite_p, color_4, 1), composite_p_bar),
    composite_p_bar = ifelse(arm %in% c("Sug"), bar_wn1d(composite_p, composite_p, color_1, 1), composite_p_bar),
    composite_p_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(composite_p, composite_p, color_2, 1), composite_p_bar),
    composite_p_bar = ifelse(str_detect(arm, "Pyr"), bar_wn1d(composite_p, composite_p, color_3, 1), composite_p_bar),
    composite_p_bar = str_replace(composite_p_bar, ">.*<", ">&nbsp;<"),
    arm_c = case_when(
      str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
      str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
      str_detect(arm, "Pyr") ~ cell_spec(arm, color = color_3),
    )
  ) %>%
  filter(!is.na(composite_np)) %>%
  arrange(design, year, refid) %>%
  select(study_l, study, arm_n, arm_c, mg_kg, depth_rev_f, composite_np, composite_p_bar, design, arm)

composite %>% 
  select(-c(design, study, arm)) %>% 
  group_by(study_l) %>%
  mutate(study_l = ifelse(row_number() != 1, NA, study_l)) %>%
  # add_row() %>% 
  kbl(
    booktabs = T, align = c("llllllll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "N", "Agent", "mg/kg", "Reversal", "Composite, N (%)", bar_ref)
  ) %>%
  add_header_above(c(" " = 4, " Depth at" = 1, " " = 2), bold = TRUE, align = "l", line = FALSE) %>%
  row_spec(0, bold = TRUE, align = "l") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "6em") %>%
  column_spec(c(3, 5), width = "8em") %>%
  column_spec(6, width = "11em") %>%
  column_spec(7, width = bar_width) %>%
  pack_topnoind(., "RCT", 1, 21) %>%
  pack_topnoind(., "Nonrandomized Trials", 22, 23) %>%
  pack_topnoind(., "Prospective Cohort", 24, 33) %>%
  pack_topnoind(., "Retrospective Cohort", 34, 39) %>%
  # result_pack(., "")
  footnote(
    general = "NS: not specified; mod: moderate; endsurg: end of surgery; shall: shallow; min: minimal; oth: other ",
    # number = c(""),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

###     *Pooled*

<a id="revFig22"></a>

<br/>

<font size = 4> Figure `r figure_n`. Pooled incidence of postoperative pulmonary complications in randomized and nonrandomized studies, and component endpoints included in each study's definition. </font>

```{r compositeMeta, fig.width = 12, fig.height = 5.7}
## compositeMeta -------------------------------------- (2022-03-10 07:43) @----
# add composite definition
comp_defn <- readxl::read_xlsx("data/POPCRevAgent_030922.xlsx", sheet = "comp_defn", range = "A1:C12") %>% 
  rename(studlab = study) %>% 
  select(studlab, defn)

comp_meta_dat <- composite %>% 
  mutate(comp_n = as.numeric(str_extract(composite_np, "^\\d{1,4}")),
         arm = str_extract(arm, "^\\w{1,5}")) %>% 
  select(study, arm, arm_n, comp_n, design) %>% 
  filter(arm %in% c("Sug", "Neo")) %>% 
  group_by(study) %>% 
  filter(!all(comp_n == 0), n() > 1, !all(arm == "Neo"), !all(arm == "Sug")) %>% 
  ungroup() %>% 
  pivot_wider(., names_from = "arm", values_from = c("comp_n", "arm_n"))

# rct effect sizes
comp_rct_meta <- metabin(comp_n_Sug, arm_n_Sug, comp_n_Neo, arm_n_Neo,
  data = comp_meta_dat,
  studlab = study,
  sm = "OR",
  method = "MH",
  method.tau = "PM",
  hakn = FALSE,
  prediction = TRUE,
  subset = design == "rct"
)

comp_rct <- comp_rct_meta %>% 
  as_tibble(.) %>% 
  mutate(design = "rct") %>% 
  select(studlab, TE, seTE, design)

# nonrandomized 
comp_nrsi <- tribble(
  ~studlab, ~TE, ~seTE, ~design, 
  "Ledowski 2013" ,  0.157,  0.895, "nrsi",
  "Kirmeier 2018",   0.0296, sd_confint(log(0.85), log(1.25)), "nrsi",
  "Kheterpal 2020", -0.3567, sd_confint(log(0.63), log(0.77)), "nrsi",
  "Li 2021",        -0.1165, sd_confint(log(0.65), log(1.22)), "nrsi",
  "Yu 2021",         log(0.35), sd_confint(log(0.23), log(0.54)), "nrsi",
)

add_cols_n <- comp_meta_dat %>% 
  select(study, comp_n_Sug, arm_n_Sug, comp_n_Neo, arm_n_Neo) %>% 
  rename(studlab = study, nsug = arm_n_Sug, nneo = arm_n_Neo, esug = comp_n_Sug, eneo = comp_n_Neo)

comp_meta <- bind_rows(comp_rct, comp_nrsi) %>%
  left_join(., comp_defn, by = "studlab") %>%
  left_join(., add_cols_n, by = "studlab") %>%
  mutate(design = toupper(design)) %>%
  mutate(
    nsug = ifelse(studlab == "Li 2021", 2691, nsug),
    esug = ifelse(studlab == "Li 2021", 114, esug),
    nneo = ifelse(studlab == "Li 2021", 7800, nneo),
    eneo = ifelse(studlab == "Li 2021", 461, eneo),
    design = ifelse(design == "NRSI", "Nonrandomized", design)
  )

all_meta <- metagen(TE, seTE,
  studlab = studlab,
  subgroup = design,
  hakn = TRUE,
  sm = "OR",
  backtransf = TRUE,
  prediction = TRUE,
  data = comp_meta
)

forest(all_meta,
  fixed = FALSE,
  label.e = "Sugammadex",
  label.c = "Neostigmine",
  rightcols = c("effect", "ci", "defn"),
  leftcols = c("studlab", "esug", "nsug", "eneo", "nneo"), 
  rightlabs = c("OR", "(95% CI)", "POPC"),
  leftlabs = c("Study", "Events", "Total", "Events", "Total"),
  just.addcols = "left",
  just.addcols.left = "right",
  colgap.right = "5mm",
  colgap.left = "2mm",
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  subgroup = TRUE,
  print.subgroup.name = FALSE,
  text.subgroup.nohet = TRUE,
  colgap.forest.left = "5mm",
  # xlim = c(0.001, 5),
  # at = c(.001, 0.01, .1, 1, 2),
  xlab = "Favors: Sugammadex             Neostigmine")

grid::grid.text("Sugammadex  Neostigmine", .285, .955, gp = grid::gpar(cex = 1.1, fontface = "bold"))

figure_n <- fig_inc()
```
Results from 3 nonrandomized studies adjusted for potential confounding (Kirmeir 2018 multivariable regression with a likely sufficient set of deconfounders, Li 2021 and Yu 2021 propensity scores,  and Kheterpal 2020 matched cohort design).

POPC: postoperative pulmonary complications; NRSI: nonrandomized study of interventions; APN: Aspiration pneumonitis; ARI: Acute Respiratory Insufficiency; ATX: Atelectasis; BRN: Broncospasm; HAP: Pneumonia; HOX: Hypoxia; IPE: Iatrogenic Pulmonary Embolism; LSP: Laryngospasm; PAL: Prolonged Air Leakage; PCG: Pulmonary Congestion; PED: Pulmonary Edema; PIX: Pulmonary Infection; PNS: Pneumonitis; PRI: Postop Reintubation; PTX: Pneumothorax; RFA: Reflux Aspiration; RPF: Repiratory Failure; RSD: Respiratory Depression; SRP: Spasmotic Respiratory Pattern; UAO: Upper airway obstruction; VXN: Ventilation > 48 hrs.

<br/>

###  Pneumonia (adults)

<a id="revTab25"></a>

<br/>

<font size = 4> Table `r table_n`. Pneumonia. </font>

```{r pneumonia} 
## groupings ------------------------------------------ (2022-03-02 08:30) @----
# pneumonia %>%
#     filter() %>%
#     arrange(design, study) %>%
#     select(study, refid, design) %>%
#     group_by(design) %>%
#     tally() %>%
#     ungroup() %>%
#     mutate(
#           end = cumsum(n),
#               start = end - n + 1
#             ) %>%
#     select(design, start, end)

## pneumonia ------------------------------------------ (2022-03-02 14:30) @----
pneumonia <- popc.dat %>%
  filter(age == "Adult") %>%
  mutate(
    year = str_extract(study, "\\d{4}"),
    pneumonia_np = n_percent_dig(pneumonia_n, pneumonia_n / arm_n * 100, 1),
    pneumonia_p_bar = NA_character_,
    pneumonia_p = pneumonia_n / arm_n,
    pneumonia_p_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(pneumonia_p, pneumonia_p, color_4, 1), pneumonia_p_bar),
    pneumonia_p_bar = ifelse(arm %in% c("Sug"), bar_wn1d(pneumonia_p, pneumonia_p, color_1, 1), pneumonia_p_bar),
    pneumonia_p_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(pneumonia_p, pneumonia_p, color_2, 1), pneumonia_p_bar),
    pneumonia_p_bar = ifelse(str_detect(arm, "Pyr"), bar_wn1d(pneumonia_p, pneumonia_p, color_3, 1), pneumonia_p_bar),
    pneumonia_p_bar = str_replace(pneumonia_p_bar, ">.*<", ">&nbsp;<"),
    arm_c = case_when(
      str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
      str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
      str_detect(arm, "Pyr") ~ cell_spec(arm, color = color_3),
    )
  ) %>%
  filter(!is.na(pneumonia_np)) %>%
  arrange(design, year, refid) %>%
  select(study, arm_n, arm_c, mg_kg, depth_rev_f, pneumonia_np, pneumonia_p_bar, design, arm)

pneumonia %>% 
  select(-c(design, arm)) %>% 
  group_by(study) %>%
  mutate(study = ifelse(row_number() != 1, NA, study)) %>%
  kbl(
    booktabs = T, align = c("lllllll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "N", "Agent", "mg/kg", "Reversal", "Pneumonia, N (%)", bar_ref)
  ) %>%
  add_header_above(c(" " = 4, " Depth at" = 1, " " = 2), bold = TRUE, align = "l", line = FALSE) %>%
  row_spec(0, bold = TRUE, align = "l") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "6em") %>%
  column_spec(c(3, 5), width = "8em") %>%
  column_spec(6, width = "11em") %>%
  column_spec(7, width = bar_width) %>%
  pack_topnoind(., "RCT", 1, 12) %>%
  pack_topnoind(., "Prospective Cohort", 13, 15) %>%
  pack_topnoind(., "Retrospective Cohort", 16, 21) %>%
  pack_topnoind(., "Case-Control", 22, 23) %>%
  footnote(
    general = "NS: not specified; mod: moderate; endsurg: end of surgery; shall: shallow; min: minimal; oth: other ",
    # number = c(""),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

###     *Pooled*

<a id="revFig23"></a>

<br/>

<font size = 4> Figure `r figure_n`. Pooled relative odds of postoperative pneumonia in randomized and nonrandomized studies. </font>

```{r pneumoniaMeta, fig.width = 10, fig.height = 5}
## pneumoniaMeta -------------------------------------- (2022-03-10 10:47) @----
pneum_meta_dat <- pneumonia %>% 
  mutate(pneum_n = as.numeric(str_extract(pneumonia_np, "^\\d{1,4}")),
         arm = str_extract(arm, "^\\w{1,5}")) %>% 
  select(study, arm, arm_n, pneum_n, design) %>% 
  filter(arm %in% c("Sug", "Neo")) %>% 
  group_by(study) %>% 
  filter(!all(pneum_n == 0), n() > 1, !all(arm == "Neo"), !all(arm == "Sug")) %>% 
  ungroup() %>% 
  pivot_wider(., names_from = "arm", values_from = c("pneum_n", "arm_n"))

# rct effect sizes
pneum_rct_meta <- metabin(pneum_n_Sug, arm_n_Sug, pneum_n_Neo, arm_n_Neo,
  data = pneum_meta_dat,
  studlab = study,
  sm = "OR",
  method = "MH",
  method.tau = "PM",
  hakn = FALSE,
  prediction = TRUE,
  subset = design == "rct"
)

pneum_rct <- pneum_rct_meta %>% 
  as_tibble(.) %>% 
  mutate(design = "rct") %>% 
  select(studlab, TE, seTE, design)

# nonrandomized 
pneum_nrsi <- tribble(
  ~studlab, ~TE, ~seTE, ~design, 
  "Kheterpal 2020", log(0.53), sd_confint(log(0.44), log(0.62)), "nrsi",
  "Li 2021",        log(0.94), sd_confint(log(0.66), log(1.34)), "nrsi",
  "Yu 2021",        log(0.33), sd_confint(log(0.01), log(8.16)), "nrsi",
)

add_cols_n <- pneum_meta_dat %>% 
  select(study, pneum_n_Sug, arm_n_Sug, pneum_n_Neo, arm_n_Neo) %>% 
  rename(studlab = study, nsug = arm_n_Sug, nneo = arm_n_Neo, esug = pneum_n_Sug, eneo = pneum_n_Neo)

pneum_meta <- bind_rows(pneum_rct, pneum_nrsi) %>%
  left_join(., add_cols_n, by = "studlab") %>%
  mutate(
    design = toupper(design),
    design = ifelse(design == "NRSI", "Retrospective Cohort", design)
  )

all_meta <- metagen(TE, seTE,
  studlab = studlab,
  subgroup = design,
  sm = "OR",
  backtransf = TRUE,
  data = pneum_meta
)

forest(all_meta,
  fixed = FALSE,
  label.e = "Sugammadex",
  label.c = "Neostigmine",
  rightcols = c("effect", "ci"),
  leftcols = c("studlab", "esug", "nsug", "eneo", "nneo"), 
  rightlabs = c("OR", "(95% CI)"),
  leftlabs = c("Study", "Events", "Total", "Events", "Total"),
  just.addcols = "left",
  just.addcols.left = "right",
  colgap.right = "5mm",
  colgap.left = "2mm",
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  subgroup = TRUE,
  print.subgroup.name = FALSE,
  text.subgroup.nohet = TRUE,
  colgap.forest.left = "5mm",
  xlim = c(0.1, 10),
  # at = c(.001, 0.01, .1, 1, 2),
  xlab = "Favors: Sugammadex             Neostigmine")

grid::grid.text("Sugammadex   Neostigmine", .38, .96, gp = grid::gpar(cex = 1.0, fontface = "bold"))

figure_n <- fig_inc()
```
Results from 3 nonrandomized studies adjusted for potential confounding (Li 2021 and Yu 2021 propensity scores, Kheterpal 2020 matched cohort design).<br/>
Pooled risk difference comparing sugammadex with neostigmine in for RCTs -1.6% (95% CI, -4.3 to 1.1; I^2^ = 20%, 𝜏= 1.4%.

<br/>

###  Respiratory Failure (adults)

<a id="revTab26"></a>

<font size = 4> Table `r table_n`. Respiratory failure. </font>

<br/>

```{r resp_fail} 
## groupings ------------------------------------------ (2022-03-02 08:30) @----
# temp %>%
#     filter() %>%
#     arrange(design, study) %>%
#     select(study, refid, design) %>%
#     group_by(design) %>%
#     tally() %>%
#     ungroup() %>%
#     mutate(
#           end = cumsum(n),
#               start = end - n + 1
#             ) %>%
#     select(design, start, end)

## resp_fail ------------------------------------------ (2022-03-02 14:30) @----
popc.dat %>%
  filter(age == "Adult") %>%
  mutate(
    year = str_extract(study, "\\d{4}"),
    resp_fail_np = n_percent_dig(resp_fail_n, resp_fail_n / arm_n * 100, 1),
    resp_fail_p_bar = NA_character_,
    resp_fail_p = resp_fail_n / arm_n,
    resp_fail_p_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(resp_fail_p, resp_fail_p, color_4, 1), resp_fail_p_bar),
    resp_fail_p_bar = ifelse(arm %in% c("Sug"), bar_wn1d(resp_fail_p, resp_fail_p, color_1, 1), resp_fail_p_bar),
    resp_fail_p_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(resp_fail_p, resp_fail_p, color_2, 1), resp_fail_p_bar),
    resp_fail_p_bar = ifelse(str_detect(arm, "Pyr"), bar_wn1d(resp_fail_p, resp_fail_p, color_3, 1), resp_fail_p_bar),
    resp_fail_p_bar = str_replace(resp_fail_p_bar, ">.*<", ">&nbsp;<"),
    arm_c = case_when(
      str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
      str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
      str_detect(arm, "Pyr") ~ cell_spec(arm, color = color_3),
    )
  ) %>%
  filter(!is.na(resp_fail_np)) %>%
  arrange(design, year, refid) %>%
  select(study, arm_n, arm_c, mg_kg, depth_rev_f, resp_fail_np, resp_fail_p_bar) %>%
  group_by(study) %>%
  mutate(study = ifelse(row_number() != 1, NA, study)) %>%
  kbl(
    booktabs = T, align = c("lllllll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "N", "Agent", "mg/kg", "Reversal", "Failure, N (%)", " ")
  ) %>%
  add_header_above(c(" " = 4, " Depth at" = 1, "Respiratory" = 2), bold = TRUE, align = "l", line = FALSE) %>%
  row_spec(0, bold = TRUE, align = "l") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "6em") %>%
  column_spec(c(3, 5), width = "8em") %>%
  column_spec(6, width = "11em") %>%
  column_spec(7, width = "10em") %>%
  pack_topnoind(., "RCT", 1, 2) %>%
  pack_topnoind(., "Prospective Cohort", 3, 4) %>%
  pack_topnoind(., "Retrospective Cohort", 5, 6) %>%
  result_pack(., "OR 0.45; 95% CI, 0.37 to 0.56)", 7, padding = 62) %>% 
  pack_topnoind(., "Case-Control", 7, 8) %>%
  footnote(
    general = "NS: not specified; mod: moderate; endsurg: end of surgery; shall: shallow; min: minimal; oth: other ",
    # number = c(""),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

###  Bronchospasm (adults)

<a id="revTab27"></a>

<br/>

<font size = 4> Table `r table_n`. Bronchospasm (RCTs). </font>

```{r bronchospasm} 
## groupings ------------------------------------------ (2022-03-02 08:30) @----
# temp %>%
#     filter() %>%
#     arrange(design, study) %>%
#     select(study, refid, design) %>%
#     group_by(design) %>%
#     tally() %>%
#     ungroup() %>%
#     mutate(
#           end = cumsum(n),
#               start = end - n + 1
#             ) %>%
#     select(design, start, end)

## bronchospasm ------------------------------------------ (2022-03-02 14:30) @----
# temp <- popc.dat %>%
bronchospasm <- popc.dat %>%
  filter(age == "Adult") %>%
  mutate(
    year = str_extract(study, "\\d{4}"),
    bronchospasm_np = n_percent_dig(bronchospasm_n, bronchospasm_n / arm_n * 100, 1),
    bronchospasm_p_bar = NA_character_,
    bronchospasm_p = bronchospasm_n / arm_n,
    bronchospasm_p_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(bronchospasm_p, bronchospasm_p, color_4, 1), bronchospasm_p_bar),
    bronchospasm_p_bar = ifelse(arm %in% c("Sug"), bar_wn1d(bronchospasm_p, bronchospasm_p, color_1, 1), bronchospasm_p_bar),
    bronchospasm_p_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(bronchospasm_p, bronchospasm_p, color_2, 1), bronchospasm_p_bar),
    bronchospasm_p_bar = ifelse(str_detect(arm, "Pyr"), bar_wn1d(bronchospasm_p, bronchospasm_p, color_3, 1), bronchospasm_p_bar),
    bronchospasm_p_bar = str_replace(bronchospasm_p_bar, ">.*<", ">&nbsp;<"),
    arm_c = case_when(
      str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
      str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
      str_detect(arm, "Pyr") ~ cell_spec(arm, color = color_3),
    )
  ) %>%
  filter(!is.na(bronchospasm_np)) %>%
  arrange(design, year, refid) %>%
  select(study, study_l, arm_n, arm_c, mg_kg, depth_rev_f, bronchospasm_np, bronchospasm_p_bar, design, arm)

bronchospasm %>% 
  select(-c(design, arm, study)) %>% 
  group_by(study_l) %>%
  mutate(study_l = ifelse(row_number() != 1, NA, study_l)) %>%
  kbl(
    booktabs = T, align = c("lllllll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "N", "Agent", "mg/kg", "Reversal", "Bronchospasm, N (%)", bar_ref)
  ) %>%
  add_header_above(c(" " = 4, " Depth at" = 1, " " = 2), bold = TRUE, align = "l", line = FALSE) %>%
  row_spec(0, bold = TRUE, align = "l") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "6em") %>%
  column_spec(c(3, 5), width = "8em") %>%
  column_spec(6, width = "11em") %>%
  column_spec(7, width = bar_width) %>%
  pack_topnoind(., "RCT", 1, 6) %>%
  pack_topnoind(., "Nonrandomized Trial", 7, 8) %>%
  footnote(
    general = "NS: not specified; mod: moderate; endsurg: end of surgery; shall: shallow; min: minimal; oth: other ",
    # number = c(""),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

###     *Pooled*

<a id="revFig24"></a>

<br/>

<font size = 4> Figure `r figure_n`. Pooled incidence of postoperative bronchospasm in randomized and nonrandomized studies. </font>

```{r bronchospasmMeta, fig.width = 10, fig.height = 3}
## bronchospasmMeta -------------------------------------- (2022-03-10 10:47) @----
bronch_meta_dat <- bronchospasm %>% 
  mutate(bronch_n = as.numeric(str_extract(bronchospasm_np, "^\\d{1,4}")),
         arm = str_extract(arm, "^\\w{1,5}")) %>% 
  select(study, arm, arm_n, bronch_n, design) %>% 
  filter(arm %in% c("Sug", "Neo")) %>% 
  group_by(study) %>% 
  filter(n() > 1, !all(arm == "Neo"), !all(arm == "Sug")) %>% 
  ungroup() %>% 
  pivot_wider(., names_from = "arm", values_from = c("bronch_n", "arm_n"))

# rct effect sizes
bronch_rct_meta <- metabin(bronch_n_Sug, arm_n_Sug, bronch_n_Neo, arm_n_Neo,
  data = bronch_meta_dat,
  studlab = study,
  sm = "RD",
  method = "MH",
  method.tau = "PM",
  hakn = FALSE,
  prediction = FALSE,
)

forest(bronch_rct_meta,
  fixed = FALSE,
  label.e = "Sugammadex",
  label.c = "Neostigmine",
  rightcols = c("effect", "ci"),
  rightlabs = c(" ", "(95% CI)"),
  pscale = 100,
  # leftlabs = c("Study", "Events", "Total", "Events", "Total"),
  # just.addcols = "left",
  # just.addcols.left = "right",
  # colgap.right = "5mm",
  # colgap.left = "2mm",
  digits = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  # prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  # subgroup = TRUE,
  # print.subgroup.name = FALSE,
  # text.subgroup.nohet = TRUE,
  # colgap.forest.left = "5mm",
  # xlim = c(0.1, 10),
  # at = c(.001, 0.01, .1, 1, 2),
  xlab = "Favors: Sugammadex             Neostigmine")

figure_n <- fig_inc()
```

<br/>

###  Reintubation (adults)

<a id="revTab28"></a>

<br/>

<font size = 4> Table `r table_n`. Reintubation </font>

```{r reintub} 
## groupings ------------------------------------------ (2022-03-02 08:30) @----
# reintub %>%
#     filter() %>%
#     arrange(design, study) %>%
#     select(study, refid, design) %>%
#     group_by(design) %>%
#     tally() %>%
#     ungroup() %>%
#     mutate(
#           end = cumsum(n),
#               start = end - n + 1
#             ) %>%
#     select(design, start, end)

## reintub ------------------------------------------ (2022-03-02 14:30) @----
reintub <- popc.dat %>%
  mutate(
    year = str_extract(study, "\\d{4}"),
    reintub_np = n_percent_dig(reintub_n, reintub_n / arm_n * 100, 1),
    reintub_p_bar = NA_character_,
    reintub_p = reintub_n / arm_n,
    reintub_p_bar = ifelse(arm %in% c("Spont", "Plac"), bar_wn1d(reintub_p, reintub_p, color_4, 1), reintub_p_bar),
    reintub_p_bar = ifelse(arm %in% c("Sug"), bar_wn1d(reintub_p, reintub_p, color_1, 1), reintub_p_bar),
    reintub_p_bar = ifelse(str_detect(arm, "Neo"), bar_wn1d(reintub_p, reintub_p, color_2, 1), reintub_p_bar),
    reintub_p_bar = ifelse(str_detect(arm, "Pyr"), bar_wn1d(reintub_p, reintub_p, color_3, 1), reintub_p_bar),
    reintub_p_bar = str_replace(reintub_p_bar, ">.*<", ">&nbsp;<"),
    arm_c = case_when(
      str_detect(arm, "Sug") ~ cell_spec(arm, color = color_1),
      str_detect(arm, "Plac") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Spont") ~ cell_spec(arm, color = color_4),
      str_detect(arm, "Neo") ~ cell_spec(arm, color = color_2),
    ),
      age = ifelse(study == "Llaurado 2014", "Adult", age),
      design = ifelse(study == "Llaurado 2014", "Prospective Historical Control", design)
  ) %>%
  filter(age == "Adult") %>%
  filter(!is.na(reintub_np)) %>%
  arrange(design, year, refid) %>%
  select(study, arm_n, arm_c, mg_kg, depth_rev_f, reintub_np, reintub_p_bar, design, arm)

reintub %>% 
  select(-c(design, arm)) %>% 
  group_by(study) %>%
  mutate(study = ifelse(row_number() != 1, NA, study)) %>%
  kbl(
    booktabs = T, align = c("lllllll"), escape = FALSE, # format = "latex",
    col.names = c("Study", "N", "Agent", "mg/kg", "Reversal", "Reintubation, N (%)", bar_ref)
  ) %>%
  add_header_above(c(" " = 4, " Depth at" = 1, " " = 2), bold = TRUE, align = "l", line = FALSE) %>%
  row_spec(0, bold = TRUE, align = "l") %>%
  kable_styling(bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "6em") %>%
  column_spec(c(3, 5), width = "8em") %>%
  column_spec(6, width = "11em") %>%
  column_spec(7, width = bar_width) %>%
  pack_topnoind(., "RCT", 1, 10) %>%
  pack_topnoind(., "Prospective Cohort", 11, 12) %>%
  pack_topnoind(., "Retrospective Cohort", 13, 15) %>%
  pack_topnoind(., "Case-Control", 16, 17) %>%
  pack_topnoind(., "Prospective Historical Control", 18, 19) %>%
  footnote(
    general = "NS: not specified; mod: moderate; endsurg: end of surgery; shall: shallow; min: minimal; oth: other ",
    # number = c(""),
    general_title = "",
    footnote_as_chunk = FALSE
  )

table_n <- tab_inc()
```

<br/>

###     *Pooled*

<a id="revFig25"></a>

<br/>

<font size = 4> Figure `r figure_n`. Pooled relative odds of postoperative reintub in randomized and nonrandomized studies. </font>

```{r reintubMeta, fig.width = 10, fig.height = 5}
## reintubMeta -------------------------------------- (2022-03-10 10:47) @----
reintub_meta_dat <- reintub %>% 
  mutate(reintub_n = as.numeric(str_extract(reintub_np, "^\\d{1,4}")),
         arm = str_extract(arm, "^\\w{1,5}")) %>% 
  select(study, arm, arm_n, reintub_n, design) %>% 
  filter(arm %in% c("Sug", "Neo"), study %notin% c("Yazar 2016")) %>%  # Yazar sug 65-74 vs. 75+
  # group_by(study) %>% 
  # filter(!all(reintub_n == 0), n() > 1, !all(arm == "Neo"), !all(arm == "Sug")) %>% 
  # ungroup() %>% 
  pivot_wider(., names_from = "arm", values_from = c("reintub_n", "arm_n")) |> 
  mutate(design = ifelse(design == 1, "RCT", "Observational"))

# rct effect sizes
reintub_rct_meta <- metabin(reintub_n_Sug, arm_n_Sug, reintub_n_Neo, arm_n_Neo,
  data = reintub_meta_dat,
  studlab = study,
  sm = "RD",
  method = "MH",
  method.tau = "PM",
  hakn = FALSE,
  prediction = TRUE,
  pscale = 100,
  subgroup = design,
  # subset = design == "RCT"
)

forest(reintub_rct_meta,
  fixed = FALSE,
  label.e = "Sugammadex",
  label.c = "Neostigmine",
  rightcols = c("effect", "ci"),
  rightlabs = c("RD", "(95% CI)"),
  # leftlabs = c("Study", "Events", "Total", "Events", "Total"),
  # just.addcols = "left",
  # just.addcols.left = "right",
  colgap.right = "5mm",
  colgap.left = "2mm",
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  # prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  subgroup = TRUE,
  print.subgroup.name = FALSE,
  # text.subgroup.nohet = TRUE,
  colgap.forest.left = "5mm",
  # xlim = c(0.1, 10),
  # at = c(.001, 0.01, .1, 1, 2),
  xlab = "Favors: Sugammadex             Neostigmine")

figure_n <- fig_inc()
```

<br/>


<br/><br/>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<br/>

# **Study/Participant Detail**

<br/>

### *Study Characteristics*

###   <u>Adult Studies</u>

<br>

<font size = 4> Table `r table_n`. Characteristics of studies including only adults. </font>

```{r createStudyCharTable, include = FALSE}
## createStudyCharTable ------------------------------- (2022-04-03 15:53) @----
study_char_table <- study_char.dat %>%
  filter(refid %in% rev_refids) %>% 
  mutate(
    dates = str_c(date_start, "-", date_end),
    country = countrycode::countryname(country, destination = "iso3c"),
    low_r = noquote(if_else(non_vh_hdi == "yes", "\U2022", "", "")),
    n = n_enrolled,
    n_anal = n_analyze,
    pilot = noquote(if_else(pilot == "yes", "\U2022", "", "")),
    setting = case_when(
      !is.na(hospital) ~ "Hosp",
      !is.na(ambulatory) ~ "Amb",
      !is.na(other_setting) ~ "Other"
    ),
    gen = noquote(if_else(!is.na(general), "\U2022", "", "")),
    reg = noquote(if_else(!is.na(regional), "\U2022", "", "")),
    sed = noquote(if_else(!is.na(sedation), "\U2022", "", "")),
    registered = noquote(if_else(registered == "yes", "\U2022", "", "")),
    across(surg_various:surg_other, ~ str_replace(.x, "surg_", "")),
    across(surg_various:surg_other, ~ str_c(.x, ", ")),
    across(surg_various:surg_other, ~ firstup(.x)),
    across(surg_various:surg_other, ~ replace_na(.x, "")),
    surg_list = ifelse(grepl("abdom", surg_list), "Abdom, ", ""),
    surgs = str_c(surg_various, surg_car, surg_cr, surg_gyn, surg_gi, surg_gen, surg_headneck, surg_hep, surg_neuro, surg_opth, surg_oralmax, surg_ortho, surg_otolar, surg_plastic, surg_thor, surg_urol, surg_list),
    surgs = str_replace(surgs, "Otolar", "ENT"),
    surgs = str_replace(surgs, "Car", "Card"),
    surgs = str_replace(surgs, "Cr", "GI"),
    surgs = str_replace(surgs, "Gi", "GI"),
    surgs = str_replace(surgs, "Headneck", "ENT"),
    surgs = str_sub(surgs, 1, nchar(surgs) - 2),
    country = ifelse(grepl("USA", country), "USA", country),
    country = ifelse(grepl("UK", country), "UK", country),
    country = ifelse(!is.na(non_vh_hdi), str_c(country, "^a^"), country)
  ) %>%
  arrange(age, design, year, study) %>%
  select(refid, age, design, study, dates, country, n, pilot, setting, gen, reg, -sed,  surgs, registered)

```

```{r studyCharKableAdult, echo = FALSE}
## studyCharKableAdult -------------------------------- (2022-04-03 15:54) @----
# study_char_table %>%
#   arrange(age, design, study) %>% 
#   filter(age == "Adult") %>% 
#   select(study, refid, age, design) %>% 
#   group_by(age, design) %>% 
#   tally() %>% 
#   ungroup() %>% 
#   mutate(end = cumsum(n),
#          start = end - n + 1) %>% 
#   select(age, design, start, end)

study_char_table %>%
  filter(age == "Adult") %>% 
  select(!c(refid, age, design)) %>% 
  kbl(booktabs = T, align = c("llllcccclc"), 
      # format = "latex",
      col.names = c("Study", "Dates", "Country", " N ", "Pilot", 
                    "Setting", "Gen", "Reg", "Type of Surgery", "Registered")) %>%
  add_header_above(c(" " = 6, "Anesthesia" = 2, " " = 2), bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>% 
  column_spec(2, width = "8em") %>% 
  column_spec(3, width = "5em") %>% 
  column_spec(4, width = "4em") %>% 
  column_spec(5, width = "4em") %>% 
  column_spec(6, width = "5em") %>% 
  column_spec(7, width = "3em") %>% 
  column_spec(8, width = "3em") %>% 
  column_spec(9, width = "15em") %>% 
  column_spec(10, width = "5em") %>% 
  pack_topnoind(., "RCT",                        1, 121) %>% 
  pack_topnoind(., "Before-After/Time Series", 122, 123) %>% 
  pack_topnoind(., "Nonrandomized Trial",      124, 134) %>% 
  pack_topnoind(., "Prospective Cohort",       135, 156) %>%
  pack_topnoind(., "Retrospective Cohort",     157, 165) %>% 
  footnote(general_title = "",
    general = c("Gen: general; Reg: regional; Sed: sedation; Hosp: hospital; Amb: ambulatory; GI: gastrointestinal; Ortho: orthopedic; Abdom: abdominal; ENT: otolaryngology (ear, nose, and throat); Gyn: gynecologic; Urol: urologic; Neuro: neurological; Hep: hepatic; Thor: thoracic; Oralmax: oral maxillofacial"),
    alphabet = c("Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."),
    footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

###   <u>All Age Studies</u>

<br>

<font size = 4> Table `r table_n`. Characteristics of studies including patients of any age. </font>

```{r studyCharKableAllAges, echo = FALSE}
## studyCharKableAllAges ------------------------------ (2022-04-03 15:54) @----
temp <- study_char_table %>%
  arrange(age, design, study) %>% 
  filter(age == "All ages") %>% 
  select(study, refid, age, design) %>% 
  group_by(age, design) %>% 
  tally() %>% 
  ungroup() %>% 
  mutate(end = cumsum(n),
         start = end - n + 1) %>% 
  select(age, design, start, end)

study_char_table %>%
  filter(age == "All ages") %>% 
  select(!c(refid, age, design)) %>% 
  kbl(booktabs = T, align = c("llllcccclc"), 
      # format = "latex",
      col.names = c("          Study", "Dates", "Country", " N ", "Pilot", 
                    "Setting", "Gen", "Reg", "Type of Surgery", "Registered")) %>%
  add_header_above(c(" " = 6, "Anesthesia" = 2, " " = 2), bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>% 
  column_spec(2, width = "8em") %>% 
  column_spec(3, width = "5em") %>% 
  column_spec(4, width = "4em") %>% 
  column_spec(5, width = "4em") %>% 
  column_spec(6, width = "5em") %>% 
  column_spec(7, width = "3em") %>% 
  column_spec(8, width = "3em") %>% 
  column_spec(9, width = "15em") %>% 
  column_spec(10, width = "5em") %>% 
  pack_topnoind(., "RCT", 1, 4) %>% 
  pack_topnoind(., "Retrospective Cohort", 5, 7) %>% 
  footnote(general_title = "",
    general = "Gen: general; Reg: regional; Sed: sedation; Hosp: hospital; Ortho: orthopedic; ENT: otolaryngology (ear, nose, and throat).",
    alphabet = c("Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."),
    footnote_as_chunk = FALSE) # %>% 

table_n <- tab_inc()
```

<br/>

###   <u>Pediatric Studies</u>

<br>

<font size = 4> Table `r table_n`. Characteristics of studies including only pediatric patients. </font>

```{r studyCharKableAllPeds, echo = FALSE}
## studyCharKableAllPeds ------------------------------ (2022-04-03 15:54) @----
temp <- study_char_table %>%
  arrange(age, design, study) %>% 
  filter(age == "Pediatric") %>% 
  select(study, refid, age, design) %>% 
  group_by(age, design) %>% 
  tally() %>% 
  ungroup() %>% 
  mutate(end = cumsum(n),
         start = end - n + 1) %>% 
  select(age, design, start, end)

study_char_table %>%
  filter(age == "Pediatric") %>% 
  select(!c(refid, age, design)) %>% 
  kbl(booktabs = T, align = c("llllcccclc"), 
      # format = "latex",
      col.names = c("Study", "Dates", "Country", " N ", "Pilot", 
                    "Setting", "Gen", "Reg", "Type of Surgery", "Registered")) %>%
  add_header_above(c(" " = 6, "Anesthesia" = 2, " " = 2), bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>% 
  column_spec(2, width = "8em") %>% 
  column_spec(3, width = "5em") %>% 
  column_spec(4, width = "4em") %>% 
  column_spec(5, width = "4em") %>% 
  column_spec(6, width = "5em") %>% 
  column_spec(7, width = "3em") %>% 
  column_spec(8, width = "3em") %>% 
  column_spec(9, width = "15em") %>% 
  column_spec(10, width = "5em") %>% 
  # column_spec(2, width = "2em") %>% 
  pack_topnoind(., "RCT", 1, 12) %>% 
  pack_topnoind(., "Prospective Cohort", 13, 15) %>% 
  pack_topnoind(., "Retrospective Cohort", 16, 16) %>% 
  footnote(general_title = "",
    general = c("Gen: general; Reg: regional; Sed: sedation; Hosp: hospital; Amb: ambulatory; Card: cardiac; GI: gastrointestinal; Ortho: orthopedic; Abdom: abdominal; ENT: otolaryngology (ear, nose, and throat); Urol: urologic; Oralmax: oral maxillofacial"),
    alphabet = c("Non very high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."),
    footnote_as_chunk = FALSE)

table_n <- tab_inc()
```

<br/>

### *Patient Characteristics*

###   <u>Adult Studies</u>

<br>

<font size = 4> Table `r table_n`. Patient characteristics in studies including only adults. </font>

```{r ptCharTableData, include = FALSE}
## ptCharTableData ------------------------------------ (2022-04-03 15:55) @----
pt_char_table <- study_arm.dat %>%
  filter(refid %in% rev_refids) %>%
  group_by(refid) %>%
  summarize(
    N = sum(arm_n),
    wgt = arm_n / N,
    asa_1_all = round(sum(asa_1 * wgt, na.rm = FALSE)),
    asa_2_all = round(sum(asa_2 * wgt, na.rm = FALSE)),
    asa_3_all = round(sum(asa_3 * wgt, na.rm = FALSE)),
    asa_12_all = round(sum(asa_12 * wgt, na.rm = FALSE)),
    asa_123_all = round(sum(asa_123 * wgt, na.rm = FALSE)),
    asa_23_all = round(sum(asa_23 * wgt, na.rm = FALSE)),
    asa_34_all = round(sum(asa_34 * wgt, na.rm = FALSE)),
    age_mn_all = round(sum(age_mean * wgt, na.rm = FALSE)),
    age_md_all = round(sum(age_med * wgt, na.rm = FALSE)),
    sex_all = round(sum(female * wgt, na.rm = FALSE)),
    white_all = round(sum(white * wgt, na.rm = FALSE)),
    black_all = round(sum(black * wgt, na.rm = FALSE)),
    asian_all = round(sum(asian * wgt, na.rm = FALSE)),
    bmi_mn_all = round(sum(bmi_mean * wgt, na.rm = FALSE)),
    bmi_md_all = round(sum(bmi_med * wgt, na.rm = FALSE)),
    cardiac_all = round(sum(cardiac * wgt, na.rm = FALSE)),
    cancer_all = round(sum(cancer * wgt, na.rm = FALSE)),
    renal_all = round(sum(renal * wgt, na.rm = FALSE)),
    gi_all = round(sum(gi * wgt, na.rm = FALSE)),
    pulm_all = round(sum(pulm * wgt, na.rm = FALSE)),
    hepatic = round(sum(hepatic * wgt, na.rm = FALSE)),
    dm_all = round(sum(dm * wgt, na.rm = FALSE)),
    neuro_all = round(sum(neuro * wgt, na.rm = FALSE))
  ) %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  remove_empty(which = "cols") %>%
  # categorize asa class
  mutate(
    asa_1 = ifelse(if_any(c(asa_1_all, asa_12_all, asa_123_all), ~ !is.na(.)), "\U00D7", NA),
    asa_2 = ifelse(if_any(c(asa_12_all, asa_2_all, asa_123_all, asa_23_all), ~ !is.na(.)), "\U00D7", NA),
    asa_3 = ifelse(if_any(c(asa_123_all, asa_3_all, asa_23_all, asa_34_all), ~ !is.na(.)), "\U00D7", NA),
    asa_4 = ifelse(if_any(c(asa_34_all), ~ !is.na(.)), "\U00D7", NA)
  ) %>%
  relocate(c(asa_1, asa_2, asa_3, asa_4), .after = asa_34_all) %>%
  mutate(across(c(cardiac_all:neuro_all), ~ bar_wn(.x, .x, color_1, 100)),
    across(c(white_all:asian_all), ~ bar_wn(.x, .x, color_2, 100)),
    sex_all = bar_wn(sex_all, sex_all, color_3, 100),
    age_sum = ifelse(is.na(age_mn_all) & !is.na(age_md_all), paste0("<u>", age_md_all, "</u>"), age_mn_all),
    bmi = ifelse(is.na(bmi_mn_all) & !is.na(bmi_md_all), paste0("<u>", bmi_md_all, "</u>"), bmi_mn_all)
  ) %>%
  relocate(bmi, .before = bmi_mn_all) %>%
  relocate(age_sum, .before = age_mn_all) %>%
  select(-c(asa_1_all:asa_34_all, wgt, bmi_mn_all, bmi_md_all, age_mn_all, age_md_all))

pt_char_table <- left_join(pt_char_table, study_char.dat[, c("refid", "age", "design", "study", "year")], by = "refid") %>% 
  relocate(c(age, design, study, year), .after = "refid") %>% 
  arrange(design, year)

```

```{r ptCharTableAdult}
## ptCharTableData (updated 2022/01/15 10:08)  ----------------------------
temp <- pt_char_table %>%
  arrange(age, design, study) %>% 
  filter(age == "Adult") %>% 
  select(study, refid, age, design) %>% 
  group_by(age, design) %>% 
  tally() %>% 
  ungroup() %>% 
  mutate(end = cumsum(n),
         start = end - n + 1) %>% 
  select(age, design, start, end)

pt_char_table %>% 
  filter(age == "Adult") %>% 
  select(-c(refid, year, age, design)) %>% 
  select(study:bmi, cardiac_all, renal_all, pulm_all, hepatic, dm_all, neuro_all) %>% 
    kbl(booktabs = T, align = c("llcccccllllcllllll"), escape = FALSE,
      col.names = c("Study", " N ", "1", "2", "3", "4", "M <u>Med</u>", "(%)", "W", "B", "A", "M <u>Med</u>", "Card", "Renal", "Pulm", "Hep", "DM", "Neur")) %>% 
  add_header_above(c(" " = 2, "ASA Class" = 4, "Age" = 1, "Female", "Race" = 3, "BMI" = 1, "Comorbidities (%)^a^" = 6), bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>% 
  column_spec(2, width = "3em") %>% 
  column_spec(3:6, width = "2em", popover = "ASA class (1 to 4)") %>% 
  column_spec(7, width = "4em", popover = "Age") %>% 
  column_spec(8, width = "4em", popover = "Female %") %>% 
  column_spec(9, width = "3em", popover = "White %") %>%
  column_spec(10, width = "3em", popover = "Black %") %>%
  column_spec(11, width = "3em", popover = "Asian %") %>%
  column_spec(12, width = "4em", popover = "BMI") %>% 
  column_spec(13, width = "3em", popover = "Cardiac %") %>%
  column_spec(14, width = "3em", popover = "Renal %") %>% 
  column_spec(15, width = "3em", popover = "Pulmonary %") %>% 
  column_spec(16, width = "3em", popover = "Hepatic %") %>% 
  column_spec(17, width = "3em", popover = "Diabetes %") %>% 
  column_spec(18, width = "3em", popover = "Nuerological %") %>% 
  pack_topnoind(., "RCT",                        1, 121) %>%
  pack_topnoind(., "Before-After/Time Series", 122, 123) %>%
  pack_topnoind(., "Nonrandomized Trial",      124, 134) %>%
  pack_topnoind(., "Prospective Cohort",       135, 156) %>%
  pack_topnoind(., "Retrospective Cohort",     157, 165) %>%
  footnote(general_title = "",
    general = c("M: mean; Med: median; Card: cardiac; Pulm: pulmonary; Hep: hepatic; DM: diabetes mellitus; Neuro: neurological: RCT: randomized controlled trial."),
    alphabet = c("Empty cells indicate no information in publication."),
    footnote_as_chunk = FALSE)  

table_n <- tab_inc()
```

<br/>

###   <u>All Age Studies</u>

<br>

<font size = 4> Table `r table_n`. Patient characteristics in studies including patients of any age. </font>

```{r ptCharTableAllAge}
#⨯# ptCharTableAllAge --------------------------------- (2022-04-03 15:57) @----
temp <- pt_char_table %>%
  arrange(age, design, study) %>% 
  filter(age == "All ages") %>% 
  select(study, refid, age, design) %>% 
  group_by(age, design) %>% 
  tally() %>% 
  ungroup() %>% 
  mutate(end = cumsum(n),
         start = end - n + 1) %>% 
  select(age, design, start, end)

pt_char_table %>% 
  filter(age == "All ages") %>% 
  select(-c(refid, year, age, design)) %>% 
  select(study:bmi, cardiac_all, renal_all, pulm_all, hepatic, dm_all, neuro_all) %>% 
    kbl(booktabs = T, align = c("llcccccllllcllllll"), escape = FALSE,
      col.names = c("Study", " N ", "1", "2", "3", "4", "M <u>Med</u>", "(%)", "W", "B", "A", "M <u>Med</u>", "Card", "Renal", "Pulm", "Hep", "DM", "Neur")) %>% 
  add_header_above(c(" " = 2, "ASA Class" = 4, "Age" = 1, "Female", "Race (%)" = 3, "BMI" = 1, "Comorbidities (%)^a^" = 6), bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1,   width = study_width) %>% 
  column_spec(2,   width = "3em") %>% 
  column_spec(3:6, width = "2em") %>% 
  column_spec(7,   width = "4em") %>% 
  column_spec(8,   width = "4em") %>% 
  column_spec(9,   width = "3em") %>% 
  column_spec(10,  width = "3em") %>% 
  column_spec(11,  width = "3em") %>% 
  column_spec(12,  width = "4em") %>% 
  column_spec(13,  width = "3em") %>% 
  column_spec(14,  width = "3em") %>% 
  column_spec(15,  width = "3em") %>% 
  column_spec(16,  width = "3em") %>% 
  column_spec(17,  width = "3em") %>% 
  column_spec(18,  width = "3em") %>% 
  pack_topnoind(., "RCT", 1, 4) %>% 
  pack_topnoind(., "Retrospective Cohort", 5, 7) %>% 
  footnote(general_title = "",
    general = c("M: mean; Med: median; Card: cardiac; Pulm: pulmonary; Hep: hepatic; DM: diabetes mellitus; Neuro: neurological: RCT: randomized controlled trial."),
    alphabet = c("Empty cells indicate no information in publication."),
    footnote_as_chunk = FALSE)  

table_n <- tab_inc()
```

<br/>

###   <u>Pediatric Studies</u>

<br>

<font size = 4> Table `r table_n`. Patient characteristics in studies including only pediatric patients. </font>

```{r ptCharTableAllPediatric}
## ptCharTableAllPediatric ---------------------------- (2022-04-03 15:57) @----
temp <- pt_char_table %>%
  arrange(age, design, study) %>% 
  filter(age == "Pediatric") %>% 
  select(study, refid, age, design) %>% 
  group_by(age, design) %>% 
  tally() %>% 
  ungroup() %>% 
  mutate(end = cumsum(n),
         start = end - n + 1) %>% 
  select(age, design, start, end)

pt_char_table %>%
  filter(age == "Pediatric") %>%
  select(-c(refid, year, age, design)) %>%
  select(study:bmi, cardiac_all, renal_all, pulm_all, hepatic, dm_all, neuro_all) %>%
  kbl(
    booktabs = T, align = c("llcccccllllcllllll"), escape = FALSE,
    col.names = c("Study", " N ", "1", "2", "3", "4", "M <u>Med</u>", "(%)", "W", "B", "A", "M <u>Med</u>", "Card", "Renal", "Pulm", "Hep", "DM", "Neur")
  ) %>%
  add_header_above(c(" " = 2, "ASA Class" = 4, "Age" = 1, "Female", "Race (%)" = 3, "BMI" = 1, "Comorbidities (%)^a^" = 6), bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = study_width) %>%
  column_spec(2, width = "3em") %>%
  column_spec(3:6, width = "2em") %>%
  column_spec(7, width = "4em") %>%
  column_spec(8, width = "4em") %>%
  column_spec(9, width = "3em") %>%
  column_spec(10, width = "3em") %>%
  column_spec(11, width = "3em") %>%
  column_spec(12, width = "4em") %>%
  column_spec(13, width = "3em") %>%
  column_spec(14, width = "3em") %>%
  column_spec(15, width = "3em") %>%
  column_spec(16, width = "3em") %>%
  column_spec(17, width = "3em") %>%
  column_spec(18, width = "3em") %>%
  pack_topnoind(., "RCT", 1, 12) %>%
  pack_topnoind(., "Prospective Cohort", 13, 15) %>%
  pack_topnoind(., "Retrospective Cohort", 16, 16) %>%
  footnote(
    general_title = "",
    general = c("M: mean; Med: median; Card: cardiac; Pulm: pulmonary; Hep: hepatic; DM: diabetes mellitus; Neuro: neurological: RCT: randomized controlled trial."),
    alphabet = c("Empty cells indicate no information in publication."),
    footnote_as_chunk = FALSE
  )  

table_n <- tab_inc()
```

<br/>

# **Funding and Conflict of Interest**

<br/>

###   <u>Adult Studies</u>

<br>

<font size = 4> Table `r table_n`. Funding^a^ and reported conflict of interest in studies including only adults. </font>

```{r createFundingTable, include = FALSE}
## createFundingTable --------------------------------------- (2022-04-03 15:58) @----
study_fund_table <- study_char.dat %>%
  filter(refid %in% rev_refids) %>% 
  mutate(
    sponsor_desc = str_replace(sponsor_desc, "MSD", "Merck Sharp & Dohme Corp"),
    sponsor_desc = str_replace(sponsor_desc, "Merck & Co", "MSD"),
    sponsor_desc = str_replace(sponsor_desc, "Merck Sharp & Dohme Corp", "MSD"),
    sponsor_desc = str_replace(sponsor_desc, "Merck", "MSD"),
    sponsor_desc = firstup(sponsor_desc),
    # sponsor_desc = str_replace(sponsor_desc, "MSD", "Merck Sharp & Dohme"),
    auth_coi_desc = str_replace_all(auth_coi_desc, "MSD", "Merck Sharp & Dohme Corp"),
    auth_coi_desc = str_replace_all(auth_coi_desc, "Merck & Co", "Merck Sharp & Dohme Corp"),
    auth_coi_desc = str_replace_all(auth_coi_desc, "Merck Sharp & Dohme Corp", "MSD"),
    auth_coi_desc = str_replace_all(auth_coi_desc, "Merck", "MSD"),
    # auth_coi_desc = str_replace_all(auth_coi_desc, "MSD", "Merck Sharp & Dohme"),
    # sponsor_desc = str_to_title(sponsor_desc),
    auth_not_report = noquote(if_else(author_coi == "not_auth_rep", "\U00D7", "", "")),
    # auth_not_report = if_else(author_coi == "not_auth_rep", "&times", "", ""),
    auth_no_coi = noquote(if_else(author_coi == "none_auth_coi", "\U00D7", "", "")),
    auth_coi = noquote(if_else(author_coi == "author_coi", '<span style="color:red">\U00D7</span>', "", "")),
    registered = noquote(if_else(registered == "yes", "\U00D7", "", "")),
    public = noquote(if_else(funding == "public", "\U00D7", "", "")),
    pub_indus = noquote(if_else(funding == "pub_indus", '<span style="color:red">\U00D7</span>', "", "")),
    industry = noquote(if_else(funding == "industry", '<span style="color:red">\U00D7</span>', "", "")),
    none = noquote(if_else(funding == "none", "\U00D7", "", "")),
    not_reported = noquote(if_else(funding == "NR", "\U00D7", "", ""))) %>%
  arrange(age, design, year, study) %>%
  select(refid, study, age, design, public, pub_indus, industry, none, not_reported, sponsor_desc, auth_no_coi, auth_coi, auth_not_report, auth_coi_desc)

```

```{r fundingKable, echo = FALSE}
## fundingKable --------------------------------------- (2022-04-03 15:58) @----
study_fund_table %>% 
  filter(age == "Adult") %>% 
  select(!c(refid, age, design)) %>% 
  kbl(booktabs = T, align = c("lccccclcccl"),
      col.names = c("Study", "Pub", '<span style="color:red">Pub/Ind</span>', '<span style="color:red">Ind</span>',  "None", "NR^a^", "Description", "No", '<span style="color:red">Yes</span>', "NR^a^", "Description"),
      escape = FALSE) %>%
  add_header_above(c(" " = 1, "Funding Source(s)" = 6, "Author Conflict of Interest" = 4), line = TRUE, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "12em") %>% 
  column_spec(2:6, width = "4em") %>% 
  column_spec(7, width = "20em") %>% 
  column_spec(8:10, width = "4em") %>% 
  column_spec(11, width = "20em") %>% 
  pack_topnoind(., "RCT",                        1, 121) %>%
  pack_topnoind(., "Before-After/Time Series", 122, 123) %>%
  pack_topnoind(., "Nonrandomized Trial",      124, 134) %>%
  pack_topnoind(., "Prospective Cohort",       135, 156) %>%
  pack_topnoind(., "Retrospective Cohort",     157, 165) %>%
  footnote(general = "Pub: public, Ind: industry; NR: not reported; MSD: Merck, Sharp, and Dohme (funded 23 (22%) of RCTs and 26 (19%) of studies listed).",
          alphabet = c("Not reported meaning no mention in publication of funding source or author conflicts of interest."))
          # general_title = " ",
          # alphabet_title = " ",
          # footnote_as_chunk = T)

table_n <- tab_inc()

# merck studies
# study_fund_table %>% 
#   # filter(age == "Adult", design == "rct") %>% 
#   filter(age == "Adult") %>% 
#   mutate(
#     msd_fund = grepl("MSD|Merck", sponsor_desc)
#   ) %>% 
#   tabyl(msd_fund)
```

<br/>

###   <u>All Ages Studies</u>

<br>

<font size = 4> Table `r table_n`. Funding^a^ and reported conflict of interest in studies including patients of any age. </font>

```{r fundingKableAllAges, echo = FALSE}
## fundingKableAllAges -------------------------------- (2022-04-03 16:01) @----
study_fund_table %>% 
  filter(age == "All ages") %>% 
  select(!c(refid, age, design)) %>% 
  kbl(booktabs = T, align = c("lccccclcccl"),
      col.names = c("Study", "Pub", '<span style="color:red">Ind</span>',  '<span style="color:red">Pub/Ind</span>', "None", "NR^a^", "Description", "No", '<span style="color:red">Yes</span>', "NR^a^", "Description"),
      escape = FALSE) %>%
  add_header_above(c(" " = 1, "Funding Source(s)" = 6, "Author Conflict of Interest" = 4), line = TRUE, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "12em") %>% 
  column_spec(2:6, width = "4em") %>% 
  column_spec(7, width = "20em") %>% 
  column_spec(8:10, width = "4em") %>% 
  column_spec(11, width = "20em") %>% 
  pack_topnoind(., "RCT", 1, 4) %>% 
  pack_topnoind(., "Retrospective Cohort", 5, 7) %>% 
  footnote(general = "Pub: public, Ind: industry; NR: not reported; MSD: Merck, Sharp, and Dohme.",
          alphabet = c("Not reported meaning no mention in publication of funding source or author conflicts of interest."))
          # general_title = " ",
          # alphabet_title = " ",
          # footnote_as_chunk = T)

table_n <- tab_inc()

```

<br/>

###   <u>Pediatric Studies</u>

<br>

<font size = 4> Table `r table_n`. Funding^a^ and reported conflict of interest in studies including only pediatric patients. </font>

<br/>

```{r fundingKablePediatric, echo = FALSE}
## fundingKablePediatric ------------------------------ (2022-04-03 16:02) @----
study_fund_table %>% 
  filter(age == "Pediatric") %>% 
  select(!c(refid, age, design)) %>% 
  kbl(booktabs = T, align = c("lccccclcccl"),
      col.names = c("Study", "Pub", '<span style="color:red">Ind</span>',  '<span style="color:red">Pub/Ind</span>', "None", "NR^a^", "Description", "No", '<span style="color:red">Yes</span>', "NR^a^", "Description"),
      escape = FALSE) %>%
  add_header_above(c(" " = 1, "Funding Source(s)" = 6, "Author Conflict of Interest" = 4), line = TRUE, bold = TRUE) %>% 
  row_spec(0, bold = TRUE) %>% 
  kable_styling(full_width = FALSE, bootstrap_options = opt_boot, position = "left") %>%
  kable_classic(full_width = FALSE, html_font = opt_font, position = "left", "hover") %>%
  column_spec(1, width = "12em") %>% 
  column_spec(2:6, width = "4em") %>% 
  column_spec(7, width = "20em") %>% 
  column_spec(8:10, width = "4em") %>% 
  column_spec(11, width = "20em") %>% 
  pack_topnoind(., "RCT", 1, 12) %>% 
  pack_topnoind(., "Prospective Cohort", 13, 15) %>% 
  pack_topnoind(., "Retrospective Cohort", 16, 16) %>% 
  footnote(general = "Pub: public, Ind: industry; NR: not reported; MSD: Merck, Sharp, and Dohme.",
          alphabet = c("Not reported meaning no mention in publication of funding source or author conflicts of interest."))
          # general_title = " ",
          # alphabet_title = " ",
          # footnote_as_chunk = T)

table_n <- tab_inc()

```

# **Risk of Bias**

<br/>

### *RCTs Clinical Outcomes*

<br>

<font size = 4> Figure `r figure_n`. Summary risk of bias appraisal for included RCTs reporting RNMB. </font>

<img src="assets/reversal_rnmb_rob_clin_out.svg" style="width:750px;" align="left"/>

<br clear="all" />

```{r}
figure_n <- fig_inc()
```

<br/>

<font size = 4> Figure `r figure_n`. Individual study risk of bias appraisal for reporting RNMB. </font>

<img src="assets/reversal_rnmb_clin_out_traffic.svg" style="width:650px;" align="left"/>

```{r}
figure_n <- fig_inc()
```

<br clear="all" />

<br clear="all" />

### *Nonrandomized Studies of Interventions*

<br>

<font size = 4> Figure `r figure_n`. Summary risk of bias appraisal for included nonrandomized studies [ROBINS-I](https://www.bmj.com/content/355/bmj.i4919). </font>

<img src="assets/reversal_robins_summary.svg" style="width:750px;" align="left"/>

<br clear="all" />

```{r}
figure_n <- fig_inc()
```

<br/>

<font size = 4> Figure `r figure_n`. Individual study risk of bias appraisal for nonrandomized studies. </font>

<img src="assets/reversal_robins_traffic.svg" style="width:650px;" align="left"/>

```{r}
figure_n <- fig_inc()
```

<br clear="all" />

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<br>

# **References**

<br/>

<a id="references"></a>
